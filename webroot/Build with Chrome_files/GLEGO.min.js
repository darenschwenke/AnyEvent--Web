var GLEGO=function(){var a={};a.log=new signals.Signal;a.warning=new signals.Signal;a.error=new signals.Signal;GLOW.addEventListener(GLOW.LOGS,function(b){a.log.dispatch(b)});GLOW.addEventListener(GLOW.WARNINGS,function(b){a.warning.dispatch(b)});GLOW.addEventListener(GLOW.ERRORS,function(b){a.error.dispatch(b)});return a}();GLEGO.Ambient=function(a){this.color=a||new GLOW.Color(1118481)};GLEGO.Ambient.prototype.setColorRBG=function(a,b,c){this.color.setRGB(a,b,c)};GLEGO.Ambient.prototype.setColorHex=function(a){this.color.setHex(a)};GLEGO.Ambient.prototype.setColorHSV=function(a,b,c){this.color.setHSV(a,b,c)};GLEGO.Camera=function(a){this.fov=void 0!==a.fov?a.fov:40;this.aspect=void 0!==a.aspect?a.aspect:window.innerWidth/window.innerHeight;this.near=void 0!==a.near?a.near:0.1;this.far=void 0!==a.far?a.far:1E4;this.useTarget=void 0!==a.useTarget?a.useTarget:!0;this.matrix=new GLOW.Matrix4;this.inverse=new GLOW.Matrix4;void 0!==a.ortho?(this.projection=GLOW.Matrix4.makeOrtho(a.ortho.left,a.ortho.right,a.ortho.top,a.ortho.bottom,this.near,this.far),this.isPerspective=!1):(this.projection=GLOW.Matrix4.makeProjection(this.fov,
this.aspect,this.near,this.far),this.isPerspective=!0);this.target=new GLOW.Vector3(0,0,-100);this.up=new GLOW.Vector3(0,1,0);if(this.useXYZStyleTransform=void 0!==a.useXYZStyleTransform?a.useXYZStyleTransform:!0)this.position=new GLOW.Vector3,this.rotation=new GLOW.Vector3;this.update()};GLEGO.Camera.prototype.resize=function(a,b){this.isPerspective&&(this.aspect=a/b,this.projection=GLOW.Matrix4.makeProjection(this.fov,this.aspect,this.near,this.far,this.projection))};
GLEGO.Camera.prototype.update=function(){this.useXYZStyleTransform?(this.matrix.setPosition(this.position.value[0],this.position.value[1],this.position.value[2]),this.useTarget?this.matrix.lookAt(this.target,this.up):this.matrix.setRotation(this.rotation.value[0],this.rotation.value[1],this.rotation.value[2])):this.useTarget&&this.matrix.lookAt(this.target,this.up);GLOW.Matrix4.makeInverse(this.matrix,this.inverse)};GLEGO.DataFactory=function(){function a(){window.LDF=this;this.LU=new GLOW.Vector3(8,9.6,8);this.LUF=new GLOW.Vector3(8,3.2,8);this.LU.x=this.LU.w=this.LU.value[0];this.LU.y=this.LU.h=this.LU.value[1];this.LU.z=this.LU.d=this.LU.value[2];this.LUF.x=this.LUF.w=this.LUF.value[0];this.LUF.y=this.LUF.h=this.LUF.value[1];this.LUF.z=this.LUF.d=this.LUF.value[2];this.buildBasePlateHalfSizeLU=16;new GLOW.Color(3303656);new GLOW.Color(16770048);new GLOW.Color(3815994);new GLOW.Color(16777215);this.colors=
{white:c(0,new GLOW.Color(250,250,250)),gray:c(1,new GLOW.Color(176,181,178)),black:c(2,new GLOW.Color(27,42,52)),orange:c(3,new GLOW.Color(246,128,19)),red:c(4,new GLOW.Color(200,0,0)),blue:c(5,new GLOW.Color(30,90,168)),green:c(6,new GLOW.Color(165,202,24)),darkgreen:c(7,new GLOW.Color(0,133,43)),yellow:c(8,new GLOW.Color(250,220,10)),brown:c(9,new GLOW.Color(81,57,22)),secret:c(10,new GLOW.Color(255,41,172)),whiteEdge:c(16,(new GLOW.Color(250,250,250)).multiplyScalar(0.95)),grayEdge:c(17,(new GLOW.Color(176,
181,178)).multiplyScalar(0.95)),blackEdge:c(18,(new GLOW.Color(27,42,52)).multiplyScalar(0.95)),orangeEdge:c(19,(new GLOW.Color(246,128,19)).multiplyScalar(0.95)),redEdge:c(20,(new GLOW.Color(200,0,0)).multiplyScalar(0.95)),blueEdge:c(21,(new GLOW.Color(30,90,168)).multiplyScalar(0.95)),greenEdge:c(22,(new GLOW.Color(165,202,24)).multiplyScalar(0.95)),darkGreenEdge:c(23,(new GLOW.Color(0,133,43)).multiplyScalar(0.95)),yellowEdge:c(24,(new GLOW.Color(250,220,10)).multiplyScalar(0.95)),brownEdge:c(25,
(new GLOW.Color(81,57,22)).multiplyScalar(0.95)),secretEdge:c(26,(new GLOW.Color(255,41,172)).multiplyScalar(0.95)),groundYellowA:c(30,new GLOW.Color(16380046)),groundGreenA:c(31,new GLOW.Color(14542549)),groundBlueA:c(32,new GLOW.Color(13228261)),groundBlueB:c(33,new GLOW.Color(12110819)),groundBlueC:c(34,new GLOW.Color(10928348)),groundWhite:c(35,new GLOW.Color(16777215)),groundGreyA:c(36,new GLOW.Color(16053233)),groundGreenB:c(37,new GLOW.Color(13295281)),groundGreyB:c(38,new GLOW.Color(15789541)),
groundBrown:c(39,new GLOW.Color(14668217)),groundGreenC:c(40,new GLOW.Color(7248966)),groundYellowB:c(41,new GLOW.Color(16630599)),groundOutline:c(42,new GLOW.Color(13421772)),pink:c(43,new GLOW.Color(235,210,207)),lightgreyblue:c(50,new GLOW.Color(4627395)),lightyellow:c(51,new GLOW.Color(16772203)),lightpink:c(52,new GLOW.Color(16757206)),darkpink:c(53,new GLOW.Color(14504364)),purple:c(54,new GLOW.Color(4463249)),graybeige:c(55,new GLOW.Color(15128228)),darkbeige:c(56,new GLOW.Color(8944993)),
darkgrey:c(57,new GLOW.Color(6579300)),greyblue:c(58,new GLOW.Color(7373210)),darkorange:c(59,new GLOW.Color(15483933)),darkred:c(60,new GLOW.Color(7405586)),beige:c(61,new GLOW.Color(12227658)),whitetransparent:c(63,new GLOW.Color(157,195,247)),bonewhite:c(62,new GLOW.Color(15202217)),lightgreyblueEdge:c(66,(new GLOW.Color(4627395)).multiplyScalar(0.95)),lightyellowEdge:c(67,(new GLOW.Color(16772203)).multiplyScalar(0.95)),lightpinkEdge:c(68,(new GLOW.Color(16757206)).multiplyScalar(0.95)),darkpinkEdge:c(69,
(new GLOW.Color(14504364)).multiplyScalar(0.95)),purpleEdge:c(70,(new GLOW.Color(4463249)).multiplyScalar(0.95)),graybeigeEdge:c(71,(new GLOW.Color(15128228)).multiplyScalar(0.95)),darkbeigeEdge:c(72,(new GLOW.Color(8944993)).multiplyScalar(0.95)),darkgreyEdge:c(73,(new GLOW.Color(6579300)).multiplyScalar(0.95)),greyblueEdge:c(74,(new GLOW.Color(7373210)).multiplyScalar(0.95)),darkorangeEdge:c(75,(new GLOW.Color(15483933)).multiplyScalar(0.95)),darkredEdge:c(76,(new GLOW.Color(7405586)).multiplyScalar(0.95)),
beigeEdge:c(77,(new GLOW.Color(12227658)).multiplyScalar(0.95)),bonewhiteEdge:c(78,(new GLOW.Color(15202217)).multiplyScalar(0.95)),whitetransparentEdge:c(79,(new GLOW.Color(157,195,247)).multiplyScalar(0.95))};e(this.colors);var a=0,a=this.brickTypes={brick_1_1_h:{index:a++,size:b(1,3,1)},brick_1_1_l:{index:a++,size:b(1,1,1)},brick_1_2_h:{index:a++,size:b(1,3,2)},brick_1_4_h:{index:a++,size:b(1,3,4)},brick_1_4_l:{index:a++,size:b(1,1,4)},brick_2_2_h:{index:a++,size:b(2,3,2)},brick_2_2_l:{index:a++,
size:b(2,1,2)},brick_2_4_h:{index:a++,size:b(2,3,4)},brick_2_4_l:{index:a++,size:b(2,1,4)},brick_2_8_h:{index:a++,size:b(2,3,8)},brick_1_2_s_r0:{index:a++,special:!0,size:b(1,3,2)},brick_2_3_s_r0:{index:a++,special:!0,size:b(2,3,3)},brick_door_r0:{index:a++,special:!0,multipleColors:!0,size:b(2,15,4)},brick_window_r0:{index:a++,special:!0,multipleColors:!0,size:b(2,9,4)},brick_32_32_h:{index:a++,size:b(32,1,32)},checkplane:{index:a++,rotationOf:"brick_1_1_l",radians:0,size:b(1,1,1)},brick_2_1_h:{index:a++,
rotationOf:"brick_1_2_h",radians:1*Math.PI/2,size:b(2,3,1)},brick_4_1_h:{index:a++,rotationOf:"brick_1_4_h",radians:1*Math.PI/2,size:b(4,3,1)},brick_4_1_l:{index:a++,rotationOf:"brick_1_4_l",radians:1*Math.PI/2,size:b(4,1,1)},brick_4_2_h:{index:a++,rotationOf:"brick_2_4_h",radians:1*Math.PI/2,size:b(4,3,2)},brick_4_2_l:{index:a++,rotationOf:"brick_2_4_l",radians:1*Math.PI/2,size:b(4,1,2)},brick_8_2_h:{index:a++,rotationOf:"brick_2_8_h",radians:1*Math.PI/2,size:b(8,3,2)},brick_2_1_s_r1:{index:a++,
special:!0,rotationOf:"brick_1_2_s_r0",radians:1*Math.PI/2,size:b(2,3,1)},brick_1_2_s_r2:{index:a++,special:!0,rotationOf:"brick_1_2_s_r0",radians:2*Math.PI/2,size:b(1,3,2)},brick_2_1_s_r3:{index:a++,special:!0,rotationOf:"brick_1_2_s_r0",radians:3*Math.PI/2,size:b(2,3,1)},brick_3_2_s_r1:{index:a++,special:!0,rotationOf:"brick_2_3_s_r0",radians:1*Math.PI/2,size:b(3,3,2)},brick_2_3_s_r2:{index:a++,special:!0,rotationOf:"brick_2_3_s_r0",radians:2*Math.PI/2,size:b(2,3,3)},brick_3_2_s_r3:{index:a++,special:!0,
rotationOf:"brick_2_3_s_r0",radians:3*Math.PI/2,size:b(3,3,2)},brick_door_r1:{index:a++,special:!0,multipleColors:!0,rotationOf:"brick_door_r0",radians:1*Math.PI/2,size:b(4,15,2)},brick_door_r2:{index:a++,special:!0,multipleColors:!0,rotationOf:"brick_door_r0",radians:2*Math.PI/2,size:b(2,15,4)},brick_door_r3:{index:a++,special:!0,multipleColors:!0,rotationOf:"brick_door_r0",radians:3*Math.PI/2,size:b(4,15,2)},brick_window_r1:{index:a++,special:!0,multipleColors:!0,rotationOf:"brick_window_r0",radians:1*
Math.PI/2,size:b(4,9,2)},brick_window_r2:{index:a++,special:!0,multipleColors:!0,rotationOf:"brick_window_r0",radians:2*Math.PI/2,size:b(2,9,4)},brick_window_r3:{index:a++,special:!0,multipleColors:!0,rotationOf:"brick_window_r0",radians:3*Math.PI/2,size:b(4,9,2)},brick_1_1_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_1_h",radians:0*Math.PI/2,size:b(1,3,1)},brick_1_1_l_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_1_l",radians:0*Math.PI/
2,size:b(1,1,1)},brick_1_2_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_2_h",radians:0*Math.PI/2,size:b(1,3,2)},brick_1_4_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_4_h",radians:0*Math.PI/2,size:b(1,3,4)},brick_1_4_l_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_4_l",radians:0*Math.PI/2,size:b(1,1,4)},brick_2_2_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_2_h",radians:0*
Math.PI/2,size:b(2,3,2)},brick_2_2_l_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_2_l",radians:0*Math.PI/2,size:b(2,1,2)},brick_2_4_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_4_h",radians:0*Math.PI/2,size:b(2,3,4)},brick_2_4_l_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_4_l",radians:0*Math.PI/2,size:b(2,1,4)},brick_2_8_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_8_h",
radians:0*Math.PI/2,size:b(2,3,8)},brick_2_1_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_2_h",radians:1*Math.PI/2,size:b(2,3,1)},brick_4_1_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_4_h",radians:1*Math.PI/2,size:b(4,3,1)},brick_4_1_l_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_1_4_l",radians:1*Math.PI/2,size:b(4,1,1)},brick_4_2_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_4_h",
radians:1*Math.PI/2,size:b(4,3,2)},brick_4_2_l_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_4_l",radians:1*Math.PI/2,size:b(4,1,2)},brick_8_2_h_t:{index:a++,special:!0,multipleColors:!1,transparent:!0,rotationOf:"brick_2_8_h",radians:1*Math.PI/2,size:b(8,3,2)},"1x1_round_open":{index:a++,special:!0,size:b(1,3,1)},"1x1_round_straight":{index:a++,special:!0,size:b(1,1,1)},"1x1_round_withouttop":{index:a++,special:!0,size:b(1,3,1)},"1x4_antenna":{index:a++,special:!0,
size:b(1,9,1)},"1x4_arc_r0":{index:a++,special:!0,size:b(1,3,4)},"1x4_fence_r0":{index:a++,special:!0,size:b(1,3,4)},"2x2x2_barrel":{index:a++,special:!0,size:b(2,6,2)},"1x3_flagpole_r0":{index:a++,special:!0,size:b(3,6,1)},"1x4_arc_r1":{index:a++,special:!0,rotationOf:"1x4_arc_r0",radians:1*Math.PI/2,size:b(4,3,1)},"1x4_arc_r2":{index:a++,special:!0,rotationOf:"1x4_arc_r0",radians:2*Math.PI/2,size:b(1,3,4)},"1x4_arc_r3":{index:a++,special:!0,rotationOf:"1x4_arc_r0",radians:3*Math.PI/2,size:b(4,3,
1)},"1x4_fence_r1":{index:a++,special:!0,rotationOf:"1x4_fence_r0",radians:1*Math.PI/2,size:b(4,3,1)},"1x4_fence_r2":{index:a++,special:!0,rotationOf:"1x4_fence_r0",radians:2*Math.PI/2,size:b(1,3,4)},"1x4_fence_r3":{index:a++,special:!0,rotationOf:"1x4_fence_r0",radians:3*Math.PI/2,size:b(4,3,1)},"1x3_flagpole_r1":{index:a++,special:!0,rotationOf:"1x3_flagpole_r0",radians:1*Math.PI/2,size:b(1,6,3)},"1x3_flagpole_r2":{index:a++,special:!0,rotationOf:"1x3_flagpole_r0",radians:2*Math.PI/2,size:b(3,6,
1)},"1x3_flagpole_r3":{index:a++,special:!0,rotationOf:"1x3_flagpole_r0",radians:3*Math.PI/2,size:b(1,6,3)},brick_2_1_s_inverted_r0:{index:a++,special:!0,size:b(1,9,2)},brick_2_2_s_inverted_r0:{index:a++,special:!0,size:b(2,3,2)},brick_2_1_s_inverted_r1:{index:a++,special:!0,rotationOf:"brick_2_1_s_inverted_r0",radians:1*Math.PI/2,size:b(2,9,1)},brick_2_1_s_inverted_r2:{index:a++,special:!0,rotationOf:"brick_2_1_s_inverted_r0",radians:2*Math.PI/2,size:b(1,9,2)},brick_2_1_s_inverted_r3:{index:a++,
special:!0,rotationOf:"brick_2_1_s_inverted_r0",radians:3*Math.PI/2,size:b(2,9,1)},brick_2_2_s_inverted_r1:{index:a++,special:!0,rotationOf:"brick_2_2_s_inverted_r0",radians:1*Math.PI/2,size:b(2,3,2)},brick_2_2_s_inverted_r2:{index:a++,special:!0,rotationOf:"brick_2_2_s_inverted_r0",radians:2*Math.PI/2,size:b(2,3,2)},brick_2_2_s_inverted_r3:{index:a++,special:!0,rotationOf:"brick_2_2_s_inverted_r0",radians:3*Math.PI/2,size:b(2,3,2)},"1x1_round_straight_t":{index:a++,special:!0,multipleColors:!1,transparent:!0,
rotationOf:"1x1_round_straight",radians:1*Math.PI/2,size:b(1,1,1)}},s;for(s in a)a[s].AABB={lowerBound:new GLOW.Vector3(0.5*-a[s].size.x*LDF.LUF.x,0,0.5*-a[s].size.z*LDF.LUF.z),upperBound:new GLOW.Vector3(0.5*a[s].size.x*LDF.LUF.x,a[s].size.y*LDF.LUF.y,0.5*a[s].size.z*LDF.LUF.z)};e(this.brickTypes);s=this.brickTypes;var m;s.rotationsOf={};for(m in s)a=s[m].rotationOf,void 0!==a&&(void 0===s.rotationsOf[a]&&(s.rotationsOf[a]=[]),s.rotationsOf[a].push(m));m=this.URLs={ExploreBrickGLSL:"/js/GLego/shaders/ExploreBrick.glsl",
ExploreBrickIDGLSL:"/js/GLego/shaders/ExploreBrickID.glsl",ExploreSpecialObjectGLSL:"/js/GLego/shaders/ExploreSpecialObject.glsl",ExploreSpecialObjectIDGLSL:"/js/GLego/shaders/ExploreSpecialObjectID.glsl",ExploreSpecialObjectTwoColorsGLSL:"/js/GLego/shaders/ExploreSpecialObjectTwoColors.glsl",ExplorePegGLSL:"/js/GLego/shaders/ExplorePeg.glsl",ExplorePegUnwrapGLSL:"/js/GLego/shaders/ExplorePegUnwrap.glsl",ExplorePostGLSL:"/js/GLego/shaders/ExplorePost.glsl",ExploreGroundGLSL:"/js/GLego/shaders/ExploreGround.glsl",
ExploreGroundColorGLSL:"/js/GLego/shaders/ExploreGroundColor.glsl",ExploreLightGLSL:"/js/GLego/shaders/ExploreLight.glsl",ExploreExpandColorGLSL:"/js/GLego/shaders/ExploreExpandColor.glsl",ExploreExpandNormalGLSL:"/js/GLego/shaders/ExploreExpandNormal.glsl",ExploreExpandDepthPositionGLSL:"/js/GLego/shaders/ExploreExpandDepthPosition.glsl",ExploreEdgesTexture:"/js/GLego/shaders/edgesMap.png",BuildObjectGLSL:"/js/GLego/shaders/BuildObject.glsl",BuildObjectMatrixTransformGLSL:"/js/GLego/shaders/BuildObjectMatrixTransform.glsl",
BuildObjectTwoColorsGLSL:"/js/GLego/shaders/BuildObjectTwoColors.glsl",BuildObjectTwoColorsMatrixTransformGLSL:"/js/GLego/shaders/BuildObjectTwoColorsMatrixTransform.glsl",BuildBasePlateGLSL:"/js/GLego/shaders/BuildBasePlate.glsl",BuildPostGLSL:"/js/GLego/shaders/BuildPost.glsl",BuildEnvironmentTexture:"/js/GLego/shaders/buildEnvironmentMap.png",TextureUnlitGLSL:"/js/GLego/shaders/TextureUnlit.glsl",BrickGeometry:"/assets/bricksGeometry6.js",BuildGeometry:"/assets/builderGeometry.js",BuildBasePlateShadowTexture:"/assets/builder/shadow.png",
LegoLogoTexture:"/assets/builder/lego_logo.png",SphereGeometry:"/assets/sphereGeometry.js",ExplorePeg:"/assets/pegGeometry6.json",ExploreWipeTexture:"/assets/groundWipeTexture.png"};for(var h in m)m[h.toLowerCase()]=m[h];this.brickVertices=new GLOW.Float([1,1,1,1,0,1,0,0,1,0,1,1,0,1,0,1,1,0,1,0,0,0,0,0]);this.brickNormals=new GLOW.Float([0,0,1,-1,0,0,0,0,-1,1,0,0,0,1,0,0,-1,0]);this.brickPegAndSidesChannelMask=new GLOW.Float([1,0,0,1,0,0,1,0,0,1,0,0,0,1,1,0,0,0]);this.brickUVs=new GLOW.Float([0,0,
1,0,1,1,0,1]);this.brickVertexIndices=[[0,2,1,0,3,2],[3,7,2,3,4,7],[4,6,7,4,5,6],[5,1,6,5,0,1],[5,3,0,5,4,3],[1,7,6,1,2,7]];this.brickUVIndices=[[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3]];this.objectEncodeTakingABreak=new signals.Signal;this.objectEncoded=new signals.Signal;this.objectDecoded=new signals.Signal}function b(a,b,c){return{x:a,y:b,z:c}}function c(a,b){b.index=a;b.colorMapUV=a;return b}function e(a){var b=[],c;for(c in a)a[c].name=c,b[a[c].index]=
a[c];a.array=b}a.prototype.getColor=function(a){if(a){a=utils.convertToLegacyColorIdentifier(a.toString().toLowerCase());if(void 0!==this.colors[a])return this.colors[a];console.error("GLEGO.DataFactory.getColor: Couldn't find data for "+a)}};a.prototype.getBrickType=function(a){a=a.toLowerCase();if(void 0!==this.brickTypes[a])return this.brickTypes[a];console.error("GLEGO.DataFactory.getBrickType: Couldn't find data for "+a)};a.prototype.getURL=function(a){a=a.toLowerCase();if(void 0!==this.URLs[a])return this.URLs[a];
console.error("GLEGO.DataFactory.getURL: Couldn't find data for "+a)};a.prototype.encode=function(a,b,c){var e;b=0;c=a.length;var g,z,G,r;e=Math.ceil(Math.sqrt(2*a.length));var A=document.createElement("canvas"),M=A.getContext("2d"),Y=M.createImageData(e,e),u=Y.data;A.width=e;for(A.height=e;b<c;b++)e=a[b],void 0==e||null==e||(z=e.type,r=e.position.value,G=e.lowerBound.value,g=8*b,u[g+0]=63,u[g+1]=e.color.colorMapUV,u[g+2]=z.index,u[g+3]=255,u[g+4]=Math.round((r[0]+G[0])/LDF.LUF.x+this.buildBasePlateHalfSizeLU),
u[g+5]=Math.round((r[1]+G[1])/LDF.LUF.y),u[g+6]=Math.round((r[2]+G[2])/LDF.LUF.z+this.buildBasePlateHalfSizeLU),u[g+7]=255);M.putImageData(Y,0,0);return{structure:"{}",buildData:A.toDataURL("image/png").slice(22)}};a.prototype.decodeToExplore=function(a,b){var c=document.createElement("canvas"),e=c.getContext("2d");c.width=a.width;c.height=a.height;e.drawImage(a,0,0);var c=e.getImageData(0,0,a.width,a.height).data,e=[],g=[],z=[],G=[],r,A,M,Y,u,d,I,l,f,U,R,Z=Math.floor(c.length/8),N=0,B=0,x=this.brickTypes.array;
for(R=0;R<Z;R++)if(M=8*R,f=c[M+0],I=c[M+1],l=c[M+2],r=c[M+4],A=c[M+5],M=c[M+6],Y=x[l].size.x-1,u=x[l].size.y-1,d=x[l].size.z-1,x[l].special)f&&(x[l].multipleColors?(f=GLEGO.Shaders.getGeometry(x[l].name).getAttributesAndElementsFor("ExploreSpecialObjectTwoColorsGLSL"),f.uColorIndices=new GLOW.Float([I,LDF.getColor("white").index]),f.uBuildTime=new GLOW.Float(1),f.uAlpha=new GLOW.Float(!0===x[l].transparent?0.75:1),f.uObjectPosition=b,I=GLEGO.Shaders.getShader("ExploreSpecialObjectTwoColorsGLSL")):
(f=GLEGO.Shaders.getGeometry(x[l].name).getAttributesAndElementsFor("ExploreSpecialObjectGLSL"),f.uColorIndex=new GLOW.Float(I),f.uBuildTime=new GLOW.Float(1),f.uAlpha=new GLOW.Float(!0===x[l].transparent?0.75:1),I=GLEGO.Shaders.getShader("ExploreSpecialObjectGLSL")),f.uObjectPosition=b,f.uPosition=new GLOW.Vector3((r+0.5*x[l].size.x)*LDF.LUF.x,A*LDF.LUF.y,(M+0.5*x[l].size.z)*LDF.LUF.z),r=I.clone(f),GLEGO.Shaders.applySharedUniform(r,r.uniforms.uObjectPosition),GLEGO.Shaders.applySharedUniform(r,
r.uniforms.uAlpha),GLEGO.Shaders.applySharedUniform(r,void 0!==r.uniforms.uColorIndex?r.uniforms.uColorIndex:r.uniforms.uColorIndices),!0==x[l].transparent?(void 0===G[l]&&(G[l]=[]),r.screenZ=0,G[l].push(r)):(void 0===z[l]&&(z[l]=[]),z[l].push(r)));else for(l=0;5>l;l++){if(f&1<<l)for(U=0;6>U;U++)e[N++]=r<<8|A,e[N++]=M<<8|l<<4|this.brickVertexIndices[l][U],e[N++]=Y<<10|u<<5|d,e[N++]=this.brickUVIndices[l][U]<<8|I;for(U=0;6>U;U++)g[B++]=r<<8|A,g[B++]=M<<8|l<<4|this.brickVertexIndices[l][U],g[B++]=Y<<
10|u<<5|d,g[B++]=this.brickUVIndices[l][U]<<8|I}return{aBrickData:e,aBrickDataUnoptimized:g,specialObjects:z,transparentObjects:G}};a.prototype.decodeToBuild=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=a.width;b.height=a.height;c.drawImage(a,0,0);a=c.getImageData(0,0,a.width,a.height).data;for(var e,b=[],g,z,G,r,A=Math.floor(a.length/8),M=this.brickTypes.array,Y=this.colors.array,c=0;c<A;c++)if(G=8*c,g=a[G+0])e=a[G+1],r=a[G+2],g=a[G+4],z=a[G+5],G=a[G+6],e=new GLEGO.BuildObject(M[r].name,
Y[e].name),e.position.set((g+0.5*M[r].size.x-this.buildBasePlateHalfSizeLU)*LDF.LUF.x,z*LDF.LUF.y,(G+0.5*M[r].size.z-this.buildBasePlateHalfSizeLU)*LDF.LUF.z),b.push(e);return b};a.prototype.optimizeImageData=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=a.width;b.height=a.height;c.drawImage(a,0,0);a=c.getImageData(0,0,a.width,a.height);var e=a.data,g=Array(34),z,G,r;for(z=0;34>z;z++){g[z]=Array(86);for(G=0;86>G;G++)g[z][G]=Array(34)}var A,M=[],Y,u,d,I,l,f,U,R,Z,
N,B,x,w,k,v,t,C=Math.floor(e.length/8);x=this.brickTypes.array;for(t=0;t<C;t++)if(B=8*t,A=e[B+2],!x[A].special){R=e[B+4]+1;Z=e[B+5]+1;N=e[B+6]+1;Y=x[A].size.x+R;u=x[A].size.y+Z;d=x[A].size.z+N;for(z=R;z<Y;z++)for(G=Z;G<u;G++)for(r=N;r<d;r++)g[z][G][r]=B;M.push({x:R,y:Z,z:N,w:x[A].size.x,h:x[A].size.y,d:x[A].size.z,visibleSides:0,o24:B})}var H=[{start:{x:0,y:0,z:1},step:{aX:1,aY:0,aZ:0,bX:0,bY:1,bZ:0},testDirection:{x:0,y:0,z:1}},{start:{x:0,y:0,z:0},step:{aX:0,aY:0,aZ:1,bX:0,bY:1,bZ:0},testDirection:{x:-1,
y:0,z:0}},{start:{x:0,y:0,z:0},step:{aX:1,aY:0,aZ:0,bX:0,bY:1,bZ:0},testDirection:{x:0,y:0,z:-1}},{start:{x:1,y:0,z:0},step:{aX:0,aY:0,aZ:1,bX:0,bY:1,bZ:0},testDirection:{x:1,y:0,z:0}},{start:{x:0,y:1,z:0},step:{aX:1,aY:0,aZ:0,bX:0,bY:0,bZ:1},testDirection:{x:0,y:1,z:0}}],C=M.length;for(t=0;t<C;t++){A=M[t];z=A.x;G=A.y;r=A.z;Y=A.w;u=A.h;d=A.d;for(x=B=0;5>x;x++){w=1<<x;R=H[x];N=R.start;k=R.step;v=R.testDirection;R=z+(Y-1)*N.x;Z=G+(u-1)*N.y;N=r+(d-1)*N.z;f=1===k.aX?Y:1===k.aY?u:d;U=1===k.bX?Y:1===k.bY?
u:d;for(I=0;I<f;I++){for(l=0;l<U&&void 0!==g[R+v.x][Z+v.y][N+v.z];l++)R+=k.bX,Z+=k.bY,N+=k.bZ;if(l!=U)break;R-=k.bX*U;Z-=k.bY*U;N-=k.bZ*U;R+=k.aX;Z+=k.aY;N+=k.aZ}I===f&&(w=0);B|=w}e[A.o24]=B}c.putImageData(a,0,0);return b};a.prototype.optimize=function(a,b){for(var c=a.length,e=Array(a.length);c--;)e[c]=63;return e};return new a}();GLEGO.DirectionalLight=function(a){this.color=void 0!==a.color?a.color:new GLOW.Color(16777215);this.intensity=void 0!==a.intensity?a.intensity:1;this.direction=void 0!==a.direction?a.direction.normalize():(new GLOW.Vector3(-1,-1,-1)).normalize()};GLEGO.DirectionalLight.prototype.setDirection=function(a,b,c){this.direction.set(a,b,c).normalize()};GLEGO.DirectionalLight.prototype.setColorRBG=function(a,b,c){this.color.setRGB(a,b,c)};GLEGO.DirectionalLight.prototype.setColorHex=function(a){this.color.setHex(a)};
GLEGO.DirectionalLight.prototype.setColorHSV=function(a,b,c){this.color.setHSV(a,b,c)};GLEGO.Fog=function(a){this.nearAndFar=new GLOW.Vector2(a.near||0,a.far||3E3);this.color=a.color||new GLOW.Color(16777215)};GLEGO.Geometry=function(){function a(a){this.indices=this.aVertexColors=this.aUVs=this.aNormals=this.aVertices=void 0;this.indicesLength=0;this.init(a)}function b(){this.elements=this.aVertexColors=this.aUVs=this.aNormals=this.aVertices=void 0}function c(b){this.rawData=b;this.buffers=new a(b);this.attribElementDictionary={};void 0!==window.GL?this.buffers.init(b):console.warn("Geometry.construct: no global GL created, please create WebGL context first.")}a.prototype.init=function(a){for(var b in this)"indices"!==
b&&("indicesLength"!==b&&a[b]&&a[b].length)&&(this[b]=GL.createBuffer(),GL.bindBuffer(GL.ARRAY_BUFFER,this[b]),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a[b]),GL.STATIC_DRAW));a.indices&&(this.indices=GL.createBuffer(),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,this.indices),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),GL.STATIC_DRAW),this.indicesLength=a.indices.length)};a.prototype.get=function(a){if(this[a])return this[a]};b.prototype.setAttribute=function(a,b,c){this[a]=b.clone();
this[a].buffer=c.get(a)};b.prototype.setElements=function(a,b){this.elements=a.clone();this.elements.elements=b.get("indices");this.elements.length=b.get("indicesLength")};c.prototype.setAttributesAndElementsFor=function(a){var c=GLEGO.Shaders.getShader(a);if(c){if(void 0===this.attribElementDictionary[a]){this.attribElementDictionary[a]=new b;for(var s in c.attributes)this.buffers.get(s)&&this.attribElementDictionary[a].setAttribute(s,c.attributes[s],this.buffers);this.attribElementDictionary[a].setElements(c.elements,
this.buffers)}}else console.warn("GLEGO.Geometry.setAttributesAndElementsFor: Couldn't find shader "+a)};c.prototype.getAttributesAndElementsFor=function(a){if(this.attribElementDictionary[a])return this.attribElementDictionary[a];console.warn("Geometry.getAttributesAndElementsFor: trying to get attributes and elements for "+a+", which doesn't exist.")};return c}();GLEGO.Object3D=function(){this.position=new GLOW.Vector3;this.visible=!0;this.insideFrustum=!1;this.screenZ=0};GLEGO.Object3D.prototype.applyShader=function(a,b,c){b=void 0===b?{}:GLEGO.Shaders.getGeometry(b).getAttributesAndElementsFor(a);b.uPosition=this.position;if(c)for(var e in c)b[e]=c[e];this.shader=GLEGO.Shaders.getShader(a).clone(b);return this};GLEGO.Object3D.prototype.draw=function(){this.shader.draw()};GLEGO.Object3D.prototype.calculateScreenZ=function(){};GLEGO.PointLight=function(a){this.position=a.position||new GLOW.Vector3(0,0,0);this.range=a.range||100;this.color=a.color||new GLOW.Color(16777215);this.intensity=a.intensity||1};GLEGO.PointLight.prototype.setColorRBG=function(a,b,c){this.color.setRGB(a,b,c)};GLEGO.PointLight.prototype.setColorHex=function(a){this.color.setHex(a)};GLEGO.PointLight.prototype.setColorHSV=function(a,b,c){this.color.setHSV(a,b,c)};GLEGO.ExploreGround=function(){function a(a,c){GLEGO.Object3D.call(this);this.controller=c;this.state="default";this.texture=new GLOW.Texture({data:a,filter:GL.NEAREST,wrap:GL.CLAMP_TO_EDGE});this.frame=new GLOW.Float(0);this.buildTime=new GLOW.Float(0);this.baseColor=new GLOW.Color(15987699);this.brightnessSaturationContrast=new GLOW.Vector3(1,1,1);this.baseColorSelected=new GLOW.Color(16777215);this.baseColorOccupied=new GLOW.Color(14540253);this.baseColorInProgress=new GLOW.Color(15987699);this.applyShader("ExploreGroundColorGLSL",
void 0,{uTexture:this.texture,uBaseColor:this.baseColor,uBrightnessSaturationContrast:this.brightnessSaturationContrast,uBuildTime:this.buildTime,uSize:new GLOW.Vector2(a.width,a.height)});this.lowerBound=new GLOW.Vector3(0.5*-a.width*LDF.LUF.x,3*-LDF.LUF.y,0.5*-a.height*LDF.LUF.z);this.upperBound=new GLOW.Vector3(0.5*a.width*LDF.LUF.x,0,0.5*a.height*LDF.LUF.z)}a.prototype=new GLEGO.Object3D;a.prototype.constructor=GLEGO.ExploreGround;a.prototype.updateTexture=function(a,c){this.shader.uniforms.uTexture.data.updateTexture({data:a,
updateMipmap:!1});c?this.buildTime.set(0):this.buildTime.set(1)};a.prototype.draw=function(){this.buildTime.add(0.02);this.shader.draw()};a.prototype.setState=function(a){"free_selected"==a?this.shader.uniforms.uBaseColor.data=this.baseColorSelected:"free_hover"==a?this.shader.uniforms.uBaseColor.data=this.baseColorSelected:"free"==a?this.shader.uniforms.uBaseColor.data=new GLOW.Color(15987699):"occupied_selected"==a?this.shader.uniforms.uBaseColor.data=this.baseColorOccupied:"occupied_hover"==a?
this.shader.uniforms.uBaseColor.data=this.baseColorOccupied:"occupied"==a?this.shader.uniforms.uBaseColor.data=new GLOW.Color(15987699):"inprogress"==a&&(this.shader.uniforms.uBaseColor.data=this.baseColorInProgress);this.state=a};a.prototype.resetState=function(){this.shader.uniforms.uBaseColor.data=new GLOW.Color(15987699);this.state="default"};a.prototype.getState=function(){return this.state};a.prototype.showFrame=function(a){};a.prototype.hideFrame=function(){this.shader.uniforms.uBaseColor.data=
new GLOW.Color(15987699)};a.prototype.dispose=function(){};return a}();GLEGO.ExploreObject=function(){function a(a,b){GLEGO.Object3D.call(this);void 0!==b&&(e=b);if(void 0===a||void 0===a.buildData){this.numBrickPolygons=0;this.brickData=[];var c=function(){return Math.floor(9.9999*Math.random())},h;h=this.createBrick(0,0,3,5,0,2,1,c());h=this.createBrick(h,2,15,5,2,2,1,c());h=this.createBrick(h,2,12,5,3,2,1,c());h=this.createBrick(h,2,9,5,4,2,1,c());h=this.createBrick(h,2,6,5,5,2,1,c());h=this.createBrick(h,10,3,5,0,2,6,c());h=this.createBrick(h,12,3,5,0,2,7,c());h=
this.createBrick(h,14,3,5,0,2,8,c());h=this.createBrick(h,16,3,5,0,2,9,c());h=this.createBrick(h,18,3,5,0,2,10,c());this.bricks=GLEGO.Shaders.getShader("ExploreBrickGLSL").clone({uPosition:this.position,aBrickData:this.brickData,elements:new GLOW.Elements(this.brickData.length/4)});c=GLEGO.Shaders.getGeometry("brick_door_r1").getAttributesAndElementsFor("ExploreSpecialObjectTwoColorsGLSL");c.uColorIndices=new GLOW.Float([3,LDF.getColor("white").index]);c.uObjectPosition=this.position;c.uPosition=
new GLOW.Vector3(5*LDF.LUF.x,10*LDF.LUF.y,20*LDF.LUF.z);this.specialObjects=[];this.specialObjects.push(GLEGO.Shaders.getShader("ExploreSpecialObjectTwoColorsGLSL").clone(c))}else this.buildTime=new GLOW.Float(1),c=LDF.decodeToExplore(a.buildData,this.position),this.bricks=GLEGO.Shaders.getShader("ExploreBrickGLSL").clone({uPosition:this.position,uBuildTime:this.buildTime,aBrickData:c.aBrickDataUnoptimized,elements:new GLOW.Elements(c.aBrickDataUnoptimized.length/4)}),this.brickAttribute=c.aBrickData,
this.specialObjects=c.specialObjects,this.transparentObjects=c.transparentObjects}var b=[[0,2,1,0,3,2],[3,7,2,3,4,7],[4,6,7,4,5,6],[5,1,6,5,0,1],[5,3,0,5,4,3],[1,7,6,1,2,7]],c=[[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3],[1,3,2,1,0,3]],e=0.01;a.prototype=new GLEGO.Object3D;a.prototype.constructor=GLEGO.ExploreObject;a.prototype.draw=function(){0<this.buildTime.value[0]?this.buildTime.sub(e):(this.buildTime.set(0),void 0!==this.brickAttribute&&(this.bricks.aBrickData.dispose(),
this.bricks.aBrickData.bufferData(this.brickAttribute),this.bricks.elements.length=this.bricks.aBrickData.data.length/this.bricks.aBrickData.size,this.brickAttribute=void 0));for(var a,b=this.specialObjects.length;b--;){var c=this.specialObjects[b];if(c)for(var h=c.length;h--;)a=c[h].uBuildTime,0<a.value[0]?a.sub(e):a.set(0)}for(b=this.transparentObjects.length;b--;)if(c=this.transparentObjects[b])for(h=c.length;h--;)a=c[h].uBuildTime,0<a.value[0]?a.sub(e):a.set(0);this.bricks.draw()};a.prototype.dispose=
function(){this.bricks.attributes.aBrickData.dispose();delete this.bricks;delete this.specialObjects;delete this.transparentObjects};a.prototype.createBrick=function(a,e,m,h,g,z,G,r){var A,M;for(A=0;6>A;A++)for(M=0;6>M;M++)this.brickData[a++]=e<<8|m,this.brickData[a++]=h<<8|A<<4|b[A][M],this.brickData[a++]=g<<10|z<<5|G,this.brickData[a++]=c[A][M]<<8|r;this.numBrickPolygons+=12;return a};return a}();GLEGO.ExploreRenderer=function(){var a,b,c,e=[],y=[],s=[],m,h,g,z,G,r,A,M,Y,u,d,I,l,f,U,R,Z,N,B,x,w,k,v=new GLOW.Vector3,t=new GLOW.Matrix3,C=[new GLOW.Vector3(0,0,1),new GLOW.Vector3(-1,0,0),new GLOW.Vector3(0,0,-1),new GLOW.Vector3(1,0,0),new GLOW.Vector3(0,1,0),new GLOW.Vector3(0,-1,0)],H=new GLOW.Vector3(0,1,0),F=[new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4],q=new GLOW.Matrix4,p=new GLOW.Vector3,ea=new GLOW.Vector3(LDF.buildBasePlateHalfSizeLU*
LDF.LUF.x,128*LDF.LUF.y,LDF.buildBasePlateHalfSizeLU*LDF.LUF.z),P=function(a){this.initialized=new signals.Signal;this.beforeRendering=new signals.Signal;this.afterRendering=new signals.Signal;this.resized=new signals.Signal;this.datGUIValues={}};P.prototype.init=function(c){if(void 0===c)console.error("GLEGO.ExploreRenderer.init: I need parameters!");else{c.context.antialias=!0;c.context.alpha=!1;c.context.depth=!1;c.context.stencil=!1;a=new GLOW.Context(c.context);c.context.alpha=!0;c.context.depth=
!0;c.context.stencil=!0;c.context.clear={red:1,green:0,blue:0,alpha:0,bits:GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT};c.context.filter=GL.NEAREST;c.context.wrap=GL.CLAMP_TO_EDGE;c.context.width=a.width;c.context.height=a.height;b=new GLOW.FBO(c.context);m=new GLEGO.Camera(c.camera);g=new GLEGO.Fog(c.fog);h=new GLEGO.Ambient(c.ambient);z=new GLOW.Vector2(b.width,b.height);G=new GLOW.Vector2(m.near,m.far);this.setupLights(c.directionalLights);GLEGO.Shaders.setNumberOfDirectionalLights(r.length);GLEGO.Shaders.setNumberOfPointLights(0);
c.load=c.load||{};c.load.shaders=c.load.shaders||[];c.load.geometry=c.load.geometry||[];c.load.textures=c.load.textures||[];var f=function(a,b){-1===c.load[a].indexOf(b)&&c.load[a].push(b)};f("shaders","ExploreBrickGLSL");f("shaders","ExploreBrickIDGLSL");f("shaders","ExploreGroundGLSL");f("shaders","ExplorePostGLSL");f("shaders","ExploreLightGLSL");f("shaders","ExploreSpecialObjectGLSL");f("shaders","ExploreSpecialObjectTwoColorsGLSL");f("shaders","ExplorePegUnwrapGLSL");f("shaders","ExploreExpandColorGLSL");
f("shaders","ExploreExpandNormalGLSL");f("shaders","ExploreExpandDepthPositionGLSL");f("geometry","ExplorePeg");f("geometry","BrickGeometry");f("textures","ExploreEdgesTexture");GLEGO.Shaders.buildExploreColorTexture();GLEGO.Shaders.loaded.addOnce(this.shadersGeometryAndTexturesLoaded,this);GLEGO.Shaders.load(c.load)}};P.prototype.setupLights=function(a){if(a){r=Array(a.length);A=new GLOW.Float(Array(3*a.length));M=new GLOW.Float(Array(3*a.length));Y=new GLOW.Float(Array(1*a.length));for(var b=a.length;b--;)r[b]=
new GLEGO.DirectionalLight(a[b])}else r=[];this.updateLights()};P.prototype.updateLights=function(){for(var a=r.length;a--;)A.value[3*a+0]=r[a].direction.value[0],A.value[3*a+1]=r[a].direction.value[1],A.value[3*a+2]=r[a].direction.value[2],M.value[3*a+0]=r[a].color.value[0],M.value[3*a+1]=r[a].color.value[1],M.value[3*a+2]=r[a].color.value[2],Y.value[a]=r[a].intensity};P.prototype.shadersGeometryAndTexturesLoaded=function(a,q,e){N=new GLOW.FBO({depth:!0,width:128,height:128,wrap:GL.REPEAT,filter:GL.NEAREST});
B=new GLOW.FBO({depth:!1,width:128,height:128,wrap:GL.REPEAT,filter:GL.NEAREST,data:GLEGO.Shaders.getTexture("ExploreEdgesTexture").data});c=new GLOW.FBO({depth:!1,width:63,height:63,wrap:GL.CLAMP_TO_EDGE,filter:GL.LINEAR});f=new GLOW.FBO({width:b.width,height:b.height,depth:!1,stencil:!1,wrap:GL.CLAMP_TO_EDGE,filter:GL.LINEAR,clear:{red:0,green:0,blue:0,alpha:0}});U=new GLOW.FBO({width:b.width,height:b.height,depth:!1,stencil:!1,wrap:GL.CLAMP_TO_EDGE,filter:GL.LINEAR,clear:{red:0,green:0,blue:0,
alpha:0}});e=function(a){a.bind();a.clear();a.unbind()};e(c);e(N);e(f);e(U);var p;for(e=a.length;e--;)this.setCommonUniformsOn(a[e]);for(p=q.length;p--;)for(e=a.length;e--;)GLEGO.Shaders.getGeometry(q[p]).setAttributesAndElementsFor(a[e]);x=new GLEGO.Camera({useTarget:!1,ortho:{right:4.2,left:-4.2,top:-4.2,bottom:4.2}});w=(new GLEGO.Object3D).applyShader("ExploreSpecialObjectGLSL","peg",{uProjection:x.projection,uInverse:x.inverse,uObjectPosition:new GLOW.Vector3,uColorIndex:new GLOW.Float(0)});k=
GLEGO.Shaders.getShader("ExplorePegUnwrapGLSL");k.uniforms.uPegAndSidesFBO.data=N;d=GLEGO.Shaders.getShader("ExploreBrickGLSL");d.uniforms.uPegAndSidesFBO.data=B;I=GLEGO.Shaders.getShader("ExploreGroundGLSL");I.uniforms.uPegAndSidesFBO.data=B;u=GLEGO.Shaders.getShader("ExploreLightGLSL");R=GLEGO.Shaders.getShader("ExploreExpandColorGLSL");R.uniforms.uLightMap.data=c;R.uniforms.uColorMap.data=GLEGO.Shaders.getTexture("ExploreColorTexture");Z=GLEGO.Shaders.getShader("ExploreExpandDepthPositionGLSL");
l=GLEGO.Shaders.getShader("ExplorePostGLSL");l.uniforms.uExpandColor.data=f;l.uniforms.uExpandDepthPosition.data=U;this.initialized.dispatch()};P.prototype.setCommonUniformsOn=function(a){var c=GLEGO.Shaders.getShader(a);a=function(a,b){c.uniforms[a]&&(c.uniforms[a].data=b)};a("uProjection",m.projection);a("uInverse",m.inverse);a("uAmbientColor",h.color);a("uViewport",z);a("uNearAndFar",G);a("uFogNearAndFar",g.nearAndFar);a("uFogColor",g.color);a("uGFBO",b);r.length&&(a("uDirLightDirections",A),a("uDirLightColors",
M),a("uDirLightIntensities",Y));c.attachData()};P.prototype.render=function(){var q,p,h;this.beforeRendering.dispatch();m.update();a.cache.clear();a.cache.active=!1;t.extractFromMatrix4(m.inverse);q=0;for(p=r.length;q<p;q++)v.copy(r[q].direction),t.multiplyVector3(v),A.value[3*q+0]=v.value[0],A.value[3*q+1]=v.value[1],A.value[3*q+2]=v.value[2];h=d.uniforms.uBrickNormalUVs.data.value;q=0;for(p=6;q<p;q++)v.copy(C[q]),t.multiplyVector3(v),h[2*q+0]=0.5*v.value[0]+0.5,h[2*q+1]=0.5*v.value[1]+0.5;h=I.uniforms.uUpNormal.data.value;
v.copy(H);t.multiplyVector3(v);h[0]=0.5*v.value[0]+0.5;h[1]=0.5*v.value[1]+0.5;c.bind();u.draw();c.unbind(!1);GL.colorMask(!1,!1,!0,!0);N.bind();N.clear();x.inverse.copy(m.inverse);x.inverse.setPosition(0,0,-50);w.draw();N.unbind(!1);B.bind(!1);k.draw();B.unbind(!1);GL.colorMask(!0,!0,!0,!0);b.bind();b.clear();this.computeFrustum();for(q=e.length;q--;)p=e[q],p.visible&&this.insideFrustum(p)&&p.bricks.draw();for(q=e.length;q--;)if(p=e[q],p.visible&&p.insideFrustum){h=p.specialObjects;for(p=h.length;p--;)h[p].draw()}if(q=
s.length){GLEGO.Shaders.getShader("ExploreSpecialObjectGLSL").uInverseRotation.extractFromMatrix4(m.inverse);for(q=s.length;q--;)p=s[q],p.visible&&this.insideFrustum(p)&&p.draw()}for(q=y.length;q--;)y[q].draw();b.unbind(!1);f.bind(!1);R.draw();f.unbind(!1);U.bind(!1);Z.draw();U.unbind(!1);l.draw();this.afterRendering.dispatch()};P.prototype.computeFrustum=function(){q.multiply(m.projection,m.inverse);var a=q.value;F[0].set(a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]);F[1].set(a[3]+a[0],a[7]+a[4],a[11]+
a[8],a[15]+a[12]);F[2].set(a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]);F[3].set(a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]);F[4].set(a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]);F[5].set(a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]);for(a=6;a--;)F[a].divideScalar(F[a].lengthOfXYZ())};P.prototype.insideFrustum=function(a){p.copy(a.position).addSelf(ea);for(var b=p.value,c=-200*LDF.LUF.y,f,q=6;q--&&!(f=F[q].value,f[0]*b[0]+f[1]*b[1]+f[2]*b[2]+f[3]<=c););return a.insideFrustum=!0};P.prototype.resize=
function(c,q){a.resize(c,q);b.resize(c,q);f.resize(c,q);U.resize(c,q);m.resize(c,q);z.set(c,q)};P.prototype.addObject=function(a){a instanceof GLEGO.ExploreObject?-1===e.indexOf(a)&&(e[e.length]=a):a instanceof GLEGO.ExploreGround?-1===y.indexOf(a)&&(y[y.length]=a):-1===s.indexOf(a)&&s.push(a)};P.prototype.removeObject=function(a){a instanceof GLEGO.ExploreObject?(a=e.indexOf(a),-1!==a&&e.splice(a,1)):a instanceof GLEGO.ExploreGround?(a=y.indexOf(a),-1!==a&&y.splice(a,1)):(a=s.indexOf(a),-1!==a&&
s.splice(a,1))};P.prototype.getExploreObjectAtPosition=function(a,c){var f,q,d,p;b.bind();GL.clearColor(0,0,0,0);GL.clearDepth(1);GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT);f=e.length;for(q=1;f--;)d=e[f],d.visible&&d.insideFrustum&&(d.bricksId.uniforms.uID.data.set(((q&16711680)>>16)/255,((q&65280)>>8)/255,(q&255)/255,1),d.bricksId.draw()),q++;f=e.length;for(q=1;f--;){d=e[f];if(d.visible&&d.insideFrustum){d=d.specialObjectsId;for(p=d.length;p--;)d[p].draw()}q++}f=new Uint8Array(4);GL.readPixels(a,
b.height-c,1,1,GL.RGBA,GL.UNSIGNED_BYTE,f);b.unbind();q=f[0]<<16|f[1]<<8||f[2];if(0!==q)return q--,e[q]};P.prototype.getDomElement=function(){return a.domElement};P.prototype.getCamera=function(){return m};P.prototype.getLights=function(){return lights};P.prototype.getAmbient=function(){return h};P.prototype.showDatGUI=function(){var a=this,b=new dat.GUI,c=function(c,q,f,d,e){a.datGUIValues[q]=f;b.add(a.datGUIValues,q,d,e).onChange(function(b){a.updateDatGUI(q,b)})},f=function(c,q,f){a.datGUIValues[q]=
f;b.addColor(a.datGUIValues,q).onChange(function(b){a.updateDatGUI(q,b)})};c(void 0,"VignetteOffset",l.uniforms.uVignette.data.value[0],0,1);c(void 0,"VignetteFactor",l.uniforms.uVignette.data.value[1],0,1);c(void 0,"BrigthnessOffset",l.uniforms.uBrightness.data.value[0],0,1);c(void 0,"BrigthnessFactor",l.uniforms.uBrightness.data.value[1],0,2);c(void 0,"ContrastOffset",l.uniforms.uContrast.data.value[0],0,1);c(void 0,"ContrastFactor",l.uniforms.uContrast.data.value[1],0,2);c(void 0,"SaturationOffset",
l.uniforms.uSaturation.data.value[0],0,1);c(void 0,"SaturationFactor",l.uniforms.uSaturation.data.value[1],0,2);c(void 0,"BlurStart",l.uniforms.uBlur.data.value[0],0,0.2);c(void 0,"BlurEnd",l.uniforms.uBlur.data.value[1],0,0.4);c(void 0,"BlurAmount",l.uniforms.uBlur.data.value[2],0,6);c(void 0,"PegAttenuationStart",I.uniforms.uPegAttenuation.data.value[0],0,0.2);c(void 0,"PegAttenuationEnd",I.uniforms.uPegAttenuation.data.value[1],0,1);c(void 0,"PegAttenuationFactor",I.uniforms.uPegAttenuation.data.value[2],
0,1);for(var q=0;q<r.length;q++)f(void 0,"L"+q+"_Color",[255*r[q].color.value[0],255*r[q].color.value[1],255*r[q].color.value[2]]),c(void 0,"L"+q+"_Intensity",r[q].intensity,0,2),c(void 0,"L"+q+"_DirectionX",r[q].direction.value[0],-1,1),c(void 0,"L"+q+"_DirectionY",r[q].direction.value[1],-1,1),c(void 0,"L"+q+"_DirectionZ",r[q].direction.value[2],-1,1);f(void 0,"AmbientColor",[255*h.color.value[0],255*h.color.value[1],255*h.color.value[2]]);f(void 0,"FogColor",[255*g.color.value[0],255*g.color.value[1],
255*g.color.value[2]]);c(void 0,"FogNear",g.nearAndFar.value[0],0,5E3);c(void 0,"FogFar",g.nearAndFar.value[1],0,5E3);b.remember(this.datGUIValues)};P.prototype.updateDatGUI=function(a,b){switch(a){case "VignetteOffset":l.uniforms.uVignette.data.value[0]=b;break;case "VignetteFactor":l.uniforms.uVignette.data.value[1]=b;break;case "BrigthnessOffset":l.uniforms.uBrightness.data.value[0]=b;break;case "BrigthnessFactor":l.uniforms.uBrightness.data.value[1]=b;break;case "ContrastOffset":l.uniforms.uContrast.data.value[0]=
b;break;case "ContrastFactor":l.uniforms.uContrast.data.value[1]=b;break;case "SaturationOffset":l.uniforms.uSaturation.data.value[0]=b;break;case "SaturationFactor":l.uniforms.uSaturation.data.value[1]=b;break;case "BlurStart":l.uniforms.uBlur.data.value[0]=b;break;case "BlurEnd":l.uniforms.uBlur.data.value[1]=b;break;case "BlurAmount":l.uniforms.uBlur.data.value[2]=b;break;case "PegAttenuationStart":I.uniforms.uPegAttenuation.data.value[0]=b;break;case "PegAttenuationEnd":I.uniforms.uPegAttenuation.data.value[1]=
b;break;case "PegAttenuationFactor":I.uniforms.uPegAttenuation.data.value[2]=b;break;case "AmbientColor":h.color.value[0]=b[0]/255;h.color.value[1]=b[1]/255;h.color.value[2]=b[2]/255;break;case "FogColor":g.color.value[0]=b[0]/255;g.color.value[1]=b[1]/255;g.color.value[2]=b[2]/255;break;case "FogNear":g.nearAndFar.value[0]=b;break;case "FogFar":g.nearAndFar.value[1]=b}if(0===a.indexOf("L")){var c=parseInt(a.slice(1,2),10);a=a.slice(3);switch(a){case "Color":r[c].color.value[0]=b[0]/255;r[c].color.value[1]=
b[1]/255;r[c].color.value[2]=b[2]/255;break;case "Intensity":r[c].intensity=b;break;case "DirectionX":r[c].direction.value[0]=b;case "DirectionY":r[c].direction.value[1]=b;case "DirectionZ":r[c].direction.value[2]=b}r[c].direction.normalize();this.updateLights()}};return P}();GLEGO.ExploreRendererForward=function(){function a(a,b){return a.screenZ<b.screenZ?1:a.screenZ>b.screenZ?-1:0}var b,c,e=[],y=[],s=[],m=[],h,g,z,G,r,A,M,Y,u,d,I,l,f,U,R,Z,N=new GLOW.Vector3,B=new GLOW.Matrix3,x=[new GLOW.Vector3(0,0,1),new GLOW.Vector3(-1,0,0),new GLOW.Vector3(0,0,-1),new GLOW.Vector3(1,0,0),new GLOW.Vector3(0,1,0),new GLOW.Vector3(0,-1,0)];new GLOW.Vector3(0,0,0);var w=[new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4,new GLOW.Vector4],k=new GLOW.Matrix4,
v=new GLOW.Vector3,t=new GLOW.Vector3(LDF.buildBasePlateHalfSizeLU*LDF.LUF.x,LDF.buildBasePlateHalfSizeLU*LDF.LU.y,LDF.buildBasePlateHalfSizeLU*LDF.LUF.z),C,H=new GLOW.Vector4,F=function(a){this.initialized=new signals.Signal;this.beforeRendering=new signals.Signal;this.afterRendering=new signals.Signal;this.resized=new signals.Signal;this.datGUIValues={}};F.prototype.init=function(a){if(void 0===a)console.error("GLEGO.ExploreRenderer.init: I need parameters!");else{a.context.antialias=!0;a.context.alpha=
!1;a.context.depth=!0;a.context.stencil=!1;a.context.preserveDrawingBuffer=!1;a.context.clear={red:1,green:0,blue:0,alpha:0,bits:GL.DEPTH_BUFFER_BIT};b=new GLOW.Context(a.context);h=new GLEGO.Camera(a.camera);z=new GLEGO.Fog(a.fog);g=new GLEGO.Ambient(a.ambient);G=new GLOW.Vector2(h.near,h.far);this.setupLights(a.directionalLights);GLEGO.Shaders.setNumberOfDirectionalLights(r.length);GLEGO.Shaders.setNumberOfPointLights(0);a.load=a.load||{};a.load.shaders=a.load.shaders||[];a.load.geometry=a.load.geometry||
[];a.load.textures=a.load.textures||[];var c=function(b,c){-1===a.load[b].indexOf(c)&&a.load[b].push(c)};c("shaders","ExploreBrickGLSL");c("shaders","ExploreBrickIDGLSL");c("shaders","ExploreGroundColorGLSL");c("shaders","ExploreLightGLSL");c("shaders","ExploreSpecialObjectGLSL");c("shaders","ExploreSpecialObjectTwoColorsGLSL");c("shaders","ExplorePegGLSL");c("shaders","ExplorePegUnwrapGLSL");c("geometry","ExplorePeg");c("geometry","BrickGeometry");c("textures","ExploreEdgesTexture");c("textures",
"ExploreWipeTexture");GLEGO.Shaders.buildExploreColorTexture();GLEGO.Shaders.loaded.addOnce(this.shadersGeometryAndTexturesLoaded,this);GLEGO.Shaders.load(a.load)}};F.prototype.setupLights=function(a){if(a){r=Array(a.length);A=new GLOW.Float(Array(3*a.length));M=new GLOW.Float(Array(3*a.length));Y=new GLOW.Float(Array(1*a.length));for(var b=a.length;b--;)r[b]=new GLEGO.DirectionalLight(a[b])}else r=[];this.updateLights()};F.prototype.updateLights=function(){for(var a=r.length;a--;)A.value[3*a+0]=
r[a].direction.value[0],A.value[3*a+1]=r[a].direction.value[1],A.value[3*a+2]=r[a].direction.value[2],M.value[3*a+0]=r[a].color.value[0],M.value[3*a+1]=r[a].color.value[1],M.value[3*a+2]=r[a].color.value[2],Y.value[a]=r[a].intensity};F.prototype.shadersGeometryAndTexturesLoaded=function(a,b,e){l=new GLOW.FBO({depth:!0,width:128,height:128,wrap:GL.REPEAT,filter:GL.NEAREST});f=new GLOW.FBO({depth:!1,width:128,height:128,wrap:GL.REPEAT,filter:GL.NEAREST,data:GLEGO.Shaders.getTexture("ExploreEdgesTexture").data});
e=c=new GLOW.FBO({depth:!1,width:128,height:128,wrap:GL.CLAMP_TO_EDGE,filter:GL.LINEAR});e.bind();e.clear();e.unbind();e=l;e.bind();e.clear();e.unbind();var r;for(e=a.length;e--;)this.setCommonUniformsOn(a[e]);for(r=b.length;r--;)for(e=a.length;e--;)GLEGO.Shaders.getGeometry(b[r]).setAttributesAndElementsFor(a[e]);U=new GLEGO.Camera({useTarget:!1,ortho:{right:4.2,left:-4.2,top:-4.2,bottom:4.2}});R=(new GLEGO.Object3D).applyShader("ExplorePegGLSL","peg",{uProjection:U.projection,uInverse:U.inverse,
uObjectPosition:new GLOW.Vector3,uColorIndex:new GLOW.Float(0)});Z=GLEGO.Shaders.getShader("ExplorePegUnwrapGLSL");Z.uniforms.uPegAndSidesFBO.data=l;d=GLEGO.Shaders.getShader("ExploreBrickGLSL");d.uniforms.uPegAndSidesFBO.data=f;I=GLEGO.Shaders.getShader("ExploreGroundColorGLSL");I.uniforms.uPegAndSidesFBO.data=f;u=GLEGO.Shaders.getShader("ExploreLightGLSL");this.initialized.dispatch()};F.prototype.setCommonUniformsOn=function(a){var b=GLEGO.Shaders.getShader(a);a=GLEGO.Shaders.getTexture("ExploreColorTexture");
var f=GLEGO.Shaders.getTexture("ExploreWipeTexture"),d=function(a,c){b.uniforms[a]&&(b.uniforms[a].data=c)};d("uProjection",h.projection);d("uInverse",h.inverse);d("uAmbientColor",g.color);d("uNearAndFar",G);d("uFogNearAndFar",z.nearAndFar);d("uFogColor",z.color);d("uColorMap",a);d("uLightMap",c);d("uWipeTexture",f);r.length&&(d("uDirLightDirections",A),d("uDirLightColors",M),d("uDirLightIntensities",Y));b.attachData()};F.prototype.render=function(){var q,p,k,G,g,v,t;this.beforeRendering.dispatch();
h.update();b.clear();b.cache.clear();B.extractFromMatrix4(h.inverse);q=0;for(p=r.length;q<p;q++)N.copy(r[q].direction),B.multiplyVector3(N),A.value[3*q+0]=N.value[0],A.value[3*q+1]=N.value[1],A.value[3*q+2]=N.value[2];k=d.uniforms.uBrickNormalUVs.data.value;q=0;for(p=6;q<p;q++)N.copy(x[q]),B.multiplyVector3(N),k[2*q+0]=0.47*N.value[0]+0.5,k[2*q+1]=0.47*N.value[1]+0.5;c.bind();u.draw();c.unbind(!1);GLEGO.Shaders.getShader("ExplorePegGLSL").uInverseRotation.extractFromMatrix4(h.inverse);GL.colorMask(!1,
!1,!0,!0);l.bind();l.clear();U.inverse.copy(h.inverse);U.inverse.setPosition(0,0,-50);R.draw();l.unbind(!1);f.bind(!1);Z.draw();f.unbind();GL.colorMask(!0,!0,!0,!0);this.computeFrustum();for(q=e.length;q--;)k=e[q],k.visible&&this.insideFrustum(k)&&k.draw();GLEGO.Shaders.getShader("ExploreSpecialObjectGLSL").uInverseRotation.extractFromMatrix4(h.inverse);GLEGO.Shaders.getShader("ExploreSpecialObjectTwoColorsGLSL").uInverseRotation.extractFromMatrix4(h.inverse);for(p=LDF.brickTypes.array.length;p--;)for(q=
e.length;q--;)if(k=e[q],k.visible&&k.insideFrustum&&void 0!==k.specialObjects[p]){G=k.specialObjects[p];for(k=G.length;k--;)G[k].draw()}if(q=s.length)for(q=s.length;q--;)k=s[q],k.visible&&this.insideFrustum(k)&&k.draw();for(q=y.length;q--;)y[q].draw();p=LDF.brickTypes.array.length;for(m.length=0;p--;)for(q=e.length;q--;)if(k=e[q],k.visible&&k.insideFrustum&&void 0!==k.transparentObjects[p]){g=k.transparentObjects[p];for(k=g.length;k--;)G=g[k],v=G.uPosition.value,t=G.uObjectPosition.value,H.set(v[0]+
t[0],v[1]+t[1],v[2]+t[2],1),G.screenZ=h.inverse.multiplyVector4(H).value[3],m.push(G)}if(0<m.length){m.sort(a);GL.enable(GL.BLEND);GL.blendEquationSeparate(GL.FUNC_ADD,GL.FUNC_ADD);GL.blendFuncSeparate(GL.ONE,GL.ONE_MINUS_SRC_ALPHA,GL.ONE,GL.ONE_MINUS_SRC_ALPHA);for(p=m.length;p--;)m[p].draw();GL.disable(GL.BLEND)}this.afterRendering.dispatch()};F.prototype.computeFrustum=function(){k.multiply(h.projection,h.inverse);var a=k.value;w[0].set(a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]);w[1].set(a[3]+
a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]);w[2].set(a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]);w[3].set(a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]);w[4].set(a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]);w[5].set(a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]);for(a=6;a--;)w[a].divideScalar(w[a].lengthOfXYZ())};F.prototype.insideFrustum=function(a){v.copy(a.position).addSelf(t);for(var b=v.value,c=2*-LDF.buildBasePlateHalfSizeLU*LDF.LU.x,f,d=6;d--;)if(f=w[d].value,f[0]*b[0]+f[1]*b[1]+f[2]*b[2]+f[3]<=c)return a.insideFrustum=
!1;return a.insideFrustum=!0};F.prototype.resize=function(a,c){b.resize(a,c);h.resize(a,c)};F.prototype.addObject=function(a){a instanceof GLEGO.ExploreObject?-1===e.indexOf(a)&&(e[e.length]=a):a instanceof GLEGO.ExploreGround?-1===y.indexOf(a)&&(y[y.length]=a):-1===s.indexOf(a)&&s.push(a)};F.prototype.removeObject=function(a){a instanceof GLEGO.ExploreObject?(a=e.indexOf(a),-1!==a&&e.splice(a,1)):a instanceof GLEGO.ExploreGround?(a=y.indexOf(a),-1!==a&&y.splice(a,1)):(a=s.indexOf(a),-1!==a&&s.splice(a,
1))};F.prototype.getExploreObjectAtPosition=function(a,b){var c,f,d,k;GFBO.bind();GL.clearColor(0,0,0,0);GL.clearDepth(1);GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT);c=e.length;for(f=1;c--;)d=e[c],d.visible&&d.insideFrustum&&(d.bricksId.uniforms.uID.data.set(((f&16711680)>>16)/255,((f&65280)>>8)/255,(f&255)/255,1),d.bricksId.draw()),f++;c=e.length;for(f=1;c--;){d=e[c];if(d.visible&&d.insideFrustum){d=d.specialObjectsId;for(k=d.length;k--;)d[k].draw()}f++}c=new Uint8Array(4);GL.readPixels(a,
GFBO.height-b,1,1,GL.RGBA,GL.UNSIGNED_BYTE,c);GFBO.unbind();f=c[0]<<16|c[1]<<8||c[2];if(0!==f)return f--,e[f]};F.prototype.getDomElement=function(){return b.domElement};F.prototype.getCamera=function(){return h};F.prototype.getLights=function(){return lights};F.prototype.getAmbient=function(){return g};F.prototype.showDatGUI=function(a){var b=this;void 0===a?C=new dat.GUI:(C=new dat.GUI({autoPlace:!1}),a.appendChild(C.domElement));a=function(a,c,f,d){b.datGUIValues[a]=c;C.add(b.datGUIValues,a,f,d).onChange(function(c){b.updateDatGUI(a,
c)})};for(var c=function(a,c){b.datGUIValues[a]=c;C.addColor(b.datGUIValues,a).onChange(function(c){b.updateDatGUI(a,c)})},f=0;f<r.length;f++)c("L"+f+"_Color",[255*r[f].color.value[0],255*r[f].color.value[1],255*r[f].color.value[2]]),a("L"+f+"_Intensity",r[f].intensity,0,2),a("L"+f+"_DirectionX",r[f].direction.value[0],-1,1),a("L"+f+"_DirectionY",r[f].direction.value[1],-1,1),a("L"+f+"_DirectionZ",r[f].direction.value[2],-1,1);c("AmbientColor",[255*g.color.value[0],255*g.color.value[1],255*g.color.value[2]]);
c("FogColor",[255*z.color.value[0],255*z.color.value[1],255*z.color.value[2]]);a("FogNear",z.nearAndFar.value[0],0,5E3);a("FogFar",z.nearAndFar.value[1],0,5E3);C.remember(this.datGUIValues);return C};F.prototype.updateDatGUI=function(a,b){switch(a){case "VignetteOffset":postShader.uniforms.uVignette.data.value[0]=b;break;case "VignetteFactor":postShader.uniforms.uVignette.data.value[1]=b;break;case "BrigthnessOffset":postShader.uniforms.uBrightness.data.value[0]=b;break;case "BrigthnessFactor":postShader.uniforms.uBrightness.data.value[1]=
b;break;case "ContrastOffset":postShader.uniforms.uContrast.data.value[0]=b;break;case "ContrastFactor":postShader.uniforms.uContrast.data.value[1]=b;break;case "SaturationOffset":postShader.uniforms.uSaturation.data.value[0]=b;break;case "SaturationFactor":postShader.uniforms.uSaturation.data.value[1]=b;break;case "BlurStart":postShader.uniforms.uBlur.data.value[0]=b;break;case "BlurEnd":postShader.uniforms.uBlur.data.value[1]=b;break;case "BlurAmount":postShader.uniforms.uBlur.data.value[2]=b;break;
case "PegAttenuationStart":I.uniforms.uPegAttenuation.data.value[0]=b;break;case "PegAttenuationEnd":I.uniforms.uPegAttenuation.data.value[1]=b;break;case "PegAttenuationFactor":I.uniforms.uPegAttenuation.data.value[2]=b;break;case "AmbientColor":g.color.value[0]=b[0]/255;g.color.value[1]=b[1]/255;g.color.value[2]=b[2]/255;break;case "FogColor":z.color.value[0]=b[0]/255;z.color.value[1]=b[1]/255;z.color.value[2]=b[2]/255;break;case "FogNear":z.nearAndFar.value[0]=b;break;case "FogFar":z.nearAndFar.value[1]=
b}if(0===a.indexOf("L")){var c=parseInt(a.slice(1,2),10);a=a.slice(3);switch(a){case "Color":r[c].color.value[0]=b[0]/255;r[c].color.value[1]=b[1]/255;r[c].color.value[2]=b[2]/255;break;case "Intensity":r[c].intensity=b;break;case "DirectionX":r[c].direction.value[0]=b;break;case "DirectionY":r[c].direction.value[1]=b;break;case "DirectionZ":r[c].direction.value[2]=b}r[c].direction.normalize();this.updateLights()}};return F}();GLEGO.Shaders=function(){function a(){this.loaded=new signals.Signal;this.shaders={};this.textures={};this.geometries={};this.buildShaderPrefix()}var b=new GLOW.Matrix3,c={explorebrickglsl:{primitives:4,data:{uProjection:void 0,uInverse:void 0,uNearAndFar:void 0,uPosition:void 0,uBrickVertices:LDF.brickVertices,uBrickUVs:LDF.brickUVs,uBrickSize:LDF.LUF,uBrickNormalUVs:new GLOW.Float(Array(12)),uBrickPegAndSidesChannelMask:LDF.brickPegAndSidesChannelMask,uPegAndSidesFBO:void 0,aBrickData:void 0}},
explorebrickidglsl:{primitives:4,data:{uProjection:void 0,uInverse:void 0,uPosition:void 0,uID:void 0,uBrickVertices:LDF.brickVertices,uBrickSize:LDF.LUF,aBrickData:void 0}},explorepostglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{aVertices:GLOW.Geometry.Plane.vertices(),uViewport:void 0,uLightMap:void 0,uColorMap:void 0,uGFBO:void 0,uVignette:new GLOW.Vector2(0.2,0.3),uBrightness:new GLOW.Vector2(0.8,0.2),uSaturation:new GLOW.Vector2(0.7,0.3),uContrast:new GLOW.Vector2(0.8,0.4),
uBlur:new GLOW.Vector3(0.35,0.7,1.4),uVO:new GLOW.Float(1)}},explorelightglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{aVertices:GLOW.Geometry.Plane.vertices(),uDirLightDirections:void 0,uDirLightColors:void 0,uDirLightIntensities:void 0,uAmbientColor:void 0,uCameraInverse:new GLOW.Matrix3}},explorepegglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:new GLOW.Matrix3,uNearAndFar:void 0,uPosition:void 0,uObjectPosition:void 0,uColorIndex:void 0,
aVertices:void 0,aNormals:void 0},interleave:{aVertices:!1,aNormals:!1}},explorespecialobjectglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:new GLOW.Matrix3,uNearAndFar:void 0,uPosition:void 0,uObjectPosition:void 0,uColorIndex:void 0,uAlpha:void 0,aVertices:void 0,aNormals:void 0},interleave:{aVertices:!1,aNormals:!1}},explorespecialobjecttwocolorsglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:new GLOW.Matrix3,
uNearAndFar:void 0,uPosition:void 0,uObjectPosition:void 0,uColorIndices:void 0,uAlpha:void 0,aVertices:void 0,aNormals:void 0},interleave:{aVertices:!1,aNormals:!1,aVertexColors:!1}},explorepegunwrapglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{uInverse:void 0,aVertices:GLOW.Geometry.Plane.vertices(),aUVs:GLOW.Geometry.Plane.uvs(),uPegAndSidesFBO:void 0}},exploregroundglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{uInverse:void 0,aVertices:GLOW.Geometry.Plane.vertices(LDF.LU.x,
!0),aUVs:GLOW.Geometry.Plane.uvs(!0),uPegAndSidesFBO:void 0,uUpNormal:new GLOW.Vector2,uTexture:void 0,uSize:void 0,uNearAndFar:void 0,uPegAttenuation:new GLOW.Vector3(0.3,0.7,0.7)}},exploregroundcolorglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{uInverse:void 0,aVertices:GLOW.Geometry.Plane.vertices(LDF.LU.x,!0),aUVs:GLOW.Geometry.Plane.uvs(!0),uPegAndSidesFBO:void 0,uTexture:void 0,uWipeTexture:void 0,uSize:void 0,uBrightnessSaturationContrast:void 0,uBaseColor:void 0}},exploreexpandcolorglsl:{indices:GLOW.Geometry.Plane.indices(),
primitives:4,data:{aVertices:GLOW.Geometry.Plane.vertices(),uViewport:void 0,uColorMap:void 0,uGFBO:void 0}},exploreexpandnormalglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{aVertices:GLOW.Geometry.Plane.vertices(),uViewport:void 0,uGFBO:void 0}},exploreexpanddepthpositionglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{aVertices:GLOW.Geometry.Plane.vertices(),uViewport:void 0,uGFBO:void 0}},buildobjectglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,
uInverseRotation:b,uDirLightDirections:void 0,uDirLightColors:void 0,uDirLightIntensities:void 0,uPointLightPositions:void 0,uPointLightRanges:void 0,uPointLightColors:void 0,uPointLightIntensities:void 0,uAmbientColor:void 0,uPosition:void 0,uColor:void 0,aVertices:void 0,aNormals:void 0},interleave:{aVertices:!1,aNormals:!1}},buildobjectmatrixtransformglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:b,uDirLightDirections:void 0,uDirLightColors:void 0,uDirLightIntensities:void 0,
uPointLightPositions:void 0,uPointLightRanges:void 0,uPointLightColors:void 0,uPointLightIntensities:void 0,uAmbientColor:void 0,uMatrix:void 0,uColor:void 0,aVertices:void 0,aNormals:void 0},interleave:{aVertices:!1,aNormals:!1}},buildobjecttwocolorsglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:b,uDirLightDirections:void 0,uDirLightColors:void 0,uDirLightIntensities:void 0,uPointLightPositions:void 0,uPointLightRanges:void 0,uPointLightColors:void 0,
uPointLightIntensities:void 0,uAmbientColor:void 0,uPosition:void 0,uColor:void 0,aVertices:void 0,aNormals:void 0,aVertexColors:void 0},interleave:{aVertices:!1,aNormals:!1,aVertexColors:!1}},buildobjecttwocolorsmatrixtransformglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:b,uDirLightDirections:void 0,uDirLightColors:void 0,uDirLightIntensities:void 0,uPointLightPositions:void 0,uPointLightRanges:void 0,uPointLightColors:void 0,uPointLightIntensities:void 0,
uAmbientColor:void 0,uMatrix:void 0,uColor:void 0,aVertices:void 0,aNormals:void 0,aVertexColors:void 0},interleave:{aVertices:!1,aNormals:!1,aVertexColors:!1}},buildbaseplateglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uInverseRotation:b,uDirLightDirections:void 0,uDirLightColors:void 0,uDirLightIntensities:void 0,uPointLightPositions:void 0,uPointLightRanges:void 0,uPointLightColors:void 0,uPointLightIntensities:void 0,uAmbientColor:void 0,uPosition:void 0,uTexture:void 0,
aVertices:void 0,aNormals:void 0,aUVs:void 0},interleave:{aVertices:!1,aNormals:!1,aUVs:!1}},buildpostglsl:{indices:GLOW.Geometry.Plane.indices(),primitives:4,data:{aVertices:GLOW.Geometry.Plane.vertices(),uViewport:void 0,uGFBO:void 0}},textureunlitglsl:{indices:void 0,primitives:4,data:{uProjection:void 0,uInverse:void 0,uPosition:void 0,uTexture:void 0,aVertices:void 0,aUVs:void 0},interleave:{aVertices:!1,aUVs:!1}}},e={explorecolortexture:{wrap:33071,filter:9728},buildbaseplateshadowtexture:{wrap:33071},
buildenvironmenttexture:{isCubeMap:!0,wrap:10497,filter:9729},explorewipetexture:{wrap:33071,filter:9728}},y=!1,s,m="",h=0,g=0,z={};a.prototype.load=function(a){if(y)console.error("GLEGO.Shaders.load: Not possible to load more than one batch at the time!"),this.loaded.dispatch();else{s=a;var b=s.shaders,e=s.textures,h=s.geometry,g=!1,u={onLoadComplete:this.onLoad,onLoadContext:this},d,m;if(b)for(d=b.length;d--;)if(m=b[d].toLowerCase(),void 0===this.shaders[m])if(void 0!==LDF.getURL(m)&&void 0!==c[m])u[m]=
LDF.getURL(m),g=!0;else{console.error("GLEGO.Shaders.load: missing URL or shader config for "+m);return}if(e)for(d=e.length;d--;)m=e[d].toLowerCase(),void 0===this.textures[m]&&void 0!==LDF.getURL(m)&&(u[m]=LDF.getURL(m),g=!0);if(h)for(d=h.length;d--;)m=h[d].toLowerCase(),void 0===this.geometries[m]&&(u[m]=LDF.getURL(m),g=!0);g?(s=a,y=!0,new GLOW.Load(u)):(s=void 0,y=!1,this.loaded.dispatch())}};a.prototype.onLoad=function(a){var b=s.shaders,h=s.textures,g=s.geometry,z,u,d,I,l;if(b)for(z=b.length;z--;)u=
b[z].toLowerCase(),void 0!==c[u]?(c[u].vertexShader=m+a[u].vertexShader,c[u].fragmentShader=m+a[u].fragmentShader,this.shaders[u]=new GLOW.Shader(c[u])):GLOW.warn("Shaders.onLoad: missing shader config for "+u);if(h)for(z=h.length;z--;)u=h[z].toLowerCase(),void 0!==e[u]?(e[u].data=e[u].isCubeMap?{posX:a[u],negX:a[u],posY:a[u],negY:a[u],posZ:a[u],negZ:a[u]}:a[u],this.textures[u]=new GLOW.Texture(e[u]),this.textures[u].init()):this.textures[u]=new GLOW.Texture({data:a[u]});var f=[];if(g)for(z=g.length;z--;)for(d in u=
g[z].toLowerCase(),a[u])if(f.push(d),this.geometries[d]=new GLEGO.Geometry(a[u][d]),(l=LDF.brickTypes.rotationsOf[d])&&l.length)for(I=l.length;I--;){f.push(l[I]);var U=this.geometries,R=l[I],Z=GLEGO.Geometry,N=LDF.brickTypes[l[I]],B=a[u][d],x={aVertices:!0,aNormals:!0},w=void 0,k=void 0,v=void 0,t=void 0,N=(new GLOW.Matrix4).setRotation(0,N.radians,0),C=new GLOW.Vector3,H={};for(w in B)H[w]=x[w]?Array(B[w].length):B[w];for(w in x){k=B[w];v=H[w];for(t=k.length;0<t;)t-=3,C.set(k[t+0],k[t+1],k[t+2]),
N.multiplyVector3(C),v[t+0]=C.value[0],v[t+1]=C.value[1],v[t+2]=C.value[2]}U[R]=new Z(H)}y=!1;s=void 0;this.loaded.dispatch(b,f,h)};a.prototype.getShader=function(a){a=a.toLowerCase();if(void 0!==this.shaders[a])return this.shaders[a]};a.prototype.getTexture=function(a){a=a.toLowerCase();if(void 0!==this.textures[a])return this.textures[a]};a.prototype.getGeometry=function(a){a=a.toLowerCase();if(void 0!==this.geometries[a])return this.geometries[a]};a.prototype.applySharedUniform=function(a,b){var c=
"shaderId"+a.program.id;if(void 0!==z[c])for(var e=z[c],h=e.length,g,d,m,l;h--;){if(b&&e[h]&&b.locationNumber===e[h].locationNumber){g=b.data.value;d=e[h].data.value;m=g.length;for(l=!0;m--;)if(g[m]!==d[m]){l=!1;break}if(l){g=a.compiledData.uniformArray;for(c=g.length;c--;)if(g[c].locationNumber===b.locationNumber){g[c]=e[h];break}a.uniforms[b.name]=e[h];a[b.name]=e[h].data;return b}}}else z[c]=[];z[c].push(b);return b};a.prototype.applyUniqueUniform=function(a,b){for(var c=a.compiledData.uniformArray,
e=c.length;e--;)if(c[e].locationNumber===b.locationNumber){c[e]=b;break}a.uniforms[b.name]=b;a[b.name]=b.data};a.prototype.setNumberOfDirectionalLights=function(a){h=a;this.buildShaderPrefix()};a.prototype.setNumberOfPointLights=function(a){g=a;this.buildShaderPrefix()};a.prototype.buildShaderPrefix=function(){m="#define NUM_DIR_LIGHTS "+h+"\n#define NUM_POINT_LIGHTS "+g+"\n"};a.prototype.buildExploreColorTexture=function(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=b.createImageData(256,
10),h=c.data,g=LDF.colors.array,m,d,s,l;d=0;for(l=g.length;d<l;d++)if(m=g[d]){s=4*m.index;for(var f=0;10>f;f++)h[s+0+1024*f]=255*m.value[0],h[s+1+1024*f]=255*m.value[1],h[s+2+1024*f]=255*m.value[2],h[s+3+1024*f]=255}a.width=256;a.height=10;b.putImageData(c,0,0);e.explorecolortexture.data=a;this.textures.explorecolortexture=new GLOW.Texture(e.explorecolortexture);this.textures.explorecolortexture.init()};return new a}();GLEGO.BuildBasePlate=function(){function a(a,c){GLEGO.Object3D.call(this);this.applyShader("BuildBasePlateGLSL",a,{uTexture:new GLOW.Texture({data:c,filter:GL.NEAREST,wrap:GL.CLAMP_TO_EDGE})});this.type=LDF.getBrickType(a);this.color=LDF.getColor("white");this.lowerBound=this.type.AABB.lowerBound;this.upperBound=this.type.AABB.upperBound;this.removeFromRenderQueue=new signals.Signal;this.addToRenderQueue=new signals.Signal}a.prototype=new GLEGO.Object3D;a.prototype.constructor=GLEGO.BuildBasePlate;
a.prototype.draw=function(){this.shader.draw()};return a}();GLEGO.BuildObject=function(){function a(a,b,y){GLEGO.Object3D.call(this);this.rotation=new GLOW.Vector3;this.scale=new GLOW.Vector3(1,1,1);this.matrix=new GLOW.Matrix4;this.rotationMatrix=new GLOW.Matrix3;this.type=LDF.getBrickType(a);this.color=LDF.getColor(b);this.opacity=new GLOW.Float(y||this.type.transparent?0.75:1);this.screenZ=0;this.type.multipleColors?(b=LDF.getColor("white"),this.bothColors=new GLOW.Float([this.color.value[0],this.color.value[1],this.color.value[2],b.value[0],b.value[1],
b.value[2]]),this.applyShader("BuildObjectTwoColorsMatrixTransformGLSL",a,{uColors:this.bothColors,uOpacity:this.opacity,uMatrix:this.matrix,uRotationMatrix:this.rotationMatrix}),this.shaderMatrix=this.shader,this.applyShader("BuildObjectTwoColorsGLSL",a,{uColors:this.bothColors,uOpacity:this.opacity})):(this.applyShader("BuildObjectMatrixTransformGLSL",a,{uColor:this.color,uOpacity:this.opacity,uMatrix:this.matrix,uRotationMatrix:this.rotationMatrix}),this.shaderMatrix=this.shader,this.applyShader("BuildObjectGLSL",
a,{uColor:this.color,uOpacity:this.opacity}));this.shaderPosition=this.shader;this.unfreeze();this.lowerBound=this.type.AABB.lowerBound;this.upperBound=this.type.AABB.upperBound;this.removeFromRenderQueue=new signals.Signal;this.addToRenderQueue=new signals.Signal}var b=new GLOW.Vector3;a.prototype=new GLEGO.Object3D;a.prototype.constructor=GLEGO.BuildObject;a.prototype.freeze=function(){this.shader=this.shaderPosition};a.prototype.unfreeze=function(){this.shader=this.shaderMatrix};a.prototype.changeColor=
function(a){this.removeFromRenderQueue.dispatch(this);this.type.multipleColors?(a=LDF.getColor(a),this.shaderPosition.uniforms.uColors.data.value[0]=a.value[0],this.shaderPosition.uniforms.uColors.data.value[1]=a.value[1],this.shaderPosition.uniforms.uColors.data.value[2]=a.value[2],this.shaderMatrix.uniforms.uColors.data.value[0]=a.value[0],this.shaderMatrix.uniforms.uColors.data.value[1]=a.value[1],this.shaderMatrix.uniforms.uColors.data.value[2]=a.value[2]):this.color=LDF.getColor(a);this.addToRenderQueue.dispatch(this)};
a.prototype.changeOpacity=function(a){this.removeFromRenderQueue.dispatch(this);this.opacity.set(a);this.addToRenderQueue.dispatch(this)};a.prototype.calculateScreenZ=function(){this.screenZ=this.shader===this.shaderMatrix?this.shader.uInverse.multiplyVector3(this.matrix.getPosition()).value[2]:this.shader.uInverse.multiplyVector3(b.copy(this.position)).value[2]};a.prototype.draw=function(){this.shader===this.shaderMatrix&&(this.matrix.setRotation(this.rotation),this.rotationMatrix.extractFromMatrix4(this.matrix),
this.matrix.scale(this.scale),this.matrix.setPosition(this.position));this.shader.draw()};return a}();GLEGO.BuildRenderer=function(){function a(a,b){return a.screenZ<b.screenZ?1:a.screenZ>b.screenZ?-1:0}for(var b,c,e,y,s,m,h,g,z,G,r,A,M,Y,u=Array(LDF.brickTypes.array.length),d=0;d<u.length;d++){u[d]=Array(LDF.colors.array.length);for(var I=0;I<u[d].length;I++)u[d][I]=[]}var l=[],d=function(a){this.initialized=new signals.Signal;this.beforeRendering=new signals.Signal;this.afterRendering=new signals.Signal;this.resized=new signals.Signal};d.prototype.init=function(a){if(void 0===a)console.error("GLEGO.BuildRenderer.init: I need parameters!");
else{b=new GLOW.Context(a.context);b.setupBlend({equationRGB:GL.FUNC_ADD,equationAlpha:GL.FUNC_ADD,srcRGB:GL.ONE,dstRGB:GL.ONE_MINUS_SRC_ALPHA,srcAlpha:GL.ONE,dstAlpha:GL.ONE_MINUS_SRC_ALPHA});c=new GLEGO.Camera(a.camera);y=new GLEGO.Fog(a.fog);e=new GLEGO.Ambient(a.ambient);s=new GLOW.Vector2(b.width,b.height);this.setupLights(a.pointLights,a.directionalLights);GLEGO.Shaders.setNumberOfDirectionalLights(m.length);GLEGO.Shaders.setNumberOfPointLights(G.length);a.load=a.load||{};a.load.shaders=a.load.shaders||
[];a.load.geometry=a.load.geometry||[];a.load.textures=a.load.textures||[];var d=function(b,c){-1===a.load[b].indexOf(c)&&a.load[b].push(c)};d("shaders","BuildObjectGLSL");d("shaders","BuildObjectMatrixTransformGLSL");d("shaders","BuildObjectTwoColorsGLSL");d("shaders","BuildObjectTwoColorsMatrixTransformGLSL");d("shaders","BuildBasePlateGLSL");d("geometry","BrickGeometry");GLEGO.Shaders.loaded.addOnce(this.shadersGeometryAndTexturesLoaded,this);GLEGO.Shaders.load(a.load)}};d.prototype.setupLights=
function(a,b){if(a){G=Array(a.length);r=new GLOW.Float(Array(3*a.length));A=new GLOW.Float(Array(3*a.length));M=new GLOW.Float(Array(1*a.length));Y=new GLOW.Float(Array(1*a.length));for(var c=a.length;c--;)G[c]=new GLEGO.PointLight(a[c])}else G=[];if(b){m=Array(b.length);h=new GLOW.Float(Array(3*b.length));g=new GLOW.Float(Array(3*b.length));z=new GLOW.Float(Array(1*b.length));for(c=b.length;c--;)m[c]=new GLEGO.DirectionalLight(b[c])}else m=[];this.updateLights()};d.prototype.updateLights=function(){for(var a=
G.length;a--;)r.value[3*a+0]=G[a].position.value[0],r.value[3*a+1]=G[a].position.value[1],r.value[3*a+2]=G[a].position.value[2],A.value[3*a+0]=G[a].color.value[0],A.value[3*a+1]=G[a].color.value[1],A.value[3*a+2]=G[a].color.value[2],M.value[a]=G[a].intensity,Y.value[a]=G[a].range;for(a=m.length;a--;)h.value[3*a+0]=m[a].direction.value[0],h.value[3*a+1]=m[a].direction.value[1],h.value[3*a+2]=m[a].direction.value[2],g.value[3*a+0]=m[a].color.value[0],g.value[3*a+1]=m[a].color.value[1],g.value[3*a+2]=
m[a].color.value[2],z.value[a]=m[a].intensity};d.prototype.shadersGeometryAndTexturesLoaded=function(a,b,c){var d;for(d=a.length;d--;)this.setCommonUniformsOn(a[d],c);for(c=b.length;c--;)for(d=a.length;d--;)GLEGO.Shaders.getGeometry(b[c]).setAttributesAndElementsFor(a[d]);this.initialized.dispatch()};d.prototype.setCommonUniformsOn=function(a,b){var d=GLEGO.Shaders.getShader(a),l=function(a,b){d.uniforms[a]&&(d.uniforms[a].data=b)};l("uProjection",c.projection);l("uInverse",c.inverse);l("uAmbientColor",
e.color);l("uViewport",s);l("uFogColor",y.color);l("uFogNearAndFar",y.nearAndFar);m.length&&(l("uDirLightDirections",h),l("uDirLightColors",g),l("uDirLightIntensities",z));G.length&&(l("uPointLightPositions",r),l("uPointLightRanges",Y),l("uPointLightColors",A),l("uPointLightIntensities",M));d.attachData()};d.prototype.addObject=function(a){a.type&&a.color&&(void 0===a.opacity||0.99<a.opacity.value[0])?-1===u[a.type.index][a.color.index].indexOf(a)&&u[a.type.index][a.color.index].push(a):-1===l.indexOf(a)&&
l.push(a);void 0!==a.removeFromRenderQueue&&a.removeFromRenderQueue.addOnce(this.removeObject,this)};d.prototype.removeObject=function(a){var b;a.type&&a.color?(b=u[a.type.index][a.color.index].indexOf(a),-1!==b?u[a.type.index][a.color.index].splice(b,1):(b=l.indexOf(a),-1!==b&&l.splice(b,1))):(b=l.indexOf(a),-1!==b&&l.splice(b,1));a.addToRenderQueue.addOnce(this.addObject,this)};d.prototype.render=function(){var d=u.length,e,h=u[0].length,g,r;this.beforeRendering.dispatch();b.cache.clear();b.setViewport();
b.clear();for(c.update();d--;)for(e=h;e--;){g=u[d][e];for(r=g.length;r--;)g[r].visible&&g[r].draw()}if(0<l.length){b.enableBlend(!0);for(d=l.length;d--;)l[d].visible&&l[d].calculateScreenZ();l.sort(a);for(d=l.length;d--;)l[d].visible&&l[d].draw();b.enableBlend(!1)}this.afterRendering.dispatch()};d.prototype.insideFrustum=function(a){return a.insideFrustum=!0};d.prototype.resize=function(a,d){b.resize(a,d);c.resize(a,d);s.set(a,d)};d.prototype.getDomElement=function(){return b.domElement};d.prototype.getCamera=
function(){return c};d.prototype.getDirectionalLights=function(){return m};d.prototype.getPointLights=function(){return G};d.prototype.getAmbient=function(){return e};d.prototype.getDatGUI=function(){};return d}();GLEGO.AABB=function(){return function(a,b,c,e,y,s,m){this.position=new GLOW.Vector3(a||0,b||0,c||0);this.lowerBound=new GLOW.Vector3(0.5*-e||-100,0.5*-y||-100,0.5*-s||-100);this.upperBound=new GLOW.Vector3(0.5*e||100,0.5*y||100,0.5*s||100);this.reference=m}}();
GLEGO.Ray=function(){function a(a,b,c,m,h,g){this.position=new GLOW.Vector3(a||0,b||0,c||0);this.direction=new GLOW.Vector3(m||0,h||0,g||0)}var b=new GLOW.Matrix4,c=new GLOW.Matrix4;a.prototype.setFromMouse=function(a,y,s){this.position.set(a,-y,1);b.copy(s.matrix);b.multiplySelf(GLOW.Matrix4.makeInverse(s.projection,c));b.multiplyVector3(this.position);this.direction.copy(this.position);this.direction.subSelf(s.matrix.getPosition());return this};return a}();
GLEGO.Collider=function(){function a(){this.AABBs=[]}var b=0,c=0,e=0,y=0,s=0,m=0,h=new GLOW.Vector3,g={didHit:!1,point:new GLOW.Vector3,localPoint:new GLOW.Vector3,normal:new GLOW.Vector3,reference:void 0},z=[new GLOW.Vector3(1,0,0),new GLOW.Vector3(-1,0,0),new GLOW.Vector3(0,1,0),new GLOW.Vector3(0,-1,0),new GLOW.Vector3(0,0,1),new GLOW.Vector3(0,0,-1)],G=new GLOW.Vector3;a.prototype.addObject=function(a){-1===this.AABBs.indexOf(a)&&this.AABBs.push(a)};a.prototype.removeObject=function(a){a=this.AABBs.indexOf(a);
-1!==a&&this.AABBs.splice(a,1)};a.prototype.shoot=function(a){a.direction.normalize();b=1/(a.direction.value[0]||Number.MIN_VALUE);c=1/(a.direction.value[1]||Number.MIN_VALUE);e=1/(a.direction.value[2]||Number.MIN_VALUE);y=a.position.value[0];s=a.position.value[1];m=a.position.value[2];for(var A=this.AABBs.length,M=void 0,Y=Number.MAX_VALUE,u=0;A--;){var d;var I=this.AABBs[A];d=(I.lowerBound.value[0]+I.position.value[0]-y)*b;var l=(I.upperBound.value[0]+I.position.value[0]-y)*b,f=(I.lowerBound.value[1]+
I.position.value[1]-s)*c,U=(I.upperBound.value[1]+I.position.value[1]-s)*c,R=(I.lowerBound.value[2]+I.position.value[2]-m)*e,Z=(I.upperBound.value[2]+I.position.value[2]-m)*e,I=Math.max(Math.max(Math.min(d,l),Math.min(f,U)),Math.min(R,Z));d=Math.min(Math.min(Math.max(d,l),Math.max(f,U)),Math.max(R,Z));d=0>d||I>d?0:I;if((u=d)&&u<Y)Y=u,M=this.AABBs[A]}if(void 0!==M){A=M;a=h.copy(a.direction).multiplyScalar(Y).addSelf(a.position);for(u=z.length;u--;)Y=z[u],M=G.copy(A.upperBound).multiplySelf(Y).addSelf(A.position).subSelf(a).dot(Y),
0===Math.floor(Math.abs(M))&&(g.didHit=!0,g.reference=A.reference||A,g.normal.copy(Y),g.point.copy(a),g.localPoint.copy(a).subSelf(A.position))}else g.didHit=!1;return g};a.prototype.getLatestResult=function(){return g};return a}();var Builder=function(){var a={},b,c,e,y,s=new GLOW.Vector3(0,0,0),m=1.35,h=m,g=330,z=g,G=0,r,A,M=!1,Y=!0,u,d,I=0,l=0,f=0,U=0,R=!1,Z=!1,N=0,B=1,x=1,w=1,k="red",v="red",t=!1,C=!1,H,F=1,q=[],p=0,ea=null,P=null,O=0,K=new GLOW.Vector3(0,200,0),wa=new GLOW.Vector3(0,200,0),T=new GLOW.Vector3,ja,X,ba,S,Q,aa,V=0,L=null,J=null,W=null,ka=null,da=[],ga=0,ha=0,na=0,ma=!1,ia="blue red orange yellow green 212 321".split(" "),Ba=null,la=0,xa=!1,Aa,Da,ya=!1,ua,pa=!1,Ea=!1,Ia=0,Fa=0,ta,Ka=!1,Oa,La=!1,Ha=!1,Ga=0,Ja=
0,ca=0;a.error=new signals.Signal;a.colorChange=new signals.Signal;a.rotation=new signals.Signal;a.ready=new signals.Signal;a.loadReady=new signals.Signal;a.currentAngle=0;a.oldAngle=0;var ra,oa,Pa,Ma={normal:"default",point:"url(/assets/builder/pointer.png),pointer",remove:"url(/assets/builder/pointer_delete.png),pointer",no:"url(/assets/builder/pointer_no.png),pointer",hand:"url(/assets/builder/move.png),all-scroll",handdown:"url(/assets/builder/move_down.png),all-scroll"},n="normal",D=null,E={context:{width:window.innerWidth-
-200,height:window.innerHeight-60,preserveDrawingBuffer:!0,clear:{red:217/255,green:228/255,blue:232/255,alpha:1}},camera:{fov:30,near:0.1,far:3E3,aspect:(window.innerWidth- -200)/(window.innerHeight-60),useTarget:!1,useXYZStyleTransform:!1},fog:{near:5E3,far:5E3,color:new GLOW.Color(217,228,232)},ambient:new GLOW.Color(11119017),directionalLights:[{intensity:0.18,color:new GLOW.Color(14669231),direction:new GLOW.Vector3(0,-1,0)},{intensity:1.2,color:new GLOW.Color(16771737),direction:new GLOW.Vector3(-1,
-0.5,-1)}],pointLights:[{position:new GLOW.Vector3(55,500,55),range:1E3,color:new GLOW.Color(16750688),intensity:0.9},{position:new GLOW.Vector3(-55,500,-55),range:1500,color:new GLOW.Color(11593434),intensity:0.8}],load:{shaders:["TextureUnlitGLSL"],geometry:["BrickGeometry","BuildGeometry"],textures:["BuildBasePlateShadowTexture","LegoLogoTexture"]}};a.onTouchStart=function(b){ta=!1;var n=b.touches[0].target.firstChild;null!=n&&"[object HTMLCanvasElement]"==n.toString()&&(b.preventDefault(),2==
b.touches.length&&(ca+=2),3==b.touches.length&&ca++,ta=!0,pa=Ea=ya=!1,MouseX=b.touches[0].clientX-c.width/2,MouseY=b.touches[0].clientY-60-c.height/2,Ia=MouseX,Fa=MouseY,f=2*(b.touches[0].clientX/c.width)-1,U=2*((b.touches[0].clientY-60)/c.height)-1,d&&e.addObject(d),b=e.shoot(u.setFromMouse(f,U,y)),b.didHit&&(b.reference!=d?a.shootRay(!0):pa=!0),d&&e.removeObject(d))};a.onTouchMove=function(b){b.preventDefault();if(ta)if(2==b.touches.length){ya=!0;d.visible=!1;var n=b.touches[1].clientX-b.touches[0].clientX,
e=b.touches[1].clientY-b.touches[0].clientY;b=n*n+e*e;1E3<Math.abs(ua-b)?null==Ba?ua=Ba=b:ua>b?la=-0.35:ua<b&&(la=0.35):la=0;ua=b;n=Math.atan2(e,n);xa?(0.01<Math.abs(Da-(n-Aa))&&(Da>n-Aa?(e=Math.abs(n-Aa)/20,0.15<e&&(e=0.08),m+=e):(e=Math.abs(n-Aa)/20,0.15<e&&(e=0.08),m-=e)),Da=n-Aa):(Aa=n,xa=!0,Da=n)}else MouseX=b.touches[0].clientX-c.width/2,MouseY=b.touches[0].clientY-60-c.height/2,pa&&(n=MouseX-Ia,e=MouseY-Fa,200<n*n+e*e&&(pa=!1)),pa||(Ea=!0,f=2*(b.touches[0].clientX/c.width)-1,U=2*((b.touches[0].clientY-
60)/c.height)-1,ya||200<(new Date).getTime()-N&&a.shootRay()),la=0};a.findNewSpot=function(){a.shootRay()};a.onTouchEnd=function(b){ta&&(!ya&&(!Ea&&0==ca)&&(Z?1==na?(a.shootRay(),a.removeBrick(),d.visible=!1):(pa||a.findNewSpot(),a.setBrick(),d.visible=!0):d.visible=!1),ca--,0>ca&&(ca=0),N=0,xa=!1,Ba=null,la=ua=0)};a.init=function(c,d,n,e,f,D,h,g){window._browser.isWebGL()||(console.log("No support for webgl"),window.location.href="/getchrome");console.log("initiating new build on tile "+n+", "+e);
r=c;Y=!0;plateId=D;A=d;b=new GLEGO.BuildRenderer;b.initialized.addOnce(a.setup,a);b.init(E);v=g;k=utils.convertToLegacyColorIdentifier(g);a.updateUiBrickColor(k);$("#location .map img").attr("src",Builder.mapImageUrl(n,e));Ha=setInterval("Builder.save()",45E3)};a.setup=function(d){e=new GLEGO.Collider;u=new GLEGO.Ray;y=b.getCamera();aa=[];for(d=0;85>=d;++d){aa.push([]);for(var n=0;32>n;++n){aa[d].push([]);for(var f=0;32>f;++f)aa[d][n].push(0)}}a.setBrickSize(4,2,3);X=new GLEGO.BuildObject("checkplane",
"white");X.scale.set(1,0.01,1);X.position.value[0]=1E4;X.visible=!1;b.addObject(X);e.addObject(X);ja=new GLEGO.BuildBasePlate("brick_32_32_h",r);ja.position.set(0,-1.3,0);b.addObject(ja);e.addObject(ja);ba=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","shadow",{uTexture:GLEGO.Shaders.getTexture("BuildBasePlateShadowTexture")});b.addObject(ba);ba.position.set(0,-12,0);S=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","legologoplane",{uTexture:GLEGO.Shaders.getTexture("LegoLogoTexture")});
b.addObject(S);S.position.set(11*LDF.LU.x,-6.3,16*LDF.LU.z+0.2);d=document.createElement("canvas");d.width=128;d.height=64;n=d.getContext("2d");n.fillStyle="rgb(73,73,73)";n.fillRect(0,0,128,64);n.fillStyle="rgb(255, 255, 255)";9<plateId.toString().length&&(n.font="bold 16px Arial");n.font=7<plateId.toString().length?"bold 18px Arial":"bold 20px Arial";n.textAlign="center";n.fillText("No. "+plateId,64,40);f=n.createLinearGradient(0,0,0,64);f.addColorStop(0,"rgba(0, 0, 0, 0.3)");f.addColorStop(1,"rgba(0, 0, 0, 0.05)");
n.fillStyle=f;n.fillRect(0,0,128,64);Q=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","numberplane",{uTexture:new GLOW.Texture({data:d,filter:GL.LINEAR,wrap:GL.CLAMP_TO_EDGE})});b.addObject(Q);Q.position.set(13*LDF.LU.x,-6.3,16*LDF.LU.z+0.2);Y||(h=m=Math.PI/4,z=g=320);Y?(setTimeout(a.playSwishSound,150),ja.position.value[1]+=300,ja.position.y=ja.position.value[1],ja.tween=(new TWEEN.Tween(ja.position)).to({y:-0.1},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){ja.position.value[1]=
ja.position.y}).onComplete(a.addListeners),ja.tween.start(),ba.position.value[1]+=300,ba.position.y=ba.position.value[1],ba.tween=(new TWEEN.Tween(ba.position)).to({y:-12},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){ba.position.value[1]=ba.position.y}),ba.tween.start(),S.position.value[1]+=300,S.position.y=S.position.value[1],S.tween=(new TWEEN.Tween(S.position)).to({y:-6.3},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){S.position.value[1]=S.position.y}),S.tween.start(),
Q.position.value[1]+=300,Q.position.y=Q.position.value[1],Q.tween=(new TWEEN.Tween(Q.position)).to({y:-6.3},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){Q.position.value[1]=Q.position.y}),Q.tween.start()):a.addListeners();c=b.getDomElement();GLEGO.error.add(a.onError);document.getElementById("container").appendChild(b.getDomElement());requestAnimationFrame(a.render);a.ready.dispatch()};a.playSwishSound=function(){Sound.playStaticSound(Sound.swish,0.5)};a.onError=function(b){a.error.dispatch()};
a.addListeners=function(){M||(window.addEventListener("resize",a.onWindowResize,!1),document.addEventListener("contextmenu",function(a){a.preventDefault()},!1),document.addEventListener("mousemove",a.onDocumentMouseMove,!1),document.addEventListener("mousedown",a.onDocumentMouseDown,!1),document.addEventListener("mouseup",a.onDocumentMouseUp,!1),document.addEventListener("keydown",Keys.onDocumentKeyDown,!1),document.addEventListener("keyup",Keys.onDocumentKeyUp,!1),document.addEventListener("mousewheel",
a.onDocumentMouseWheel,!1),document.addEventListener("DOMMouseScroll",a.onDocumentMouseWheel,!1),document.addEventListener("touchstart",a.onTouchStart,!1),document.addEventListener("touchmove",a.onTouchMove,!1),document.addEventListener("touchend",a.onTouchEnd,!1),M=!0)};a.removeBrick=function(c){var d=V-1;0>d&&(d=0);var n=aa[d][L][J];null!=ea&&(n=ea);if(0!=n){var f=q[n];c||a.addUndo({type:"add",props:{brickw:f.props.brickw,brickd:f.props.brickd,brickh:f.props.brickh,isSloped:f.props.isSloped,rotation:f.props.rotation,
color:f.props.color,isSpecial:f.props.isSpecial,specialType:f.props.specialType,gridPositionX:f.props.gridPositionX,gridPositionY:f.props.gridPositionY,gridPositionZ:f.props.gridPositionZ}});if(null!=ea){try{if(void 0==f.props)return}catch(k){return}var D=f.props.gridPositionX-8;0>D&&(D=0);c=f.props.gridPositionX+8;32<c&&(c=32);var h=f.props.gridPositionZ-8;0>h&&(h=0);var g=f.props.gridPositionZ+8;32<g&&(g=32);d=f.props.gridPositionY}else D=L-8,0>D&&(D=0),c=L+8,32<c&&(c=32),h=J-8,0>h&&(h=0),g=J+8,
32<g&&(g=32);for(;D<c;++D)for(var m=h;m<g;++m)for(var E=d-16;E<d+16;++E)try{aa[E][D][m]==n&&(aa[E][D][m]=0)}catch(l){}d=0.2+0.2*Math.random();Sound.playStaticSound(Sound.remove,d);p-=a.getBrickValue(f.props.isSloped,f.props.isSpecial);updateBrickCount(p);b.removeObject(f);e.removeObject(f);q[n]=null;X.position.value[1]=1E4}};a.setBrick=function(c,n){var f=c||!1;if(!(3E3<=p)&&(n||(V=Math.round(d.position.value[1]/LDF.LUF.y)),!a.checkOccupied())){var D=a.checkBrickBelow();n&&(D=0);var h=L-16,g=J-16,
m=a.checkBrickAbove();if(m&&0==D||n)f=!0;var E="";ma&&(E="_t");var l;C?("window"==H&&(l=new GLEGO.BuildObject("brick_window_"+a.getType(),k)),"door"==H&&(l=new GLEGO.BuildObject("brick_door_"+a.getType(),k)),"1x1_round_open"==H&&(l=new GLEGO.BuildObject("1x1_round_open",k)),"1x1_round_straight"==H&&(l=new GLEGO.BuildObject("1x1_round_straight",k)),"1x1_round_withouttop"==H&&(l=new GLEGO.BuildObject("1x1_round_withouttop",k)),"1x4_antenna"==H&&(l=new GLEGO.BuildObject("1x4_antenna",k)),"1x4_arc"==
H&&(l=new GLEGO.BuildObject("1x4_arc_"+a.getType(),k)),"1x4_fence"==H&&(l=new GLEGO.BuildObject("1x4_fence_"+a.getType(),k)),"2x2x2_barrel"==H&&(l=new GLEGO.BuildObject("2x2x2_barrel",k)),"brick_2_1_s_inverted"==H&&(l=new GLEGO.BuildObject("brick_2_1_s_inverted_"+a.getType(),k)),"brick_2_2_s_inverted"==H&&(l=new GLEGO.BuildObject("brick_2_2_s_inverted_"+a.getType(),k)),"1x3_flagpole"==H&&(l=new GLEGO.BuildObject("1x3_flagpole_"+a.getType(),k)),"1x1_round_transparent"==H&&(l=new GLEGO.BuildObject("1x1_round_straight_t",
k)),"1x1_transparent"==H&&(l=new GLEGO.BuildObject("brick_1_1_l_t",k))):l=new GLEGO.BuildObject("brick_"+B+"_"+x+"_"+a.getType()+E,k);var E=LDF.LU.x*B/2,r=LDF.LU.z*x/2,v=V*LDF.LUF.y,s=LDF.LUF.y*w;3<w&&(s=3*LDF.LUF.y);f&&(s=0);pa?l.position.set(d.position.value[0],d.position.value[1],d.position.value[2]):l.position.set(h*LDF.LU.x+E,v+s,g*LDF.LU.z+r);v=(V-D)*LDF.LUF.y;b.addObject(l);e.addObject(l);f?l.freeze():(l.position.y=l.position.value[1],(new TWEEN.Tween(l.position)).to({y:v},200).easing(TWEEN.Easing.Sinusoidal.EaseIn).onUpdate(function(){l.position.value[1]=
l.position.y}).onComplete(function(){l.rotation.set(0,0,0);l.position.value[1]=v;l.freeze()}).start(),l.rotation.set(0.6*Math.random()-0.3,0,0.6*Math.random()-0.3),l.rotation.x=l.rotation.value[0],l.rotation.z=l.rotation.value[2],(new TWEEN.Tween(l.rotation)).to({x:0,z:0},190).easing(TWEEN.Easing.Sinusoidal.EaseIn).onUpdate(function(){l.rotation.value[0]=l.rotation.x;l.rotation.value[2]=l.rotation.z}).start());f=!1;0==V&&(f=!0);n||Sound.playBrickSound(B,x,w,f);l.props={brickw:B,brickd:x,brickh:w,
isSloped:t,rotation:O,isSpecial:C,specialType:H,color:k,id:F,gridPositionX:L,gridPositionY:V-D,gridPositionZ:J};q[F]=l;for(f=L;f<L+B;++f)for(h=J;h<J+x;++h)for(g=V-D;g<V-D+w;++g)aa[g][f][h]=F;n||a.addUndo({type:"remove",id:F});++F;p+=a.getBrickValue(t,C);updateBrickCount(p);!n&&(!m&&D<w)&&a.moveUp()}};a.moveUp=function(){d.position.value[1]=(V+w)*LDF.LUF.y+0.1;V+=w;N=(new Date).getTime()};a.checkBrickAbove=function(){for(var a=!1,b=L;b<L+B;++b)for(var c=J;c<J+x;++c)0!=aa[V+w][b][c]&&(a=!0,b=c=1E3);
return a};a.checkBrickBelow=function(){for(var a=0,b=V-1;0<=b;--b){for(var c=L;c<L+B;++c)for(var d=J;d<J+x;++d)try{0!=aa[b][c][d]&&(a-=1,b=-1,c=d=1E3)}catch(n){b=-1,c=d=1E3}++a}return a};a.checkOccupied=function(){var a=!1;if(84<V||84<V+w)return!0;for(var b=L;b<L+B;++b)for(var c=J;c<J+x;++c)for(var d=V;d<V+w;++d)try{0!=aa[d][b][c]&&(a=!0,b=c=1E3)}catch(n){a=!0,b=c=1E3}return a};a.shootRay=function(b){var c=e.shoot(u.setFromMouse(f,U,y));d.visible=b?!1:!0;1==na&&(d.visible=!1);if(c.didHit){b=c.point;
var n=c.normal,c=c.reference;Z=!0;if(c==ja||c==X||0.5>n.value[1]){var D=Math.floor(b.value[0]/LDF.LU.x),k=Math.floor(b.value[2]/LDF.LU.z);D>16-B&&(D=16-B);k>16-x&&(k=16-x);-16>D&&(D=-16);-16>k&&(k=-16);L=D+16;J=k+16;V=Math.floor(b.value[1]/LDF.LUF.y);if(c!=ja&&c!=X){b=c.props.brickh;var h=0;1<b&&(h=b*LDF.LUF.y-w);V=Math.floor((c.position.value[1]+h+0.1)/LDF.LUF.y);-1==n.value[0]&&(L-=B,D-=B);-1==n.value[2]&&(J-=x,k-=x)}0>V&&(V=0);0>L&&(L=0);0>J&&(J=0);d.position.set(D*LDF.LU.x+LDF.LU.x*B/2,V*LDF.LUF.y,
k*LDF.LU.z+LDF.LU.z*x/2);ea=null}else if(c!=ja&&c!=X&&0.95<n.value[1]){var n=c.props.brickw,D=c.props.brickd,k=c.props.rotation,l=h=0,g=0,E=0;c.props.isSloped&&(0==k&&(2==D&&(l=1,E=-1),3==D&&(l=2,E=-2)),1==k&&(2==n&&(h=1,g=-1),3==n&&(h=2,g=-2)),2==k&&(2==D&&(E=l=1),3==D&&(E=l=2)),3==k&&(2==n&&(g=h=1),3==n&&(g=h=2)));X.position.value[1]=b.value[1]+0.01;X.position.value[0]=c.position.value[0]-(B-1+g)/2*LDF.LU.x;X.position.value[2]=c.position.value[2]-(x-1+E)/2*LDF.LU.z;X.scale.value[0]=n-h+B-1;X.scale.value[2]=
D-l+x-1;X.lowerBound.set(-(n-h+B-1)*LDF.LU.x/2,0,-(D-l+x-1)*LDF.LU.z/2);X.upperBound.set((n-h+B-1)*LDF.LU.x/2,0.01,(D-l+x-1)*LDF.LU.z/2);0==na&&(ea=null)}if(c!=ja&&c!=X)try{ea=c.props.id}catch(m){}c==ja&&(X.position.value[1]=1E4);if((L!=W||J!=ka)&&!Keys.keySpace&&1!=na)a.checkOccupied()?a.setCursor("no"):a.setCursor("point");W=L;ka=J;if(1==na){if(d.visible=!1,X.position.value[1]=1E4,Keys.keySpace||a.setCursor("remove"),null!=ea)try{var p=q[ea];p.changeOpacity(0.85)}catch(r){}}else 1==d.opacity.value[0]&&
d.changeOpacity(0.85);if(ea!=P&&null!=P)try{p=q[P],"_t"!=p.type.name.substr(p.type.name.length-2)?p.changeOpacity(1):p.changeOpacity(0.75)}catch(v){}P=ea}else ea=null,1==na&&q[P]&&(p=q[P],"_t"!=p.type.name.substr(p.type.name.length-2)?p.changeOpacity(1):p.changeOpacity(0.75)),1!=d.opacity.value[0]&&d.changeOpacity(1),X.position.value[1]=1E4,p=0,10>wa.value[1]&&(p=Math.abs(wa.value[1]-10)),T.copy(u.direction),wa.copy(T.multiplyScalar(500).addSelf(y.matrix.position)),K.copy(u.direction.multiplyScalar(500-
4*p).addSelf(y.matrix.position)),Z=!1,!R&&!Keys.keySpace&&a.setCursor("hand")};a.changeGhostBrick=function(){d&&(Oa=d.position,b.removeObject(d));var c=B,n=x;if(1==O||3==O)n=B,c=x;var e=0.85;Z||(e=1);t?d=new GLEGO.BuildObject("brick_"+c+"_"+n+"_s_r0",k,e):C?("window"==H&&(d=new GLEGO.BuildObject("brick_window_r0",k,e)),"door"==H&&(d=new GLEGO.BuildObject("brick_door_r0",k,e)),"1x1_round_open"==H&&(d=new GLEGO.BuildObject("1x1_round_open",k,e)),"1x1_round_straight"==H&&(d=new GLEGO.BuildObject("1x1_round_straight",
k,e)),"1x1_round_withouttop"==H&&(d=new GLEGO.BuildObject("1x1_round_withouttop",k,e)),"1x4_antenna"==H&&(d=new GLEGO.BuildObject("1x4_antenna",k,e)),"1x4_arc"==H&&(d=new GLEGO.BuildObject("1x4_arc_r0",k,e)),"1x4_fence"==H&&(d=new GLEGO.BuildObject("1x4_fence_r0",k,e)),"2x2x2_barrel"==H&&(d=new GLEGO.BuildObject("2x2x2_barrel",k,e)),"brick_2_1_s_inverted"==H&&(d=new GLEGO.BuildObject("brick_2_1_s_inverted_r0",k,e)),"brick_2_2_s_inverted"==H&&(d=new GLEGO.BuildObject("brick_2_2_s_inverted_r0",k,e)),
"1x3_flagpole"==H&&(d=new GLEGO.BuildObject("1x3_flagpole_r0",k,e)),"1x1_round_transparent"==H&&(d=new GLEGO.BuildObject("1x1_round_straight_t",k,e)),"1x1_transparent"==H&&(d=new GLEGO.BuildObject("brick_1_1_l_t",k,e))):d=new GLEGO.BuildObject("brick_"+c+"_"+n+"_"+a.getType(),k,e);d.rotation.value[1]=O*Math.PI/2;Z?d.position=Oa:d.position.copy(K);b.addObject(d);Ka&&a.showIcon()};a.updateUiBrickColor=function(){var b=B,c=x;if(1==O||3==O)b=x,c=B;a.updateBrickPreview(b,c,w,t,v);$("#original-bricks").css({backgroundImage:"url(/"+
window._version+"/img/build/bricks/all/"+v+".png)"});$("#special-bricks").css({backgroundImage:"url(/"+window._version+"/img/build/bricks/special/"+v+".png)"});b=$('.colorpicker a[data-color="'+v+'"]');$(".colorpicker a").removeClass("active");$(".btn-choose-color").removeClass("btn-choose-color-"+"blue red orange yellow darkgreen green brown gray black white secret 5 135 138 154 193 199 212 221 222 226 268 297 321 326".split(" ").join(" btn-choose-color-")).addClass("btn-choose-color-"+v);b.addClass("active");
$(".btn-rotate svg path").css({fill:utils.getCssColor(v)});"white"==v?$(".btn-rotate svg path").attr("stroke","#ccc").attr("stroke-width","1px"):$(".btn-rotate svg path").removeAttr("stroke").removeAttr("stroke-width")};a.setBrickColor=function(b,c){a.setMode(0);v=b;k=utils.convertToLegacyColorIdentifier(b);c||(a.changeGhostBrick(),a.updateUiBrickColor(k));a.colorChange.dispatch(k);ma&&-1===ia.indexOf(v)&&a.setBrickSize(4,2,3)};a.translateBrickToCode=function(a,b,c,d,n){C&&(a=H,c=b=0);var e={"4_2_3":"0000",
"2_4_3":"0000","2_2_1":"0001","1_4_1":"0002","2_4_1":"0003","4_1_1":"0002","4_2_1":"0003","1_1_1":"0004","1_1_3":"0005","1_2_3":"0006","2_1_3":"0006","1_4_3":"0007","4_1_3":"0007","2_2_3":"0008","1_2_3_s":"0009","2_3_3_s":"0010","2_1_3_s":"0009","3_2_3_s":"0010","2_8_3":"0011","8_2_3":"0011",window_0_0:"0012",door_0_0:"0013","1x1_round_open_0_0":"0014","1x1_round_straight_0_0":"0015","1x1_round_transparent_0_0":"0016","1x1_transparent_0_0":"0017",brick_2_2_s_inverted_0_0:"0018",brick_2_1_s_inverted_0_0:"0019",
"1x4_antenna_0_0":"0021","1x1_round_withouttop_0_0":"0023"};a=a+"_"+b+"_"+c+(d?"_s":"");console.log(a);ma?n="transparent/"+("1x1_round_transparent_0_0"==a?"round/":"square/")+n+".png":(utils.preloadBrickImages(e[a],n),isNaN(parseInt(n))||(n+="_"),n="hero/"+n+e[a]+".png");return n};a.updateBrickPreview=function(b,c,d,n,e){console.log("update bp");console.log(e);b=a.translateBrickToCode(b,c,d,n,e);$("#current-piece img").attr("src","/"+window._version+"/img/build/bricks/"+b)};a.setBrickSize=function(b,
c,d,n,e){t=n?!0:!1;C=!1;a.setMode(0);a.toggleTransparency(!1);B=b;x=c;w=d;if(1==O||3==O)B=c,x=b;e||(a.changeGhostBrick(),a.updateBrickPreview(b,c,d,t,v))};a.setSpecialBrick=function(b,c){H=b;t=!1;C=!0;a.setMode(0);a.toggleTransparency(!1);"window"==b.toLowerCase()&&(B=2,x=4,w=9);"door"==b.toLowerCase()&&(B=2,x=4,w=15);"1x1_round_open"==b.toLowerCase()&&(x=B=1,w=3);"1x1_round_straight"==b.toLowerCase()&&(w=x=B=1);"1x1_round_withouttop"==b.toLowerCase()&&(x=B=1,w=3);"1x4_antenna"==b.toLowerCase()&&
(x=B=1,w=12);"1x4_arc"==b.toLowerCase()&&(B=4,x=1,w=3);"1x4_fence"==b.toLowerCase()&&(B=4,x=1,w=3);"2x2x2_barrel"==b.toLowerCase()&&(x=B=2,w=6);"brick_2_1_s_inverted"==b.toLowerCase()&&(B=2,x=1,w=9);"brick_2_2_s_inverted"==b.toLowerCase()&&(x=B=2,w=3);"1x3_flagpole"==b.toLowerCase()&&(B=1,x=3,w=12);"1x1_transparent"==b.toLowerCase()&&(w=x=B=1,a.toggleTransparency(!0));"1x1_round_transparent"==b.toLowerCase()&&(w=x=B=1,a.toggleTransparency(!0));var d=B,n=x;if(1==O||3==O)B=n,x=d;c||(a.changeGhostBrick(),
a.updateBrickPreview(b,0,0,0,v))};a.rotateBrick=function(b){console.log(O);console.log("----------");for(console.log(b);0==a.checkBrickBelow();)a.moveUp(),a.moveUp();var c=O;O+=b;0>O&&(O=3);3<O&&(O=0);b=B;B=x;x=b;X.position.value[1]=1E4;0==c&&3==O&&(d.rotation.value[1]=4*Math.PI/2);3==c&&0==O&&(d.rotation.value[1]=-1*Math.PI/2);d.rotation.y=d.rotation.value[1];(new TWEEN.Tween(d.rotation)).to({y:O*Math.PI/2},150).easing(TWEEN.Easing.Sinusoidal.EaseOut).onUpdate(function(){d.rotation.value[1]=d.rotation.y}).onComplete(function(){!C&&
!t&&(O=c);a.changeGhostBrick()}).start();a.rotation.dispatch(O)};a.takeSnapShot=function(b){var c=h,d=45*Math.PI/180+Math.floor(c/(2*Math.PI))*2*Math.PI,c=180*c/Math.PI;180<(c+360)%360&&(h-=2*Math.PI);m=d;g=320;ga=0;a.setCameraFocus(0);D=b;setTimeout(a.initSnapShot,500)};a.initSnapShot=function(){var c=1+Math.floor(3*Math.random());Sound.playStaticSound(Sound["camera_"+c],0.5);ba.visible=!1;d.visible=!1;a.updateCamera(600);b.resize(400,400);b.render();c=b.getDomElement().toDataURL();h=m=135*Math.PI/
180;a.updateCamera(600);b.render();var n=b.getDomElement().toDataURL();h=m=225*Math.PI/180;a.updateCamera(600);b.render();var e=b.getDomElement().toDataURL();h=m=315*Math.PI/180;a.updateCamera(600);b.render();var f=b.getDomElement().toDataURL();D([c,n,e,f]);b.resize(window.innerWidth- -200,window.innerHeight-60);ha=0;ba.visible=!0;d.visible=!0;h=m=45*Math.PI/180};a.setPredefinedRotation=function(b){var c=h,d=b*Math.PI/180+Math.floor(c/(2*Math.PI))*2*Math.PI,c=180*c/Math.PI,c=(c+360)%360;180>c&&315<=
b&&(h+=2*Math.PI);180<c&&45>=b&&(h-=2*Math.PI);m=d;g=320;ga=0;a.setCameraFocus(0)};a.setRotation=function(a){m=h=a=a*Math.PI/180};a.updateCurrentAngle=function(){a.currentAngle=(180*m/Math.PI+360)%360;a.currentAngle!=a.oldAngle&&$(".rotate .builder-rotator img").css({"-webkit-transform":"rotate("+a.currentAngle+"deg)","-moz-transform":"rotate("+a.currentAngle+"deg)"});a.oldAngle=a.currentAngle};a.setCameraFocus=function(a){G=100*a};a.zoom=function(a){ga+=2*a;0>ga&&(ga=0);18<ga&&(ga=18)};a.setMode=
function(a){na=a;0==na?($(".btn-remove").removeClass("active"),d&&(d.visible=!0)):($(".btn-remove").addClass("active"),d&&(d.visible=!1))};a.undo=function(){if(!(0>=da.length)){var b=da[0];"remove"==b.type&&(ea=b.id,a.removeBrick(!0));if("add"==b.type){var c=O,d=B,n=x,e=w,f=k,D=t,h=C,l=H,g=na,b=b.props;O=b.rotation;var E=b.brickw,p=b.brickd;if(1==O||3==O)E=b.brickd,p=b.brickw;a.setBrickSize(E,p,b.brickh,b.isSloped,!0);a.setBrickColor(b.color,!0);L=b.gridPositionX;J=b.gridPositionZ;V=b.gridPositionY;
C=b.isSpecial;H=b.specialType;a.setBrick(!0,!0);O=c;a.setBrickSize(d,n,e,D,!0);a.setBrickColor(f,!0);C=h;H=l;na=g;a.setMode(na)}da.shift()}};a.addUndo=function(a){da.unshift(a);10<da.length&&da.pop()};a.setCursor=function(a){a!=n&&(document.getElementById("container").style.cursor=Ma[a],n=a)};a.render=function(){oa=(new Date).getTime();ra=oa-Pa;Pa=oa;if(isNaN(ra)||1E3<ra||0==ra)ra=1E3/60;requestAnimationFrame(a.render);TWEEN.update();a.updateCamera();b.render()};a.updateCamera=function(b){La&&(0!=
Ga-I&&(m-=(Ga-I)/500),0!=Ja-l&&(g+=Ja-l,200>g&&(g=200),600<g&&(g=600)),a.shootRay());Ga=I;Ja=l;Z?(d.rotation.value[2]=0,d.rotation.value[0]=0):(d.position.value[0]+=(K.value[0]-d.position.value[0])/3,d.position.value[1]+=(K.value[1]-d.position.value[1])/3,d.position.value[2]+=(K.value[2]-d.position.value[2])/3,d.rotation.value[2]=I/window.innerWidth/2,d.rotation.value[0]=l/window.innerHeight/2);ga+=la;0>ga&&(ga=0);25<ga&&(ga=25);ha+=(ga-ha)/6;GLOW.Matrix4.makeProjection(30-ha,y.aspect,y.near,y.far,
y.projection);h+=(m-h)/4;z+=(g-(z-G))/10;s.value[1]+=(G-s.value[1])/10;s.value[0]+=(0-s.value[0])/10;s.value[2]+=(0-s.value[2])/10;var c=800-g;b&&(c=b);y.matrix.setPosition(s.value[0]+Math.cos(h)*c,z,s.value[2]+Math.sin(h)*c);a.updateCurrentAngle();y.target.copy(s);y.matrix.lookAt(y.target,y.up)};a.onDocumentMouseMove=function(b){var d="";null!=b.target.firstChild&&(d=b.target.firstChild.toString());if("[object HTMLCanvasElement]"==d){b.preventDefault();b=c.relMouseCoords(b);var d=I,n=l;I=b.x-c.width/
2;l=b.y-c.height/2;f=2*(b.x/c.width)-1;U=2*(b.y/c.height)-1;200<(new Date).getTime()-N&&(I!=d||l!=n)&&a.shootRay();La=R||R&&AcademyKeys.keySpace?!0:!1}};a.onDocumentMouseDown=function(b){var n="";null!=b.target.firstChild&&(n=b.target.firstChild.toString());"[object HTMLCanvasElement]"==n&&(b.preventDefault(),Z&&!Keys.keySpace?2==b.button?(a.shootRay(),a.removeBrick(),d.visible=!1):1==na?(a.shootRay(),a.removeBrick()):a.setBrick():(c.relMouseCoords(b),a.setCursor("handdown"),R=!0))};a.onDocumentMouseUp=
function(a){a.preventDefault();R=!1};a.onDocumentMouseWheel=function(a){var b=0;a.wheelDelta?b=a.wheelDelta/1E3:a.detail&&(b=-a.detail/20);ga+=10*b;0>ga&&(ga=0);18<ga&&(ga=18);a.preventDefault()};a.onWindowResize=function(a){b.resize(window.innerWidth- -200,window.innerHeight-60)};a.getType=function(){var a="h";1==w&&(a="l");t&&(a="s_r"+O);C&&(a="r"+O);return a};a.getBrickValue=function(a,b){var c=1;a&&(c=3);b&&(c=15);return c};a.save=function(b){if(1>p)return!1;var c=GLEGO.DataFactory.encode(q,null,
aa),c={buildData:c.buildData,structure:c.structure};console.log("Saving build, access it on");console.log("/api/builds/"+A+"/data");$.post("/api/builds/"+A,c,function(c){"function"==typeof b&&b.call(a)},"json");return!0};a.loadUrl=function(){console.log("Loading build "+A);return"/api/builds/"+A+"/data?_="+(new Date).getTime()};a.setBuildNumber=function(a){A=a};a.getId=function(){return A};a.mapImageUrl=function(a,b){return"//maps.google.com/maps/api/staticmap?sensor=false&style=feature:all|element:labels|visibility:off&maptype=roadmap&scale=1&size=480x480&zoom=16&center="+
build_lat+","+build_lng};a.publish=function(a,b,c,d){$.post("/api/builds/"+A+"/publish",{email:a,defaultImage:c,category:b},function(a){"user_banned"==a.status?(a=$("<div>"),a.append("<h2>"+_("notifications_attention")+"</h2>"),a.append("<p>"+_("notifications_inappropriate_behavior_1")+"</p>"),a.append("<p>"+_("notifications_inappropriate_behavior_2")+"</p>"),a.append("<p>"+_("notifications_inappropriate_behavior_3")+"</p>"),new Popup({content:a,submitLabel:"Ok",hideCancel:!0})):(window.clearInterval(Ha),
d(A))},"json")};a.toggleTransparency=function(a){ma=a;console.log(ma);console.log(d);d&&(a?d.changeOpacity(0.5):d.changeOpacity(1))};a.load=function(b){var c=O,d=B,n=x,e=w,f=k,D=t,h=C,l=H,g=new Image;g.onload=function(){for(var b=GLEGO.DataFactory.decodeToBuild(g),k=0;k<b.length;++k){var E=b[k];if(!(void 0==E||null==E)){var p=E.type.name;O=0;-1!=p.indexOf("_r1")&&(O=1);-1!=p.indexOf("_r2")&&(O=2);-1!=p.indexOf("_r3")&&(O=3);var m=E.type.size.x,q=E.type.size.y,r=E.type.size.z;if(1==O||3==O)m=E.type.size.z,
r=E.type.size.x;var v=!1;-1!=p.indexOf("_s_")&&(v=!0);a.setBrickSize(m,r,q,v,!0);-1!=p.indexOf("window")&&a.setSpecialBrick("window",!0);-1!=p.indexOf("door")&&a.setSpecialBrick("door",!0);-1!=p.indexOf("1x1_round_open")&&a.setSpecialBrick("1x1_round_open",!0);-1!=p.indexOf("1x1_round_straight")&&a.setSpecialBrick("1x1_round_straight",!0);-1!=p.indexOf("1x1_round_withouttop")&&a.setSpecialBrick("1x1_round_withouttop",!0);-1!=p.indexOf("1x4_antenna")&&a.setSpecialBrick("1x4_antenna",!0);-1!=p.indexOf("1x4_arc")&&
a.setSpecialBrick("1x4_arc",!0);-1!=p.indexOf("1x4_fence")&&a.setSpecialBrick("1x4_fence",!0);-1!=p.indexOf("2x2x2_barrel")&&a.setSpecialBrick("2x2x2_barrel",!0);-1!=p.indexOf("brick_2_1_s_inverted")&&a.setSpecialBrick("brick_2_1_s_inverted",!0);-1!=p.indexOf("brick_2_2_s_inverted")&&a.setSpecialBrick("brick_2_2_s_inverted",!0);-1!=p.indexOf("1x3_flagpole")&&a.setSpecialBrick("1x3_flagpole",!0);-1!=p.indexOf("1x1_transparent")&&a.setSpecialBrick("1x1_transparent",!0);-1!=p.indexOf("1x1_round_transparent")&&
a.setSpecialBrick("1x1_round_transparent",!0);a.setBrickColor(E.color.name,!0);var E=E.position,p=Math.floor(E.value[0]/LDF.LU.x),q=Math.floor(E.value[2]/LDF.LU.z),v=Math.floor(m/2),s=Math.floor(r/2);if(1==O||3==O)v=Math.floor(r/2),s=Math.floor(m/2);L=p+16-v;J=q+16-s;V=Math.round(E.value[1]/LDF.LUF.y);a.setBrick(!0,!0)}}Ka=!0;O=c;a.setBrickSize(d,n,e,D,!0);a.setBrickColor(f,!0);C=h;H=l;a.loadReady.dispatch()};g.src=b;try{ja.tween.stop(),ba.tween.stop(),S.tween.stop(),Q.tween.stop(),a.addListeners()}catch(E){}ja.position.set(0,
-1.3,0);ba.position.set(0,-12,0);S.position.set(11*LDF.LU.x,-6.3,16*LDF.LU.z);Q.position.set(13*LDF.LU.x,-6.3,16*LDF.LU.z)};return a}();HTMLCanvasElement.prototype.relMouseCoords=function(a){var b=0,c=0,e=0,y=0,e=this;do b+=e.offsetLeft,c+=e.offsetTop;while(e=e.offsetParent);e=a.pageX-b;y=a.pageY-c;e=Math.round(e*(this.width/this.offsetWidth));y=Math.round(y*(this.height/this.offsetHeight));return{x:e,y:y}};var BuilderAcademy=function(){var a=!0,b={},c,e,y,s,m=new GLOW.Vector3(0,0,0),h=1.35,g=h,z=330,G=z,r=0,A=0,M=0,Y,u=null,d=!1,I=!0,l,f,U=0,R=0,Z=0,N=0,B=!1,x=!1,w=0,k=1,v=1,t=1,C="red",H="red",F=!1,q=!1,p,ea=1,P=[],O=0,K=null,wa=null,T=0,ja=new GLOW.Vector3(0,200,0),X=new GLOW.Vector3(0,200,0),ba=new GLOW.Vector3,S,Q,aa,V,L,J,W=0,ka=null,da=null,ga=null,ha=null,na=[],ma=[],ia=0,Ba=0,la=0,xa=!1,Aa="blue red orange yellow green 212 321".split(" "),Da=null,ya=0,ua=!1,pa,Ea,Ia=!1,Fa,ta=!1,Ka=!1,Oa=0,La=
0,Ha,Ga=!1,Ja,ca,ra=0,oa=0,Pa=0,Ma,n=1,D=0,E,Ra,Xa,Ya,Za,$a,ab,bb,cb,Ca=0,db=!1,sa=!1,Qa,eb=!0,ib=!1,jb=!1,kb=0,lb=0,Ta=[],fb=!1,Ua=!1,mb=!1,Na=!1,fa=0,qa=!1,za=0,gb=!1,hb=!1,Sa=0;b.error=new signals.Signal;b.colorChange=new signals.Signal;b.rotation=new signals.Signal;b.ready=new signals.Signal;b.loadReady=new signals.Signal;b.onInitReady=new signals.Signal;b.currentAngle=0;b.oldAngle=0;var Va,nb,ob,rb={normal:"default",point:"url(/assets/builder/pointer.png),pointer",remove:"url(/assets/builder/pointer_delete.png),pointer",
no:"url(/assets/builder/pointer_no.png),pointer",hand:"url(/assets/builder/move.png),all-scroll",handdown:"url(/assets/builder/move_down.png),all-scroll"},pb="normal",qb=null,va,Wa;b.onTouchStart=function(a){Ha=!1;var c=a.touches[0].target.firstChild;null!=c&&"[object HTMLCanvasElement]"==c.toString()&&(a.preventDefault(),2==a.touches.length&&(Sa+=2),3==a.touches.length&&Sa++,Ha=!0,ta=Ka=Ia=!1,MouseX=a.touches[0].clientX-e.width/2,MouseY=a.touches[0].clientY-60-e.height/2,Oa=MouseX,La=MouseY,Z=2*
(a.touches[0].clientX/e.width)-1,N=2*((a.touches[0].clientY-60)/e.height)-1,f&&y.addObject(f),a=y.shoot(l.setFromMouse(Z,N,s)),a.didHit&&(a.reference!=f?b.shootRay(!0):ta=!0),f&&y.removeObject(f))};b.onTouchMove=function(a){a.preventDefault();if(Ha)if(2==a.touches.length){Ia=!0;f.visible=!1;var c=a.touches[1].clientX-a.touches[0].clientX,d=a.touches[1].clientY-a.touches[0].clientY;a=c*c+d*d;2==fa&&!qa&&b.autoPlaceBrick();1==fa&&qa&&b.autoPlaceBrick();1E3<Math.abs(Fa-a)?null==Da?Fa=Da=a:Fa>a?ya=-0.35:
Fa<a&&(ya=0.35):ya=0;Fa=a;c=Math.atan2(d,c);ua?(0.01<Math.abs(Ea-(c-pa))&&(Ea>c-pa?(d=Math.abs(c-pa)/20,0.15<d&&(d=0.08),h+=d):(d=Math.abs(c-pa)/20,0.15<d&&(d=0.08),h-=d)),Ea=c-pa):(pa=c,ua=!0,Ea=c)}else MouseX=a.touches[0].clientX-e.width/2,MouseY=a.touches[0].clientY-60-e.height/2,ta&&(c=MouseX-Oa,d=MouseY-La,200<c*c+d*d&&(ta=!1)),ta||(Ka=!0,Z=2*(a.touches[0].clientX/e.width)-1,N=2*((a.touches[0].clientY-60)/e.height)-1,Ia||200<(new Date).getTime()-w&&b.shootRay()),ya=0};b.findNewSpot=function(){b.shootRay()};
b.onTouchEnd=function(a){Ha&&(!Ia&&(!Ka&&0==Sa)&&(x?1==la?(b.shootRay(),b.removeBrick(),f.visible=!1):(ta||b.findNewSpot(),b.setBrick(),f.visible=!0):f.visible=!1),Sa--,0>Sa&&(Sa=0),w=0,ua=!1,Da=null,ya=Fa=0)};b.init=function(a,d,e,k,l,p,E,q,v,s){H=s;C=utils.convertToLegacyColorIdentifier(s);b.updateUiBrickColor();qa=_browser.isDevice();if(db){console.log("\u00c5TERANV\u00c4NDER GAMMAL RENDERARE");fb=!1;T=0;b.setBrickSize(4,2,3);s&&b.setBrickColor(s);f.visible=!1;window.cd&&window.cd.kill();b.reset();
J=[];for(l=0;85>=l;++l){J.push([]);for(E=0;32>E;++E){J[l].push([]);for(var t=0;32>t;++t)J[l][E].push(0)}}O=0;n=1;ca=[];Pa=oa=ra=0;Ma=null;Ca=D=0;sa=!1;fa=0;Na=!1;za=0;hb=Ua=gb=!1;console.log("initiating new build on tile "+e+", "+k);va=[q[0],q[1],q[2]];s&&b.setBrickColor(s,!0);e=v.split("x");Ma=e[1];ArCollected.setCurrentLevel(e[0]);"1001"==e[0]&&(Na=!0);Na||(ca=ArCollected.getRound(n)[0].arr);console.log("Level: "+e[0]);console.log("LevelType: "+e[1]);console.log("Current Color: "+s);Wa.context.clear.red=
va[0]/255;Wa.context.clear.green=va[1]/255;Wa.context.clear.blue=va[2]/255;console.log("Colors: "+va[0]+" "+va[1]+" "+va[2]);Y=a;plateId=p;u=d;m=new GLOW.Vector3(0,0,0);g=h=1.35;G=z=330;la=Ba=ia=M=A=r=0;xa=!1;b.addListeners();b.autoPlaceBrick()}else console.log("NY RENDERARE!"),console.log("initiating new build on tile "+e+", "+k),va=[q[0],q[1],q[2]],console.log("Colors: "+va[0]+" "+va[1]+" "+va[2]),s&&b.setBrickColor(s,!0),fb=!1,T=0,e=v.split("x"),Ma=e[1],ArCollected.setCurrentLevel(e[0]),"1001"==
e[0]&&(Na=!0),console.log("Level: "+e[0]),console.log("LevelType: "+e[1]),console.log("Current Color: "+s),Y=a,I=!0,plateId=p,u=d,c=new GLEGO.BuildRenderer,c.initialized.addOnce(b.setup,b);window.clearInterval(jb);jb=setInterval("BuilderAcademy.save()",6E4);b.onInitReady.dispatch()};b.startLevel=function(){console.log("WANTING TO START LEVEL: initiated?"+db);db||(db=!0,Wa={context:{width:window.innerWidth- -200,height:window.innerHeight-60,preserveDrawingBuffer:!0,clear:{red:va[0]/255,green:va[1]/
255,blue:va[2]/255,alpha:1}},camera:{fov:30,near:0.1,far:3E3,aspect:(window.innerWidth- -200)/(window.innerHeight-60),useTarget:!1,useXYZStyleTransform:!1},fog:{near:5E3,far:5E3,color:new GLOW.Color(217,228,232)},ambient:new GLOW.Color(11119017),directionalLights:[{intensity:0.18,color:new GLOW.Color(14669231),direction:new GLOW.Vector3(0,-1,0)},{intensity:1.2,color:new GLOW.Color(16771737),direction:new GLOW.Vector3(-1,-0.5,-1)}],pointLights:[{position:new GLOW.Vector3(55,500,55),range:1E3,color:new GLOW.Color(16750688),
intensity:0.9},{position:new GLOW.Vector3(-55,500,-55),range:1500,color:new GLOW.Color(11593434),intensity:0.8}],load:{shaders:["TextureUnlitGLSL"],geometry:["BrickGeometry","BuildGeometry"],textures:["BuildBasePlateShadowTexture","LegoLogoTexture"]}},console.log("Colors: "+va[0]+" "+va[1]+" "+va[2]),c.init(Wa))};b.setup=function(a){y=new GLEGO.Collider;l=new GLEGO.Ray;s=c.getCamera();J=[];for(a=0;85>=a;++a){J.push([]);for(var d=0;32>d;++d){J[a].push([]);for(var n=0;32>n;++n)J[a][d].push(0)}}b.setBrickSize(4,
2,3);Q=new GLEGO.BuildObject("checkplane","white");Q.scale.set(1,0.01,1);Q.position.value[0]=1E4;Q.visible=!1;c.addObject(Q);y.addObject(Q);S=new GLEGO.BuildBasePlate("brick_32_32_h",Y);S.position.set(0,-1.3,0);c.addObject(S);y.addObject(S);aa=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","shadow",{uTexture:GLEGO.Shaders.getTexture("BuildBasePlateShadowTexture")});c.addObject(aa);aa.position.set(0,-12,0);V=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","legologoplane",{uTexture:GLEGO.Shaders.getTexture("LegoLogoTexture")});
c.addObject(V);V.position.set(11*LDF.LU.x,-6.3,16*LDF.LU.z+0.2);a=document.createElement("canvas");a.width=128;a.height=64;d=a.getContext("2d");d.fillStyle="rgb(73,73,73)";d.fillRect(0,0,128,64);d.fillStyle="rgb(255, 255, 255)";d.font="bold 20px Arial";d.textAlign="center";d.fillText(plateId,64,40);n=d.createLinearGradient(0,0,0,64);n.addColorStop(0,"rgba(0, 0, 0, 0.3)");n.addColorStop(1,"rgba(0, 0, 0, 0.05)");d.fillStyle=n;d.fillRect(0,0,128,64);L=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL",
"numberplane",{uTexture:new GLOW.Texture({data:a,filter:GL.LINEAR,wrap:GL.CLAMP_TO_EDGE})});c.addObject(L);L.position.set(13*LDF.LU.x,-6.3,16*LDF.LU.z+0.2);I||(g=h=Math.PI/4,G=z=320);I?(setTimeout(b.playSwishSound,150),setTimeout(b.delayedStart,1800),S.position.value[1]+=300,S.position.y=S.position.value[1],S.tween=(new TWEEN.Tween(S.position)).to({y:-0.1},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){S.position.value[1]=S.position.y}).onComplete(b.addListeners),S.tween.start(),aa.position.value[1]+=
300,aa.position.y=aa.position.value[1],aa.tween=(new TWEEN.Tween(aa.position)).to({y:-12},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){aa.position.value[1]=aa.position.y}),aa.tween.start(),V.position.value[1]+=300,V.position.y=V.position.value[1],V.tween=(new TWEEN.Tween(V.position)).to({y:-6.3},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){V.position.value[1]=V.position.y}),V.tween.start(),L.position.value[1]+=300,L.position.y=L.position.value[1],L.tween=(new TWEEN.Tween(L.position)).to({y:-6.3},
1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){L.position.value[1]=L.position.y}),L.tween.start()):(b.addListeners(),b.delayedStart());e=c.getDomElement();GLEGO.error.add(b.onError);document.getElementById("container").appendChild(c.getDomElement());requestAnimationFrame(b.render);b.ready.dispatch()};b.delayedStart=function(){Na||(ca=ArCollected.getRound(n)[0].arr);b.autoPlaceBrick()};b.playSwishSound=function(){Sound.playStaticSound(Sound.swish,0.5)};b.playWarningSound=function(){Sound.playStaticSound(Sound.alert,
0.5)};b.onError=function(a){b.error.dispatch()};b.addListeners=function(){d||(window.addEventListener("resize",b.onWindowResize,!1),document.addEventListener("contextmenu",function(a){a.preventDefault()},!1),document.addEventListener("mousemove",b.onDocumentMouseMove,!1),document.addEventListener("mousedown",b.onDocumentMouseDown,!1),document.addEventListener("mouseup",b.onDocumentMouseUp,!1),document.addEventListener("keydown",AcademyKeys.onDocumentKeyDown,!1),document.addEventListener("keyup",AcademyKeys.onDocumentKeyUp,
!1),document.addEventListener("mousewheel",b.onDocumentMouseWheel,!1),document.addEventListener("DOMMouseScroll",b.onDocumentMouseWheel,!1),document.addEventListener("touchstart",b.onTouchStart,!1),document.addEventListener("touchmove",b.onTouchMove,!1),document.addEventListener("touchend",b.onTouchEnd,!1),d=!0)};b.unFreeze=function(){eb||(f.visible=!0,document.addEventListener("keydown",AcademyKeys.onDocumentKeyDown,!1),document.addEventListener("keyup",AcademyKeys.onDocumentKeyUp,!1),document.addEventListener("touchstart",
b.onTouchStart,!1),document.addEventListener("touchmove",b.onTouchMove,!1),document.addEventListener("touchend",b.onTouchEnd,!1),document.addEventListener("mousemove",b.onDocumentMouseMove,!1),document.addEventListener("mousedown",b.onDocumentMouseDown,!1),document.addEventListener("mouseup",b.onDocumentMouseUp,!1),eb=!0)};b.freezeListeners=function(){eb&&(f.visible=!1,f.position.set(1E3,1E3,1E3),document.removeEventListener("keydown",AcademyKeys.onDocumentKeyDown,!1),document.removeEventListener("keyup",
AcademyKeys.onDocumentKeyUp,!1),document.removeEventListener("touchstart",b.onTouchStart,!1),document.removeEventListener("touchmove",b.onTouchMove,!1),document.removeEventListener("touchend",b.onTouchEnd,!1),document.removeEventListener("mousemove",b.onDocumentMouseMove,!1),document.removeEventListener("mousedown",b.onDocumentMouseDown,!1),document.removeEventListener("mouseup",b.onDocumentMouseUp,!1),eb=!1)};b.removeBrick=function(a){var d=W-1;0>d&&(d=0);var e=J[d][ka][da];null!=K&&(e=K);if(!(0==
e||-1==$.inArray(e,Ta)&&!Ua)){var f=P[e];if(!("2002"==ArCollected.getCurrentLevel()&&2==n&&!(-1!=$.inArray(e,Ta)||"white"==f.props.color)||"6002"==ArCollected.getCurrentLevel()&&2==n&&!(-1!=$.inArray(e,Ta)||"orange"==f.props.color)||"6002"==ArCollected.getCurrentLevel()&&3==n&&!(-1!=$.inArray(e,Ta)||"gray"==f.props.color))){a||b.addUndo({type:"add",props:{brickw:f.props.brickw,brickd:f.props.brickd,brickh:f.props.brickh,isSloped:f.props.isSloped,rotation:f.props.rotation,color:f.props.color,isSpecial:f.props.isSpecial,
specialType:f.props.specialType,gridPositionX:f.props.gridPositionX,gridPositionY:f.props.gridPositionY,gridPositionZ:f.props.gridPositionZ}});if(null!=K){try{if(void 0==f.props)return}catch(D){return}a=b.setCompareFormat(f.props.isSpecial,f.props.color,f.props.rotation,f.props.isSloped,f.props.isSpecial,f.props.brickw,f.props.brickd,f.props.brickh,f.props.gridPositionX,f.props.gridPositionY,f.props.gridPositionZ,f.opacity.value[0],f.props.specialType);b.countPlacedBricks(a,!1);6==fa&&!qa&&b.autoPlaceBrick();
4==fa&&qa&&b.autoPlaceBrick();var k=f.props.gridPositionX-8;0>k&&(k=0);a=f.props.gridPositionX+8;32<a&&(a=32);var h=f.props.gridPositionZ-8;0>h&&(h=0);var l=f.props.gridPositionZ+8;32<l&&(l=32);d=f.props.gridPositionY}else a=b.setCompareFormat(f.props.isSpecial,f.props.color,f.props.rotation,f.props.isSloped,f.props.isSpecial,f.props.brickw,f.props.brickd,f.props.brickh,f.props.gridPositionX,f.props.gridPositionY,f.props.gridPositionZ,f.opacity.value[0],f.props.specialType),b.countPlacedBricks(a,
!1),6==fa&&!qa&&b.autoPlaceBrick(),4==fa&&qa&&b.autoPlaceBrick(),k=ka-8,0>k&&(k=0),a=ka+8,32<a&&(a=32),h=da-8,0>h&&(h=0),l=da+8,32<l&&(l=32);for(;k<a;++k)for(var E=h;E<l;++E)for(var p=d-16;p<d+16;++p)try{J[p][k][E]==e&&(J[p][k][E]=0)}catch(g){}d=0.2+0.2*Math.random();Sound.playStaticSound(Sound.remove,d);O-=b.getBrickValue(f.props.isSloped,f.props.isSpecial);updateBrickCount(O);c.removeObject(f);y.removeObject(f);P[e]=null;Q.position.value[1]=1E4}}};b.setCompareFormat=function(a,b,c,d,n,e,f,k,D,h,
l,E,p){var g="",m="undefined";a&&(m=p);2!=Pa&&(g=b+",");a="x";if(d||"brick_2_2_s_inverted"==m||"brick_2_1_s_inverted"==m||"window"==m||"door"==m)a=c;"1x1_transparent"==m&&(m="undefined",n=!1);return g+=a+","+d+","+n+","+e+","+f+","+k+","+D+","+h+","+l+","+m+","+(0.76>E?0.75:1)};b.setBrick=function(a,d){var n=a||!1;if(!(3E3<=O)&&(d||(W=Math.round(f.position.value[1]/LDF.LUF.y)),!b.checkOccupied())){var e=b.checkBrickBelow();d&&(e=0);var D=ka-16,h=da-16,l=b.checkBrickAbove();if(l&&0==e||d)n=!0;var E=
"";xa&&(E="_t");var g;q?("window"==p&&(g=new GLEGO.BuildObject("brick_window_"+b.getType(),C)),"door"==p&&(g=new GLEGO.BuildObject("brick_door_"+b.getType(),C)),"1x1_round_open"==p&&(g=new GLEGO.BuildObject("1x1_round_open",C)),"1x1_round_straight"==p&&(g=new GLEGO.BuildObject("1x1_round_straight",C)),"1x1_round_withouttop"==p&&(g=new GLEGO.BuildObject("1x1_round_withouttop",C)),"1x4_antenna"==p&&(g=new GLEGO.BuildObject("1x4_antenna",C)),"1x4_arc"==p&&(g=new GLEGO.BuildObject("1x4_arc_"+b.getType(),
C)),"1x4_fence"==p&&(g=new GLEGO.BuildObject("1x4_fence_"+b.getType(),C)),"2x2x2_barrel"==p&&(g=new GLEGO.BuildObject("2x2x2_barrel",C)),"brick_2_1_s_inverted"==p&&(g=new GLEGO.BuildObject("brick_2_1_s_inverted_"+b.getType(),C)),"brick_2_2_s_inverted"==p&&(g=new GLEGO.BuildObject("brick_2_2_s_inverted_"+b.getType(),C)),"1x3_flagpole"==p&&(g=new GLEGO.BuildObject("1x3_flagpole_"+b.getType(),C)),"1x1_round_transparent"==p&&(g=new GLEGO.BuildObject("1x1_round_straight_t",C)),"1x1_transparent"==p&&(g=
new GLEGO.BuildObject("brick_1_1_l_t",C))):g=new GLEGO.BuildObject("brick_"+k+"_"+v+"_"+b.getType()+E,C);var E=LDF.LU.x*k/2,m=LDF.LU.z*v/2,r=W*LDF.LUF.y,s=LDF.LUF.y*t;3<t&&(s=3*LDF.LUF.y);n&&(s=0);ta?g.position.set(f.position.value[0],f.position.value[1],f.position.value[2]):g.position.set(D*LDF.LU.x+E,r+s,h*LDF.LU.z+m);r=(W-e)*LDF.LUF.y;c.addObject(g);y.addObject(g);n?g.freeze():(g.position.y=g.position.value[1],(new TWEEN.Tween(g.position)).to({y:r},200).easing(TWEEN.Easing.Sinusoidal.EaseIn).onUpdate(function(){g.position.value[1]=
g.position.y}).onComplete(function(){g.rotation.set(0,0,0);g.position.value[1]=r;g.freeze()}).start(),g.rotation.set(0.6*Math.random()-0.3,0,0.6*Math.random()-0.3),g.rotation.x=g.rotation.value[0],g.rotation.z=g.rotation.value[2],(new TWEEN.Tween(g.rotation)).to({x:0,z:0},190).easing(TWEEN.Easing.Sinusoidal.EaseIn).onUpdate(function(){g.rotation.value[0]=g.rotation.x;g.rotation.value[2]=g.rotation.z}).start());n=!1;0==W&&(n=!0);d||Sound.playBrickSound(k,v,t,n);g.props={brickw:k,brickd:v,brickh:t,
isSloped:F,rotation:T,isSpecial:q,specialType:p,color:C,id:ea,gridPositionX:ka,gridPositionY:W-e,gridPositionZ:da};b.addResetter({type:"remove",id:ea});P[ea]=g;Ta.push(ea);for(n=ka;n<ka+k;++n)for(D=da;D<da+v;++D)for(h=W-e;h<W-e+t;++h)J[h][n][D]=ea;d||b.addUndo({type:"remove",id:ea});++ea;5==fa&&!qa&&b.autoPlaceBrick();3==fa&&qa&&b.autoPlaceBrick();O+=b.getBrickValue(F,q);updateBrickCount(O);!d&&(!l&&e<t)&&b.moveUp();g&&(e=b.setCompareFormat(g.props.isSpecial,g.props.color,g.props.rotation,g.props.isSloped,
g.props.isSpecial,g.props.brickw,g.props.brickd,g.props.brickh,g.props.gridPositionX,g.props.gridPositionY,g.props.gridPositionZ,g.opacity.value[0],g.props.specialType),b.countPlacedBricks(e,!0))}};b.moveUp=function(){f.position.value[1]=(W+t)*LDF.LUF.y+0.1;W+=t;w=(new Date).getTime()};b.checkBrickAbove=function(){for(var a=!1,b=ka;b<ka+k;++b)for(var c=da;c<da+v;++c)0!=J[W+t][b][c]&&(a=!0,b=c=1E3);return a};b.checkBrickBelow=function(){for(var a=0,b=W-1;0<=b;--b){for(var c=ka;c<ka+k;++c)for(var d=
da;d<da+v;++d)try{0!=J[b][c][d]&&(a-=1,b=-1,c=d=1E3)}catch(n){b=-1,c=d=1E3}++a}return a};b.checkOccupied=function(){var a=!1;if(84<W||84<W+t)return!0;for(var b=ka;b<ka+k;++b)for(var c=da;c<da+v;++c)for(var d=W;d<W+t;++d)try{0!=J[d][b][c]&&(a=!0,b=c=1E3)}catch(n){a=!0,b=c=1E3}return a};b.shootRay=function(a){var c=y.shoot(l.setFromMouse(Z,N,s));f.visible=a?!1:!0;1==la&&(f.visible=!1);if(c.didHit){a=c.point;var d=c.normal,c=c.reference;x=!0;if(c==S||c==Q||0.5>d.value[1]){var n=Math.floor(a.value[0]/
LDF.LU.x),e=Math.floor(a.value[2]/LDF.LU.z);n>16-k&&(n=16-k);e>16-v&&(e=16-v);-16>n&&(n=-16);-16>e&&(e=-16);ka=n+16;da=e+16;W=Math.floor(a.value[1]/LDF.LUF.y);if(c!=S&&c!=Q){a=c.props.brickh;var g=0;1<a&&(g=a*LDF.LUF.y-t);W=Math.floor((c.position.value[1]+g+0.1)/LDF.LUF.y);-1==d.value[0]&&(ka-=k,n-=k);-1==d.value[2]&&(da-=v,e-=v)}0>W&&(W=0);0>ka&&(ka=0);0>da&&(da=0);f.position.set(n*LDF.LU.x+LDF.LU.x*k/2,W*LDF.LUF.y,e*LDF.LU.z+LDF.LU.z*v/2);K=null}else if(c!=S&&c!=Q&&0.95<d.value[1]){var d=c.props.brickw,
n=c.props.brickd,e=c.props.rotation,D=g=0,h=0,E=0;c.props.isSloped&&(0==e&&(2==n&&(D=1,E=-1),3==n&&(D=2,E=-2)),1==e&&(2==d&&(g=1,h=-1),3==d&&(g=2,h=-2)),2==e&&(2==n&&(E=D=1),3==n&&(E=D=2)),3==e&&(2==d&&(h=g=1),3==d&&(h=g=2)));Q.position.value[1]=a.value[1]+0.01;Q.position.value[0]=c.position.value[0]-(k-1+h)/2*LDF.LU.x;Q.position.value[2]=c.position.value[2]-(v-1+E)/2*LDF.LU.z;Q.scale.value[0]=d-g+k-1;Q.scale.value[2]=n-D+v-1;Q.lowerBound.set(-(d-g+k-1)*LDF.LU.x/2,0,-(n-D+v-1)*LDF.LU.z/2);Q.upperBound.set((d-
g+k-1)*LDF.LU.x/2,0.01,(n-D+v-1)*LDF.LU.z/2);0==la&&(K=null)}if(c!=S&&c!=Q)try{K=c.props.id}catch(p){}c==S&&(Q.position.value[1]=1E4);if((ka!=ga||da!=ha)&&!AcademyKeys.keySpace&&1!=la)b.checkOccupied()?b.setCursor("no"):b.setCursor("point");ga=ka;ha=da;if(1==la){if(f.visible=!1,Q.position.value[1]=1E4,AcademyKeys.keySpace||b.setCursor("remove"),null!=K)try{var m=P[K];0.8<m.opacity.value[0]?m.changeOpacity(0.85):m.changeOpacity(0.5)}catch(q){}}else 1==f.opacity.value[0]&&f.changeOpacity(0.85);if(K!=
wa&&null!=wa)try{m=P[wa],"_t"!=m.type.name.substr(m.type.name.length-2)?m.changeOpacity(1):m.changeOpacity(0.75)}catch(r){}wa=K}else K=null,1==la&&P[wa]&&(m=P[wa],"_t"!=m.type.name.substr(m.type.name.length-2)?m.changeOpacity(1):m.changeOpacity(0.75)),1!=f.opacity.value[0]&&f.changeOpacity(1),Q.position.value[1]=1E4,m=0,10>X.value[1]&&(m=Math.abs(X.value[1]-10)),ba.copy(l.direction),X.copy(ba.multiplyScalar(500).addSelf(s.matrix.position)),ja.copy(l.direction.multiplyScalar(500-4*m).addSelf(s.matrix.position)),
x=!1,!B&&!AcademyKeys.keySpace&&b.setCursor("hand")};b.changeGhostBrick=function(){f&&(Ja=f.position,c.removeObject(f));var a=k,d=v;if(1==T||3==T)d=k,a=v;var n=0.85;x||(n=1);F?f=new GLEGO.BuildObject("brick_"+a+"_"+d+"_s_r0",C,n):q?("window"==p&&(f=new GLEGO.BuildObject("brick_window_r0",C,n)),"door"==p&&(f=new GLEGO.BuildObject("brick_door_r0",C,n)),"1x1_round_open"==p&&(f=new GLEGO.BuildObject("1x1_round_open",C,n)),"1x1_round_straight"==p&&(f=new GLEGO.BuildObject("1x1_round_straight",C,n)),"1x1_round_withouttop"==
p&&(f=new GLEGO.BuildObject("1x1_round_withouttop",C,n)),"1x4_antenna"==p&&(f=new GLEGO.BuildObject("1x4_antenna",C,n)),"1x4_arc"==p&&(f=new GLEGO.BuildObject("1x4_arc_r0",C,n)),"1x4_fence"==p&&(f=new GLEGO.BuildObject("1x4_fence_r0",C,n)),"2x2x2_barrel"==p&&(f=new GLEGO.BuildObject("2x2x2_barrel",C,n)),"brick_2_1_s_inverted"==p&&(f=new GLEGO.BuildObject("brick_2_1_s_inverted_r0",C,n)),"brick_2_2_s_inverted"==p&&(f=new GLEGO.BuildObject("brick_2_2_s_inverted_r0",C,n)),"1x3_flagpole"==p&&(f=new GLEGO.BuildObject("1x3_flagpole_r0",
C,n)),"1x1_round_transparent"==p&&(f=new GLEGO.BuildObject("1x1_round_straight_t",C,n)),"1x1_transparent"==p&&(f=new GLEGO.BuildObject("brick_1_1_l_t",C,n))):f=new GLEGO.BuildObject("brick_"+a+"_"+d+"_"+b.getType(),C,n);f.rotation.value[1]=T*Math.PI/2;x?f.position=Ja:f.position.copy(ja);c.addObject(f);Ga&&b.showIcon()};b.updateUiBrickColor=function(){var a=k,c=v;if(1==T||3==T)a=v,c=k;b.updateBrickPreview(a,c,t,F,H);7==fa&&!qa&&b.autoPlaceBrick();5==fa&&qa&&b.autoPlaceBrick();$("#original-bricks").css({backgroundImage:"url(/"+
window._version+"/img/build/bricks/all/"+H+".png)"});$("#special-bricks").css({backgroundImage:"url(/"+window._version+"/img/build/bricks/special/"+H+".png)"});a=$('.colorpicker a[data-color="'+H+'"]');$(".colorpicker a").removeClass("active");$(".btn-choose-color").removeClass("btn-choose-color-"+"blue red orange yellow darkgreen green brown gray black white secret 5 135 138 154 193 199 212 221 222 226 268 297 321 326".split(" ").join(" btn-choose-color-")).addClass("btn-choose-color-"+H);a.addClass("active");
$(".btn-rotate svg path").css({fill:utils.getCssColor(H)});"white"==H?$(".btn-rotate svg path").attr("stroke","#ccc").attr("stroke-width","1px"):$(".btn-rotate svg path").removeAttr("stroke").removeAttr("stroke-width")};b.setBrickColor=function(a,c){b.setMode(0);H=a;C=utils.convertToLegacyColorIdentifier(a);c||(b.changeGhostBrick(),b.updateUiBrickColor(C));b.colorChange.dispatch(C);xa&&-1===Aa.indexOf(H)&&b.setBrickSize(4,2,3,!1,c)};b.translateBrickToCode=function(a,b,c,d,n,e,f){e&&(a=e,c=b=0);e=
{"4_2_3":"0000","2_4_3":"0000","2_2_1":"0001","1_4_1":"0002","2_4_1":"0003","4_1_1":"0002","4_2_1":"0003","1_1_1":"0004","1_1_3":"0005","1_2_3":"0006","2_1_3":"0006","1_4_3":"0007","4_1_3":"0007","2_2_3":"0008","1_2_3_s":"0009","2_3_3_s":"0010","2_1_3_s":"0009","3_2_3_s":"0010","2_8_3":"0011","8_2_3":"0011",window_0_0:"0012",door_0_0:"0013","1x1_round_open_0_0":"0014","1x1_round_straight_0_0":"0015","1x1_round_transparent_0_0":"0016","1x1_transparent_0_0":"0017",brick_2_2_s_inverted_0_0:"0018",brick_2_1_s_inverted_0_0:"0019",
"1x4_antenna_0_0":"0021","1x1_round_withouttop_0_0":"0023"};n=utils.convertFromLegacyColorIdentifier(n);a=a+"_"+b+"_"+c+(d?"_s":"");(null!=f?f:xa)?n="transparent/"+("1x1_round_transparent_0_0"==a?"round/":"square/")+n+".png":(utils.preloadBrickImages(e[a],n),isNaN(parseInt(n))||(n+="_"),n="hero/"+n+e[a]+".png");return n};b.updateBrickPreview=function(a,c,d,n,e){a=q?b.translateBrickToCode(a,c,d,n,e,p):b.translateBrickToCode(a,c,d,n,e);$("#current-piece img").attr("src","/"+window._version+"/img/build/bricks/"+
a)};b.setBrickSize=function(a,c,d,n,e){F=n?!0:!1;q=!1;b.setMode(0);b.toggleTransparency(!1);k=a;v=c;t=d;if(1==T||3==T)k=c,v=a;e||(b.changeGhostBrick(),b.updateBrickPreview(a,c,d,F,H))};b.setSpecialBrick=function(a,c){p=a;F=!1;q=!0;b.setMode(0);b.toggleTransparency(!1);"window"==a.toLowerCase()&&(k=2,v=4,t=9);"door"==a.toLowerCase()&&(k=2,v=4,t=15);"1x1_round_open"==a.toLowerCase()&&(v=k=1,t=3);"1x1_round_straight"==a.toLowerCase()&&(t=v=k=1);"1x1_round_withouttop"==a.toLowerCase()&&(v=k=1,t=3);"1x4_antenna"==
a.toLowerCase()&&(v=k=1,t=12);"1x4_arc"==a.toLowerCase()&&(k=4,v=1,t=3);"1x4_fence"==a.toLowerCase()&&(k=4,v=1,t=3);"2x2x2_barrel"==a.toLowerCase()&&(v=k=2,t=6);"brick_2_1_s_inverted"==a.toLowerCase()&&(k=2,v=1,t=9);"brick_2_2_s_inverted"==a.toLowerCase()&&(v=k=2,t=3);"1x3_flagpole"==a.toLowerCase()&&(k=1,v=3,t=12);"1x1_transparent"==a.toLowerCase()&&(t=v=k=1,b.toggleTransparency(!0));"1x1_round_transparent"==a.toLowerCase()&&(t=v=k=1,b.toggleTransparency(!0));var d=k,n=v;if(1==T||3==T)k=n,v=d;c||
(b.changeGhostBrick(),b.updateBrickPreview(a,0,0,0,H))};b.rotateBrick=function(a){for(;0==b.checkBrickBelow();)b.moveUp(),b.moveUp();var c=T;T+=a;0>T&&(T=3);3<T&&(T=0);a=k;k=v;v=a;Q.position.value[1]=1E4;0==c&&3==T&&(f.rotation.value[1]=4*Math.PI/2);3==c&&0==T&&(f.rotation.value[1]=-1*Math.PI/2);f.rotation.y=f.rotation.value[1];(new TWEEN.Tween(f.rotation)).to({y:T*Math.PI/2},150).easing(TWEEN.Easing.Sinusoidal.EaseOut).onUpdate(function(){f.rotation.value[1]=f.rotation.y}).onComplete(function(){!q&&
!F&&(T=c);b.changeGhostBrick();4==fa&&!qa&&b.autoPlaceBrick();2==fa&&qa&&b.autoPlaceBrick()}).start();b.rotation.dispatch(T)};b.takeSnapShot=function(a){var c=g,d=45*Math.PI/180+Math.floor(c/(2*Math.PI))*2*Math.PI,c=180*c/Math.PI;180<(c+360)%360&&(g-=2*Math.PI);h=d;z=320;ia=0;b.setCameraFocus(0);qb=a;setTimeout(b.initSnapShot,500)};b.initSnapShot=function(){var a=1+Math.floor(3*Math.random());Sound.playStaticSound(Sound["camera_"+a],0.5);aa.visible=!1;f.visible=!1;b.updateCamera(600);c.resize(262,
262);c.render();a=c.getDomElement().toDataURL();g=h=135*Math.PI/180;b.updateCamera(600);c.render();var d=c.getDomElement().toDataURL();g=h=225*Math.PI/180;b.updateCamera(600);c.render();var n=c.getDomElement().toDataURL();g=h=315*Math.PI/180;b.updateCamera(600);c.render();var e=c.getDomElement().toDataURL();qb([a,d,n,e]);c.resize(window.innerWidth- -200,window.innerHeight-60);Ba=0;aa.visible=!0;f.visible=!0;g=h=45*Math.PI/180};b.setPredefinedRotation=function(a){3==fa&&!qa&&b.autoPlaceBrick();var c=
g,d=a*Math.PI/180+Math.floor(c/(2*Math.PI))*2*Math.PI,c=180*c/Math.PI,c=(c+360)%360;180>c&&315<=a&&(g+=2*Math.PI);180<c&&45>=a&&(g-=2*Math.PI);h=d;z=320;ia=0;b.setCameraFocus(0)};b.setRotation=function(a){3==fa&&!qa&&b.autoPlaceBrick();h=g=a=a*Math.PI/180};b.updateCurrentAngle=function(){b.currentAngle=(180*h/Math.PI+360)%360;b.currentAngle!=b.oldAngle&&$(".rotate .builder-rotator img").css({"-webkit-transform":"rotate("+b.currentAngle+"deg)","-moz-transform":"rotate("+b.currentAngle+"deg)"});b.oldAngle=
b.currentAngle};b.setCameraFocus=function(a){M=100*a;1003==ArCollected.getCurrentLevel()&&(2==n&&gb)&&b.getNextRow()};b.zoom=function(a){ia+=2*a;0>ia&&(ia=0);18<ia&&(ia=18)};b.setMode=function(a){la=a;0==la?($(".btn-remove").removeClass("active"),f&&(f.visible=!0)):($(".btn-remove").addClass("active"),f&&(f.visible=!1))};b.undo=function(){if(!(0>=na.length)){var a=na[0];"remove"==a.type&&(K=a.id,b.removeBrick(!0));if("add"==a.type){var c=T,d=k,n=v,e=t,f=C,g=F,D=q,h=p,l=la,a=a.props;T=a.rotation;var E=
a.brickw,m=a.brickd;if(1==T||3==T)E=a.brickd,m=a.brickw;b.setBrickSize(E,m,a.brickh,a.isSloped,!0);b.setBrickColor(a.color,!0);ka=a.gridPositionX;da=a.gridPositionZ;W=a.gridPositionY;q=a.isSpecial;p=a.specialType;b.setBrick(!0,!0);T=c;b.setBrickSize(d,n,e,g,!0);b.setBrickColor(f,!0);q=D;p=h;la=l;b.setMode(la)}na.shift()}};b.addUndo=function(a){na.unshift(a);10<na.length&&na.pop()};b.reset=function(){if(!(0>=ma.length)){for(var a=0;a<ma.length;a++){K=ma[a].id;var b=P[K];b&&(c.removeObject(b),y.removeObject(b),
P[K]=null,Q.position.value[1]=1E4)}ma=[]}};b.addResetter=function(a){ma.unshift(a);1E7<ma.length&&ma.pop()};b.setCursor=function(a){a!=pb&&(document.getElementById("container").style.cursor=rb[a],pb=a)};b.pauseRender=function(){a=!1};b.playRender=function(){a||(a=!0,requestAnimationFrame(b.render))};b.render=function(){if(a){nb=(new Date).getTime();Va=nb-ob;ob=nb;if(isNaN(Va)||1E3<Va||0==Va)Va=1E3/60;TWEEN.update();b.updateCamera();c.render();requestAnimationFrame(b.render)}};b.updateCamera=function(a){ib&&
(0!=kb-U&&(h-=(kb-U)/500),0!=lb-R&&(z+=lb-R,200>z&&(z=200),600<z&&(z=600)),b.shootRay());kb=U;lb=R;x?(f.rotation.value[2]=0,f.rotation.value[0]=0):(f.position.value[0]+=(ja.value[0]-f.position.value[0])/3,f.position.value[1]+=(ja.value[1]-f.position.value[1])/3,f.position.value[2]+=(ja.value[2]-f.position.value[2])/3,f.rotation.value[2]=U/window.innerWidth/2,f.rotation.value[0]=R/window.innerHeight/2);ia+=ya;0>ia&&(ia=0);25<ia&&(ia=25);Ba+=(ia-Ba)/6;GLOW.Matrix4.makeProjection(30-Ba,s.aspect,s.near,
s.far,s.projection);g+=(h-g)/4;G+=(z-(G-M))/10;m.value[1]+=(M-m.value[1])/10;m.value[0]+=(r-m.value[0])/10;m.value[2]+=(A-m.value[2])/10;var c=800-z;a&&(c=a);s.matrix.setPosition(m.value[0]+Math.cos(g)*c,G,m.value[2]+Math.sin(g)*c);b.updateCurrentAngle();s.target.copy(m);s.matrix.lookAt(s.target,s.up)};b.onDocumentMouseMove=function(a){var c="";null!=a.target.firstChild&&(c=a.target.firstChild.toString());if("[object HTMLCanvasElement]"==c){a.preventDefault();a=e.relMouseCoords(a);var c=U,d=R;U=a.x-
e.width/2;R=a.y-e.height/2;Z=2*(a.x/e.width)-1;N=2*(a.y/e.height)-1;200<(new Date).getTime()-w&&(U!=c||R!=d)&&b.shootRay();B||B&&AcademyKeys.keySpace?(ib=!0,2==fa&&!qa&&b.autoPlaceBrick()):ib=!1}};b.onDocumentMouseDown=function(a){var c="";null!=a.target.firstChild&&(c=a.target.firstChild.toString());"[object HTMLCanvasElement]"==c&&(a.preventDefault(),x&&!AcademyKeys.keySpace?2==a.button?(b.shootRay(),b.removeBrick(),f.visible=!1):1==la?(b.shootRay(),b.removeBrick()):b.setBrick():(e.relMouseCoords(a),
b.setCursor("handdown"),B=!0))};b.onDocumentMouseUp=function(a){a.preventDefault();B=!1};b.onDocumentMouseWheel=function(a){var b=0;a.wheelDelta?b=a.wheelDelta/1E3:a.detail&&(b=-a.detail/20);ia+=10*b;0>ia&&(ia=0);18<ia&&(ia=18);a.preventDefault()};b.onWindowResize=function(a){c.resize(window.innerWidth- -200,window.innerHeight-60)};b.getType=function(){var a="h";1==t&&(a="l");F&&(a="s_r"+T);q&&(a="r"+T);return a};b.getBrickValue=function(a,b){var c=1;a&&(c=3);b&&(c=15);return c};b.setBuildNumber=
function(a){u=a};b.save=function(){if(1>O||!u)return!1;var a=GLEGO.DataFactory.encode(P,null,J);$.post("/api/builds/"+u,{buildData:a.buildData,structure:a.structure},function(a){},"json");return!0};b.loadUrl=function(){return"/api/builds/"+u+"/data?_="+(new Date).getTime()};b.getId=function(){return u};b.publish=function(a,b,c,d){$.post("/api/builds/"+u+"/publish",{email:a,defaultImage:c,category:b},function(a){"user_banned"==a.status?(a=$("<div>"),a.append("<h2>"+_("notifications_attention")+"</h2>"),
a.append("<p>"+_("notifications_inappropriate_behavior_1")+"</p>"),a.append("<p>"+_("notifications_inappropriate_behavior_2")+"</p>"),a.append("<p>"+_("notifications_inappropriate_behavior34")+"</p>"),new Popup({content:a,submitLabel:"Ok",hideCancel:!0})):(window.clearInterval(jb),d(u))},"json")};b.toggleTransparency=function(a){xa=a;f&&(a?f.changeOpacity(0.5):f.changeOpacity(1))};b.countPlacedBricks=function(a,c){if(!fb&&!Na)if(-1<$.inArray(a,ca)?c?ra++:ra--:c?oa++:oa--,"7001"==ArCollected.getCurrentLevel())ArCollected.getRound();
else if(1==Ma)if(Ua)if(hb){if(!sa&&0<oa?(za=1,sa=!0,b.send(ArCollected.sendObj("warning")),b.playWarningSound()):oa>za&&(b.playWarningSound(),za++),sa&&0==oa&&(academy.removeWarningInstructions(),sa=!1,za=0),ra==ca.length-Ca&&0==oa)if(2==n){for(var d=!0,e=0;e<P.length;e++)P[e]&&"orange"==P[e].color.name&&(d=!1);d&&b.getNextRow()}else if(3==n){d=!0;for(e=0;e<P.length;e++)P[e]&&"gray"==P[e].color.name&&(d=!1);d&&b.getNextRow()}}else!sa&&ra+Ca<ca.length?(b.send(ArCollected.sendObj("warning")),b.playWarningSound(),
sa=!0,za=ca.length-(ra+Ca)):sa&&ra+Ca==ca.length&&Math.abs(Ca)>=oa?(sa=!1,academy.removeWarningInstructions(),za=0):sa&&ra+Ca<ca.length&&ca.length-(ra+Ca)>za&&(b.playWarningSound(),za=ca.length-(ra+Ca)),Math.abs(Ca)<oa&&!sa&&(b.send(ArCollected.sendObj("warning")),b.playWarningSound(),sa=!0),ra==ca.length-Ca&&0==oa&&b.getNextRow();else!sa&&0<oa?(za=1,sa=!0,b.send(ArCollected.sendObj("warning")),b.playWarningSound()):oa>za&&(b.playWarningSound(),za++),sa&&0==oa&&(academy.removeWarningInstructions(),
sa=!1,za=0),ra==ca.length-Ca&&0==oa&&b.getNextRow();else if(2==Ma)if(1==n)ra==ca.length&&(Qa=[],b.getNextRow());else{c?Qa.push(a):(d=Qa.indexOf(a),-1<d&&Qa.splice(d,1));for(var f=e=d=0,g=0;g<Qa.length;g++){var D=Qa[g].split(",");D[4]=parseInt(D[4]);D[5]=parseInt(D[5]);f+=D[4]*D[5]}for(g=0;g<ca.length;g++){D=ca[g].split(",");D[1]=parseInt(D[1]);D[3]=parseInt(D[3]);for(var k=0;k<Qa.length;k++){var h=Qa[k].split(",");if("1"!=h[6]||"0"!=h[8]||"undefined"!=h[10]){e++;break}else if(D[0]==h[0]&&(h[4]=parseInt(h[4]),
h[5]=parseInt(h[5]),h[7]=parseInt(h[7]),h[9]=parseInt(h[9]),D[1]>=h[7]&&D[1]<=h[7]+h[4]-1&&D[3]>=h[9]&&D[3]<=h[9]+h[5]-1)){d++;break}}}d!=f&&e++;0<e&&!sa?(b.send(ArCollected.sendObj("warning")),b.playWarningSound(),sa=!0,za=1):sa&&0<e?(b.playWarningSound(),za++):0==e&&sa&&(sa=!1,za=0,academy.removeWarningInstructions());d==ca.length&&0==e&&b.getNextRow()}};b.createPrObj=function(a,b,c,d,n,e){return{msgtype:a,bricks:"",small_image:b,large_images:c,character:"vitruvius",message:d,animate:"true",icon:e,
instructionNumber:Math.floor(10*Math.random())+1,checkmark:n}};b.autoPlaceBrick=function(){if(Na)if(0==fa)fa++,qa?b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre1.jpg ",["/img/instructions/preDesk/big/pre1.jpg"],"academy_challenge_1a_instruction_1a",!1,"")):(b.send(b.createPrObj("instruction","",[],"academy_challenge_1a_instruction_1a",!1,"")),b.autoPlaceBrick());else if(1==fa)qa?b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre3.jpg ",["/img/instructions/preDesk/big/pre3.jpg"],
"academy_protip_9",!1,"")):b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre1.jpg ",["/img/instructions/preDesk/big/pre1.jpg"],"academy_challenge_1a_instruction_1a",!1,"")),fa++;else if(2==fa)qa?b.send(b.createPrObj("instruction","/img/instructions/preMob/mpre5.jpg ",["/img/instructions/preMob/big/mpre5.jpg"],"academy_challenge_1a_instruction_4b",!0,"")):b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre2.jpg ",["/img/instructions/preDesk/big/pre2.jpg"],"academy_challenge_1a_instruction_3",
!0,"")),fa++;else if(3==fa)qa?b.send(b.createPrObj("instruction","/img/instructions/preMob/mpre2.jpg ",["/img/instructions/preMob/big/mpre2.jpg"],"academy_challenge_1a_instruction_6",!0,"")):b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre3.jpg ",["/img/instructions/preDesk/big/pre3.jpg"],"academy_protip_9",!0,"")),fa++;else if(4==fa)qa?b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre6.jpg ",["/img/instructions/preDesk/big/pre6.jpg"],"academy_challenge_1a_instruction_8",
!0,"")):b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre4.jpg ",["/img/instructions/preDesk/big/pre4.jpg"],"academy_challenge_1a_instruction_4",!0,"")),fa++;else if(5==fa)if(fa++,qa){Na=!1;b.reset();J=[];for(var a=0;85>=a;++a){J.push([]);for(var c=0;32>c;++c){J[a].push([]);for(var d=0;32>d;++d)J[a][c].push(0)}}ca=ArCollected.getRound(n)[0].arr;b.autoPlaceBrick()}else b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre5.jpg ",["/img/instructions/preDesk/big/pre5.jpg"],
"academy_challenge_1a_instruction_5",!0,""));else if(6==fa)b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre6.jpg ",["/img/instructions/preDesk/big/pre6.jpg"],"academy_challenge_1a_instruction_7",!0,"")),fa++;else{if(7==fa){fa++;Na=!1;b.reset();J=[];for(a=0;85>=a;++a){J.push([]);for(c=0;32>c;++c){J[a].push([]);for(d=0;32>d;++d)J[a][c].push(0)}}ca=ArCollected.getRound(n)[0].arr;b.autoPlaceBrick()}}else{ta=!1;f.visible=!1;E=k;Ra=v;Xa=t;Ya=F;Za=C;$a=T;ab=xa;bb=q;cb=p;console.log("SAVED: "+
E+" "+Ra+" "+Xa+" "+Ya+" "+Za+" "+$a+" "+ab+" "+bb+" "+cb);b.freezeListeners();for(var e=D,a=D;a<ca.length;a++)(function(a){setTimeout(function(){var c=ca[a].split(",");b.setBrickColor(c[0],!0);var d="true"==c[2],n="true"==c[3];T="x"==c[1]?0:parseInt(c[1]);var e=parseInt(c[4]),f=parseInt(c[5]);if(1==T||3==T)e=[f,f=e][0];b.setBrickSize(e,f,parseInt(c[6]),d,!0);ka=parseInt(c[7]);W=parseInt(c[8]);da=parseInt(c[9]);n?b.setSpecialBrick(c[10],!0):xa=1>parseInt(c[11])?!0:!1;b.setBrick(!0,!0)},(a-e)*Math.max(180*
Math.pow(0.98,a-e),40))})(a)}};b.autoPlaceFinnish=function(){console.log("autoPlaceFinnish");console.log("PLACING: "+E+" "+Ra+" "+Xa+" "+Ya+" "+Za+" "+$a+" "+ab+" "+bb+" "+cb);xa=ab;bb?b.setSpecialBrick(cb,!0):b.setBrickSize(E,Ra,Xa,Ya,!0);T=$a;b.setBrickColor(Za,!0);b.unFreeze();f.visible=!0};b.getNextRow=function(){if(1003==ArCollected.getCurrentLevel()&&2==n&&!gb)b.send(b.createPrObj("instruction","/img/instructions/preDesk/pre7.jpg",["/img/instructions/preDesk/pre7.jpg"],"academy_protip_7",!0,
"/img/academy/zoom-instruction-icon.png")),gb=!0;else{console.log("getNextRow");Ta=[];n++;D=ca.length;var a=ArCollected.getRound(n);if("finished"==a[0].stat)mb&&b.autoPlaceFinnish(),b.unFreeze(),f.visible=!0,window.cd&&window.cd.kill();else{Ua=!1;if(6002==ArCollected.getCurrentLevel()){if(2==n||3==n)Ua=!0;window.cd&&window.cd.kill();var c=90;if(5==n||6==n)c=120;7==n&&(c=60);2!=n&&(window.cd=new window.academyCountdown({container:"#gui",totalTime:c,onTimeEnded:function(){window.academy.showBuildDone({success:!1})}}),
window.cd.selfUpdate())}c=a[0].arr.splice(0,1);Ca+=parseInt(a[0].arr.splice(0,1));for(var d=0;d<a[0].arr.length;d++)ca.push(a[0].arr[d]);hb=mb=!1;if(6002==ArCollected.getCurrentLevel()&&(2==n||3==n))hb=!0,b.autoPlaceFinnish(),b.unFreeze();else if(0>c){ca=[];for(d=0;d<a[0].arr.length;d++)ca.push(a[0].arr[d]);Ua=!0;oa-=c;b.autoPlaceFinnish();b.unFreeze()}else if("0"==c)b.autoPlaceFinnish(),b.unFreeze();else if("1"==c)mb=!0,b.autoPlaceBrick();else if("3"==c){ca=[];for(d=0;d<a[0].arr.length;d++)ca.push(a[0].arr[d]);
b.autoPlaceFinnish();b.unFreeze()}else"5"==c&&b.autoPlaceFinnish()}}};b.cheatRow=function(){b.autoPlaceBrick();b.unFreeze();f.visible=!0};b.send=function(a){"finish"==a.msgtype&&(fb=!0,a.checkmark=!0,"7001"==ArCollected.getCurrentLevel()&&(a.keepCurrentInst=!0,a.checkmark=!1));window.academy.sendInstruction(a)};b.load=function(a){var c=T,d=k,n=v,e=t,f=C,g=F,D=q,h=p,l=new Image;l.onload=function(){for(var a=GLEGO.DataFactory.decodeToBuild(l),k=0;k<a.length;++k){var E=a[k];if(!(void 0==E||null==E)){var m=
E.type.name;T=0;-1!=m.indexOf("_r1")&&(T=1);-1!=m.indexOf("_r2")&&(T=2);-1!=m.indexOf("_r3")&&(T=3);var r=E.type.size.x,v=E.type.size.y,s=E.type.size.z;if(1==T||3==T)r=E.type.size.z,s=E.type.size.x;var t=!1;-1!=m.indexOf("_s_")&&(t=!0);b.setBrickSize(r,s,v,t,!0);-1!=m.indexOf("window")&&b.setSpecialBrick("window",!0);-1!=m.indexOf("door")&&b.setSpecialBrick("door",!0);-1!=m.indexOf("1x1_round_open")&&b.setSpecialBrick("1x1_round_open",!0);-1!=m.indexOf("1x1_round_straight")&&b.setSpecialBrick("1x1_round_straight",
!0);-1!=m.indexOf("1x1_round_withouttop")&&b.setSpecialBrick("1x1_round_withouttop",!0);-1!=m.indexOf("1x4_antenna")&&b.setSpecialBrick("1x4_antenna",!0);-1!=m.indexOf("1x4_arc")&&b.setSpecialBrick("1x4_arc",!0);-1!=m.indexOf("1x4_fence")&&b.setSpecialBrick("1x4_fence",!0);-1!=m.indexOf("2x2x2_barrel")&&b.setSpecialBrick("2x2x2_barrel",!0);-1!=m.indexOf("brick_2_1_s_inverted")&&b.setSpecialBrick("brick_2_1_s_inverted",!0);-1!=m.indexOf("brick_2_2_s_inverted")&&b.setSpecialBrick("brick_2_2_s_inverted",
!0);-1!=m.indexOf("1x3_flagpole")&&b.setSpecialBrick("1x3_flagpole",!0);b.setBrickColor(E.color.name,!0);var E=E.position,m=Math.floor(E.value[0]/LDF.LU.x),v=Math.floor(E.value[2]/LDF.LU.z),t=Math.floor(r/2),Ra=Math.floor(s/2);if(1==T||3==T)t=Math.floor(s/2),Ra=Math.floor(r/2);ka=m+16-t;da=v+16-Ra;W=Math.round(E.value[1]/LDF.LUF.y);b.setBrick(!0,!0)}}Ga=!0;T=c;b.setBrickSize(d,n,e,g,!0);b.setBrickColor(f,!0);q=D;p=h;b.loadReady.dispatch()};l.src=a;try{S.tween.stop(),aa.tween.stop(),V.tween.stop(),
L.tween.stop(),b.addListeners()}catch(E){}S.position.set(0,-1.3,0);aa.position.set(0,-12,0);V.position.set(11*LDF.LU.x,-6.3,16*LDF.LU.z);L.position.set(13*LDF.LU.x,-6.3,16*LDF.LU.z)};return b}();HTMLCanvasElement.prototype.relMouseCoords=function(a){var b=0,c=0,e=0,y=0,e=this;do b+=e.offsetLeft,c+=e.offsetTop;while(e=e.offsetParent);e=a.pageX-b;y=a.pageY-c;e=Math.round(e*(this.width/this.offsetWidth));y=Math.round(y*(this.height/this.offsetHeight));return{x:e,y:y}};var Keys=function(){var a={keyLeft:!1,keyRight:!1,keyUp:!1,keyDown:!1,keySpace:!1,keyShift:!1,keyZ:!1,keyCmd:!1,onDocumentKeyDown:function(b){var c=b.keyCode;switch(c){case 38:a.keyUp=!0;break;case 37:Builder.rotateBrick(-1);a.keyLeft=!0;break;case 39:Builder.rotateBrick(1);a.keyRight=!0;break;case 40:a.keyDown=!0;break;case 32:a.keySpace||Builder.setCursor("hand");a.keySpace=!0;break;case 16:a.keyShift=!0;break;case 224:a.keyCmd=!0;break;case 91:a.keyCmd=!0;break;case 93:a.keyCmd=!0;break;case 90:a.keyZ=
!0,(b.ctrlKey||a.keyCmd)&&Builder.undo()}48<=c&&57>=c&&$($(".colorpicker a").eq(c-49)).trigger("click");a.keyShift&&80==c&&Builder.setBrickColor("221");a.keyShift&&73==c&&Builder.setSpecialBrick("1x4_antenna")},onDocumentKeyUp:function(b){switch(b.keyCode){case 38:a.keyUp=!1;break;case 37:a.keyLeft=!1;break;case 39:a.keyRight=!1;break;case 40:a.keyDown=!1;break;case 32:Builder.setCursor("normal");a.keySpace=!1;break;case 16:a.keyShift=!1;break;case 224:a.keyCmd=!1;break;case 91:a.keyCmd=!1;break;
case 93:a.keyCmd=!1;break;case 90:a.keyZ=!1}}};return a}();var AcademyKeys=function(){var a={keyLeft:!1,keyRight:!1,keyUp:!1,keyDown:!1,keySpace:!1,keyShift:!1,keyZ:!1,keyCmd:!1,onDocumentKeyDown:function(b){var c=b.keyCode;switch(c){case 38:a.keyUp=!0;break;case 37:BuilderAcademy.rotateBrick(-1);a.keyLeft=!0;break;case 39:BuilderAcademy.rotateBrick(1);a.keyRight=!0;break;case 40:a.keyDown=!0;break;case 32:a.keySpace||BuilderAcademy.setCursor("hand");a.keySpace=!0;break;case 16:a.keyShift=!0;break;case 224:a.keyCmd=!0;break;case 91:a.keyCmd=!0;break;case 93:a.keyCmd=
!0;break;case 90:a.keyZ=!0,(b.ctrlKey||a.keyCmd)&&BuilderAcademy.undo()}48<=c&&57>=c&&$($(".colorpicker a").eq(c-49)).trigger("click");a.keyShift&&80==c&&BuilderAcademy.setBrickColor("221");a.keyShift&&73==c&&BuilderAcademy.setSpecialBrick("1x4_antenna")},onDocumentKeyUp:function(b){switch(b.keyCode){case 38:a.keyUp=!1;break;case 37:a.keyLeft=!1;break;case 39:a.keyRight=!1;break;case 40:a.keyDown=!1;break;case 32:BuilderAcademy.setCursor("normal");a.keySpace=!1;break;case 16:a.keyShift=!1;break;case 224:a.keyCmd=
!1;break;case 91:a.keyCmd=!1;break;case 93:a.keyCmd=!1;break;case 90:a.keyZ=!1}}};return a}();var ProKeys=function(){var a={},b="lightgreyblue lightyellow lightpink darkpink purple graybeige darkbeige darkgrey greyblue darkorange darkred beige bonewhite".split(" ");a.keyLeft=!1;a.keyRight=!1;a.keyUp=!1;a.keyDown=!1;a.keySpace=!1;a.keyShift=!1;a.keyZ=!1;a.keyCmd=!1;a.onDocumentKeyDown=function(c){var e=c.keyCode;switch(e){case 38:a.keyUp=!0;break;case 37:ProBuilder.rotateBrick(-1);a.keyLeft=!0;break;case 39:ProBuilder.rotateBrick(1);a.keyRight=!0;break;case 40:a.keyDown=!0;break;case 32:a.keySpace||
ProBuilder.setCursor("hand");a.keySpace=!0;break;case 16:a.keyShift=!0;break;case 224:a.keyCmd=!0;break;case 91:a.keyCmd=!0;break;case 93:a.keyCmd=!0;break;case 90:a.keyZ=!0,(c.ctrlKey||a.keyCmd)&&ProBuilder.undo()}49<=e&&57>=e&&ProBuilder.setBrickColor(b[e-48]);81==e&&ProBuilder.setBrickColor("darkred");87==e&&ProBuilder.setBrickColor("beige");69==e&&ProBuilder.setBrickColor("bonewhite");65==e&&ProBuilder.setBrickColor("lightgreyblue");83==e&&ProBuilder.setBrickColor("whitetransparent");48==e&&ProBuilder.getNextRow();
88==e?ProBuilder.setSpecialBrick("1x1_round_straight"):67==e?ProBuilder.setSpecialBrick("1x1_round_withouttop"):86==e?ProBuilder.setSpecialBrick("1x4_antenna"):66==e?ProBuilder.setSpecialBrick("1x4_arc"):78==e?ProBuilder.setSpecialBrick("1x4_fence"):75==e?ProBuilder.setSpecialBrick("1x1_round_open"):77==e?ProBuilder.setSpecialBrick("2x2x2_barrel"):188==e?ProBuilder.setSpecialBrick("brick_2_1_s_inverted"):189==e?ProBuilder.setSpecialBrick("brick_2_2_s_inverted"):190==e?ProBuilder.setSpecialBrick("1x1_round_open"):
80==e&&ProBuilder.hideBrickforDesign();a.keyShift&&80==e&&ProBuilder.setBrickColor("secret")};a.onDocumentKeyUp=function(b){switch(b.keyCode){case 38:a.keyUp=!1;break;case 37:a.keyLeft=!1;break;case 39:a.keyRight=!1;break;case 40:a.keyDown=!1;break;case 32:ProBuilder.setCursor("normal");a.keySpace=!1;break;case 16:a.keyShift=!1;break;case 224:a.keyCmd=!1;break;case 91:a.keyCmd=!1;break;case 93:a.keyCmd=!1;break;case 90:a.keyZ=!1}};return a}();var ProBuilder=function(){var a={},b,c,e,y,s=new GLOW.Vector3(0,0,0),m=1.35,h=m,g=330,z=g,G=0,r,A,M=!1,Y=!0,u,d,I=0,l=0,f=0,U=0,R=0,Z=0,N=!1,B=!1,x=0,w=1,k=1,v=1,t="red",C=!1,H=!1,F,q=1,p=[],ea=0,P=null,O=null,K=0,wa=new GLOW.Vector3(0,200,0),T=new GLOW.Vector3(0,200,0),ja=new GLOW.Vector3,X,ba,S,Q,aa,V,L=0,J=null,W=null,ka=null,da=null,ga=[],ha=0,na=0,ma=0,ia=!1,Ba=null,la=0,xa=!1,Aa,Da,ya=!1,ua,pa=!1,Ea=!1,Ia=0,Fa=0,ta,Ka=!1,Oa,La=1,Ha=0;a.error=new signals.Signal;a.colorChange=new signals.Signal;
a.rotation=new signals.Signal;a.ready=new signals.Signal;a.loadReady=new signals.Signal;a.currentAngle=0;a.oldAngle=0;var Ga,Ja,ca,ra={normal:"default",point:"url(/assets/builder/pointer.png),pointer",remove:"url(/assets/builder/pointer_delete.png),pointer",no:"url(/assets/builder/pointer_no.png),pointer",hand:"url(/assets/builder/move.png),all-scroll",handdown:"url(/assets/builder/move_down.png),all-scroll"},oa="normal",Pa=null,Ma={context:{width:window.innerWidth-0,height:window.innerHeight-60,
preserveDrawingBuffer:!0,clear:{red:217/255,green:228/255,blue:232/255,alpha:1}},camera:{fov:30,near:0.1,far:3E3,aspect:(window.innerWidth-0)/(window.innerHeight-60),useTarget:!1,useXYZStyleTransform:!1},fog:{near:5E3,far:5E3,color:new GLOW.Color(217,228,232)},ambient:new GLOW.Color(11119017),directionalLights:[{intensity:0.18,color:new GLOW.Color(14669231),direction:new GLOW.Vector3(0,-1,0)},{intensity:1.2,color:new GLOW.Color(16771737),direction:new GLOW.Vector3(-1,-0.5,-1)}],pointLights:[{position:new GLOW.Vector3(55,
500,55),range:1E3,color:new GLOW.Color(16750688),intensity:0.9},{position:new GLOW.Vector3(-55,500,-55),range:1500,color:new GLOW.Color(11593434),intensity:0.8}],load:{shaders:["TextureUnlitGLSL"],geometry:["BrickGeometry","BuildGeometry"],textures:["BuildBasePlateShadowTexture","LegoLogoTexture"]}};a.onTouchStart=function(b){ta=!1;var f=b.touches[0].target.firstChild;null!=f&&"[object HTMLCanvasElement]"==f.toString()&&(b.preventDefault(),$(".brickIco").hide(),ta=!0,pa=Ea=ya=!1,MouseX=b.touches[0].clientX-
0-c.width/2,MouseY=b.touches[0].clientY-60-c.height/2,Ia=MouseX,Fa=MouseY,R=2*((b.touches[0].clientX-0)/c.width)-1,Z=2*((b.touches[0].clientY-60)/c.height)-1,d&&e.addObject(d),b=e.shoot(u.setFromMouse(R,Z,y)),b.didHit&&(b.reference!=d?a.shootRay(!0):pa=!0),d&&e.removeObject(d))};a.onTouchMove=function(b){b.preventDefault();if(ta)if(2==b.touches.length){ya=!0;d.visible=!1;var e=b.touches[1].clientX-b.touches[0].clientX,f=b.touches[1].clientY-b.touches[0].clientY;b=e*e+f*f;1E3<Math.abs(ua-b)?null==
Ba?ua=Ba=b:ua>b?la=-0.35:ua<b&&(la=0.35):la=0;ua=b;e=Math.atan2(f,e);xa?(0.01<Math.abs(Da-(e-Aa))&&(Da>e-Aa?(f=Math.abs(e-Aa)/20,0.15<f&&(f=0.08),m+=f):(f=Math.abs(e-Aa)/20,0.15<f&&(f=0.08),m-=f)),Da=e-Aa):(Aa=e,xa=!0,Da=e)}else MouseX=b.touches[0].clientX-0-c.width/2,MouseY=b.touches[0].clientY-60-c.height/2,pa&&(e=MouseX-Ia,f=MouseY-Fa,200<e*e+f*f&&(pa=!1)),pa||(Ea=!0,R=2*((b.touches[0].clientX-0)/c.width)-1,Z=2*((b.touches[0].clientY-60)/c.height)-1,ya||200<(new Date).getTime()-x&&a.shootRay()),
la=0};a.findNewSpot=function(){a.shootRay()};a.onTouchEnd=function(b){ta&&(!ya&&!Ea&&(B?1==ma?(a.shootRay(),a.removeBrick(),d.visible=!1):(pa||a.findNewSpot(),a.setBrick(),d.visible=!0):d.visible=!1),d.visible&&a.showOverlayIcon(),x=0,xa=!1,Ba=null,la=ua=0)};a.showOverlayIcon=function(){a.checkOccupied()?$(".brickIco").css("background-position","0px 15px"):$(".brickIco").css("background-position","0px 0px");a.showIcon()};a.showIcon=function(){var a=(new GLOW.Vector3).copy(d.position);y.projection.multiplyVector3(y.inverse.multiplyVector3(a));
var b=(0.5*a.value[0]+0.5)*(window.innerWidth-0),a=(0.5*-a.value[1]+0.5)*(window.innerHeight-60);$(".brickIco").css({top:a-40+"px",left:b+260+"px"});$(".brickIco").show()};a.init=function(c,d,e,f,g,h,k){console.log("initiating new build on tile "+e+", "+f);levSplit=["7001","1"];typofLevel=levSplit[1];ArCollected.setCurrentLevel(levSplit[0]);facArr=ArCollected.getRound(La)[0].arr;console.log("Level: "+levSplit[0]);console.log("LevelType: "+levSplit[1]);r=c;Y=!0;plateId=h;A=d;b=new GLEGO.BuildRenderer;
b.initialized.addOnce(a.setup,a);b.init(Ma);$("#location .map img").attr("src",ProBuilder.mapImageUrl(e,f));setInterval("Builder.save()",8E3)};a.setup=function(d){e=new GLEGO.Collider;u=new GLEGO.Ray;y=b.getCamera();V=[];for(d=0;85>=d;++d){V.push([]);for(var f=0;32>f;++f){V[d].push([]);for(var k=0;32>k;++k)V[d][f].push(0)}}a.setBrickSize(2,4,3);ba=new GLEGO.BuildObject("checkplane","white");ba.scale.set(1,0.01,1);ba.position.value[0]=1E4;ba.visible=!1;b.addObject(ba);e.addObject(ba);X=new GLEGO.BuildBasePlate("brick_32_32_h",
r);X.position.set(0,-1.3,0);b.addObject(X);e.addObject(X);S=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","shadow",{uTexture:GLEGO.Shaders.getTexture("BuildBasePlateShadowTexture")});b.addObject(S);S.position.set(0,-12,0);Q=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","legologoplane",{uTexture:GLEGO.Shaders.getTexture("LegoLogoTexture")});b.addObject(Q);Q.position.set(11*LDF.LU.x,-6.3,16*LDF.LU.z);d=document.createElement("canvas");d.width=128;d.height=64;f=d.getContext("2d");f.fillStyle=
"rgb(73,73,73)";f.fillRect(0,0,128,64);f.fillStyle="rgb(255, 255, 255)";f.font="bold 20px Arial";f.textAlign="center";f.fillText("No. "+plateId,64,40);k=f.createLinearGradient(0,0,0,64);k.addColorStop(0,"rgba(0, 0, 0, 0.3)");k.addColorStop(1,"rgba(0, 0, 0, 0.05)");f.fillStyle=k;f.fillRect(0,0,128,64);aa=(new GLEGO.Object3D).applyShader("TextureUnlitGLSL","numberplane",{uTexture:new GLOW.Texture({data:d,filter:GL.LINEAR,wrap:GL.CLAMP_TO_EDGE})});b.addObject(aa);aa.position.set(13*LDF.LU.x,-6.3,16*
LDF.LU.z);Y||(h=m=Math.PI/4,z=g=320);Y?(setTimeout(a.playSwishSound,150),setTimeout(a.autoPlaceBrick,1800),X.position.value[1]+=300,X.position.y=X.position.value[1],X.tween=(new TWEEN.Tween(X.position)).to({y:-1.3},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){X.position.value[1]=X.position.y}).onComplete(a.addListeners),X.tween.start(),S.position.value[1]+=300,S.position.y=S.position.value[1],S.tween=(new TWEEN.Tween(S.position)).to({y:-12},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){S.position.value[1]=
S.position.y}),S.tween.start(),Q.position.value[1]+=300,Q.position.y=Q.position.value[1],Q.tween=(new TWEEN.Tween(Q.position)).to({y:-6.3},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){Q.position.value[1]=Q.position.y}),Q.tween.start(),aa.position.value[1]+=300,aa.position.y=aa.position.value[1],aa.tween=(new TWEEN.Tween(aa.position)).to({y:-6.3},1800).easing(TWEEN.Easing.Elastic.EaseOut).onUpdate(function(){aa.position.value[1]=aa.position.y}),aa.tween.start()):(a.addListeners(),
a.autoPlaceBrick());c=b.getDomElement();GLEGO.error.add(a.onError);document.getElementById("container").appendChild(b.getDomElement());requestAnimationFrame(a.render);a.ready.dispatch()};a.playSwishSound=function(){Sound.playStaticSound(Sound.swish,0.5)};a.onError=function(b){a.error.dispatch()};a.addListeners=function(){M||(window.addEventListener("resize",a.onWindowResize,!1),document.addEventListener("contextmenu",function(a){a.preventDefault()},!1),document.addEventListener("mousemove",a.onDocumentMouseMove,
!1),document.addEventListener("mousedown",a.onDocumentMouseDown,!1),document.addEventListener("mouseup",a.onDocumentMouseUp,!1),document.addEventListener("keydown",ProKeys.onDocumentKeyDown,!1),document.addEventListener("keyup",ProKeys.onDocumentKeyUp,!1),document.addEventListener("mousewheel",a.onDocumentMouseWheel,!1),document.addEventListener("DOMMouseScroll",a.onDocumentMouseWheel,!1),document.addEventListener("touchstart",a.onTouchStart,!1),document.addEventListener("touchmove",a.onTouchMove,
!1),document.addEventListener("touchend",a.onTouchEnd,!1),M=!0)};a.removeBrick=function(c){var d=L-1;0>d&&(d=0);var f=V[d][J][W];null!=P&&(f=P);if(0!=f){var g=p[f];c||(a.addUndo({type:"add",props:{brickw:g.props.brickw,brickd:g.props.brickd,brickh:g.props.brickh,isSloped:g.props.isSloped,rotation:g.props.rotation,color:g.props.color,isSpecial:g.props.isSpecial,specialType:g.props.specialType,gridPositionX:g.props.gridPositionX,gridPositionY:g.props.gridPositionY,gridPositionZ:g.props.gridPositionZ}}),
console.log('"'+g.props.color+","+g.props.gridPositionX+","+g.props.gridPositionY+","+g.props.gridPositionZ+'"'));if(null!=P){try{if(void 0==g.props)return}catch(h){return}var k=g.props.gridPositionX-8;0>k&&(k=0);c=g.props.gridPositionX+8;32<c&&(c=32);var l=g.props.gridPositionZ-8;0>l&&(l=0);var m=g.props.gridPositionZ+8;32<m&&(m=32);d=g.props.gridPositionY}else k=J-8,0>k&&(k=0),c=J+8,32<c&&(c=32),l=W-8,0>l&&(l=0),m=W+8,32<m&&(m=32);for(;k<c;++k)for(var q=l;q<m;++q)for(var r=d-16;r<d+16;++r)try{V[r][k][q]==
f&&(V[r][k][q]=0)}catch(s){}d=0.2+0.2*Math.random();Sound.playStaticSound(Sound.remove,d);ea-=a.getBrickValue(g.props.isSloped,g.props.isSpecial);updateBrickCount(ea);b.removeObject(g);e.removeObject(g);p[f]=null;ba.position.value[1]=1E4}};a.setBrick=function(c,f){var g=c||!1;if(!(1E6<=ea)&&(f||(L=Math.round(d.position.value[1]/LDF.LUF.y)),!a.checkOccupied())){var h=a.checkBrickBelow();f&&(h=0);var l=J-16,m=W-16,r=a.checkBrickAbove();if(r&&0==h||f)g=!0;var s="";ia&&(s="_t");var u;H?("window"==F&&
(u=new GLEGO.BuildObject("brick_window_"+a.getType(),t)),"door"==F&&(u=new GLEGO.BuildObject("brick_door_"+a.getType(),t)),"1x1_round_open"==F&&(u=new GLEGO.BuildObject("1x1_round_open",t)),"1x1_round_straight"==F&&(u=new GLEGO.BuildObject("1x1_round_straight",t)),"1x1_round_withouttop"==F&&(u=new GLEGO.BuildObject("1x1_round_withouttop",t)),"1x4_antenna"==F&&(u=new GLEGO.BuildObject("1x4_antenna",t)),"1x4_arc"==F&&(u=new GLEGO.BuildObject("1x4_arc_"+a.getType(),t)),"1x4_fence"==F&&(u=new GLEGO.BuildObject("1x4_fence_"+
a.getType(),t)),"2x2x2_barrel"==F&&(u=new GLEGO.BuildObject("2x2x2_barrel",t)),"brick_2_1_s_inverted"==F&&(u=new GLEGO.BuildObject("brick_2_1_s_inverted_"+a.getType(),t)),"brick_2_2_s_inverted"==F&&(u=new GLEGO.BuildObject("brick_2_2_s_inverted_"+a.getType(),t)),"1x3_flagpole"==F&&(u=new GLEGO.BuildObject("1x3_flagpole_"+a.getType(),t))):u=new GLEGO.BuildObject("brick_"+w+"_"+k+"_"+a.getType()+s,t);var s=LDF.LU.x*w/2,y=LDF.LU.z*k/2,x=L*LDF.LUF.y,z=LDF.LUF.y*v;3<v&&(z=3*LDF.LUF.y);g&&(z=0);pa?u.position.set(d.position.value[0],
d.position.value[1],d.position.value[2]):u.position.set(l*LDF.LU.x+s,x+z,m*LDF.LU.z+y);x=(L-h)*LDF.LUF.y;b.addObject(u);e.addObject(u);g?u.freeze():(u.position.y=u.position.value[1],(new TWEEN.Tween(u.position)).to({y:x},200).easing(TWEEN.Easing.Sinusoidal.EaseIn).onUpdate(function(){u.position.value[1]=u.position.y}).onComplete(function(){u.rotation.set(0,0,0);u.position.value[1]=x;u.freeze()}).start(),u.rotation.set(0.6*Math.random()-0.3,0,0.6*Math.random()-0.3),u.rotation.x=u.rotation.value[0],
u.rotation.z=u.rotation.value[2],(new TWEEN.Tween(u.rotation)).to({x:0,z:0},190).easing(TWEEN.Easing.Sinusoidal.EaseIn).onUpdate(function(){u.rotation.value[0]=u.rotation.x;u.rotation.value[2]=u.rotation.z}).start());g=!1;0==L&&(g=!0);f||Sound.playBrickSound(w,k,v,g);u.props={brickw:w,brickd:k,brickh:v,isSloped:C,rotation:K,isSpecial:H,specialType:F,color:t,id:q,gridPositionX:J,gridPositionY:L-h,gridPositionZ:W};p[q]=u;for(g=J;g<J+w;++g)for(l=W;l<W+k;++l)for(m=L-h;m<L-h+v;++m)V[m][g][l]=q;f||a.addUndo({type:"remove",
id:q});++q;ea+=a.getBrickValue(C,H);updateBrickCount(ea);console.log("brickCount: "+ea);!f&&(!r&&h<v)&&a.moveUp()}};a.moveUp=function(){d.position.value[1]=(L+v)*LDF.LUF.y+0.1;L+=v;x=(new Date).getTime()};a.checkBrickAbove=function(){for(var a=!1,b=J;b<J+w;++b)for(var c=W;c<W+k;++c)0!=V[L+v][b][c]&&(a=!0,b=c=1E3);return a};a.checkBrickBelow=function(){for(var a=0,b=L-1;0<=b;--b){for(var c=J;c<J+w;++c)for(var d=W;d<W+k;++d)try{0!=V[b][c][d]&&(a-=1,b=-1,c=d=1E3)}catch(e){b=-1,c=d=1E3}++a}return a};
a.checkOccupied=function(){var a=!1;if(84<L||84<L+v)return!0;for(var b=J;b<J+w;++b)for(var c=W;c<W+k;++c)for(var d=L;d<L+v;++d)try{0!=V[d][b][c]&&(a=!0,b=c=1E3)}catch(e){a=!0,b=c=1E3}return a};a.shootRay=function(b){var c=e.shoot(u.setFromMouse(R,Z,y));d.visible=b?!1:!0;1==ma&&(d.visible=!1);if(c.didHit){b=c.point;var f=c.normal,c=c.reference;B=!0;if(c==X||c==ba||0.5>f.value[1]){var g=Math.floor(b.value[0]/LDF.LU.x),h=Math.floor(b.value[2]/LDF.LU.z);g>16-w&&(g=16-w);h>16-k&&(h=16-k);-16>g&&(g=-16);
-16>h&&(h=-16);J=g+16;W=h+16;L=Math.floor(b.value[1]/LDF.LUF.y);if(c!=X&&c!=ba){b=c.props.brickh;var l=0;1<b&&(l=b*LDF.LUF.y-v);L=Math.floor((c.position.value[1]+l+0.1)/LDF.LUF.y);-1==f.value[0]&&(J-=w,g-=w);-1==f.value[2]&&(W-=k,h-=k)}0>L&&(L=0);0>J&&(J=0);0>W&&(W=0);d.position.set(g*LDF.LU.x+LDF.LU.x*w/2,L*LDF.LUF.y,h*LDF.LU.z+LDF.LU.z*k/2);P=null}else if(c!=X&&c!=ba&&0.95<f.value[1]){var f=c.props.brickw,g=c.props.brickd,h=c.props.rotation,m=l=0,q=0,r=0;c.props.isSloped&&(0==h&&(2==g&&(m=1,r=-1),
3==g&&(m=2,r=-2)),1==h&&(2==f&&(l=1,q=-1),3==f&&(l=2,q=-2)),2==h&&(2==g&&(r=m=1),3==g&&(r=m=2)),3==h&&(2==f&&(q=l=1),3==f&&(q=l=2)));ba.position.value[1]=b.value[1]+0.01;ba.position.value[0]=c.position.value[0]-(w-1+q)/2*LDF.LU.x;ba.position.value[2]=c.position.value[2]-(k-1+r)/2*LDF.LU.z;ba.scale.value[0]=f-l+w-1;ba.scale.value[2]=g-m+k-1;ba.lowerBound.set(-(f-l+w-1)*LDF.LU.x/2,0,-(g-m+k-1)*LDF.LU.z/2);ba.upperBound.set((f-l+w-1)*LDF.LU.x/2,0.01,(g-m+k-1)*LDF.LU.z/2);0==ma&&(P=null)}if(c!=X&&c!=
ba)try{P=c.props.id}catch(s){}c==X&&(ba.position.value[1]=1E4);if((J!=ka||W!=da)&&!ProKeys.keySpace&&1!=ma)a.checkOccupied()?a.setCursor("no"):a.setCursor("point");ka=J;da=W;if(1==ma){if(d.visible=!1,ba.position.value[1]=1E4,ProKeys.keySpace||a.setCursor("remove"),null!=P)try{var t=p[P];t.changeOpacity(0.85)}catch(x){}}else 1==d.opacity.value[0]&&d.changeOpacity(0.85);if(P!=O&&null!=O)try{t=p[O],"t"!=t.type.name.substr(t.type.name.length-1)?t.changeOpacity(1):t.changeOpacity(0.75)}catch(z){}O=P}else P=
null,1==ma&&p[O]&&(t=p[O],"t"!=t.type.name.substr(t.type.name.length-1)?t.changeOpacity(1):t.changeOpacity(0.75)),1!=d.opacity.value[0]&&d.changeOpacity(1),ba.position.value[1]=1E4,t=0,10>T.value[1]&&(t=Math.abs(T.value[1]-10)),ja.copy(u.direction),T.copy(ja.multiplyScalar(500).addSelf(y.matrix.position)),wa.copy(u.direction.multiplyScalar(500-4*t).addSelf(y.matrix.position)),B=!1,!N&&!ProKeys.keySpace&&a.setCursor("hand")};a.changeGhostBrick=function(){d&&(Oa=d.position,b.removeObject(d));var c=
w,e=k;if(1==K||3==K)e=w,c=k;var f=0.85;B||(f=1);C?d=new GLEGO.BuildObject("brick_"+c+"_"+e+"_s_r0",t,f):H?("window"==F&&(d=new GLEGO.BuildObject("brick_window_r0",t,f)),"door"==F&&(d=new GLEGO.BuildObject("brick_door_r0",t,f)),"1x1_round_open"==F&&(d=new GLEGO.BuildObject("1x1_round_open",t,f)),"1x1_round_straight"==F&&(d=new GLEGO.BuildObject("1x1_round_straight",t,f)),"1x1_round_withouttop"==F&&(d=new GLEGO.BuildObject("1x1_round_withouttop",t,f)),"1x4_antenna"==F&&(d=new GLEGO.BuildObject("1x4_antenna",
t,f)),"1x4_arc"==F&&(d=new GLEGO.BuildObject("1x4_arc_r0",t,f)),"1x4_fence"==F&&(d=new GLEGO.BuildObject("1x4_fence_r0",t,f)),"2x2x2_barrel"==F&&(d=new GLEGO.BuildObject("2x2x2_barrel",t,f)),"brick_2_1_s_inverted"==F&&(d=new GLEGO.BuildObject("brick_2_1_s_inverted_r0",t,f)),"brick_2_2_s_inverted"==F&&(d=new GLEGO.BuildObject("brick_2_2_s_inverted_r0",t,f)),"1x3_flagpole"==F&&(d=new GLEGO.BuildObject("1x3_flagpole_r0",t,f))):d=new GLEGO.BuildObject("brick_"+c+"_"+e+"_"+a.getType(),t,f);d.rotation.value[1]=
K*Math.PI/2;B?d.position=Oa:d.position.copy(wa);b.addObject(d);Ka&&a.showIcon()};a.setBrickColor=function(b,c){a.setMode(0);t=b;c||a.changeGhostBrick();a.colorChange.dispatch(t);var d=w,e=k;if(1==K||3==K)d=k,e=w;c||(a.updateBrickPreview(d,e,v,C,b),d="blue red orange yellow darkgreen green brown gray black white secret".split(" "),$("#original-bricks").css("backgroundPosition",-232*d.indexOf(t)+"px 0px"),$("#special-bricks").css("backgroundPosition",-204*d.indexOf(t)+"px 0px"),e=$('.colorpicker a[data-color="'+
t+'"]'),$(".colorpicker a").removeClass("active"),$(".btn-choose-color").removeClass("btn-choose-color-"+d.join(" btn-choose-color-")).addClass("btn-choose-color-"+t),e.addClass("active"))};a.updateBrickPreview=function(a,b,c,d,e){H&&(a=F,c=b=0);a=a+"_"+b+"_"+c+"_"+(d?"sloped_":"")+e+"_0";$("#current-piece img").attr("src","/"+window._version+"/img/build/bricks/"+a+".png")};a.setBrickSize=function(b,c,d,e,f){C=e||!1;H=!1;a.setMode(0);w=b;k=c;v=d;if(1==K||3==K)w=c,k=b;f||(a.changeGhostBrick(),a.updateBrickPreview(b,
c,d,C,t))};a.setSpecialBrick=function(b,c){F=b;C=!1;H=!0;a.setMode(0);"window"==b.toLowerCase()&&(w=2,k=4,v=9);"door"==b.toLowerCase()&&(w=2,k=4,v=15);"1x1_round_open"==b.toLowerCase()&&(k=w=1,v=3);"1x1_round_straight"==b.toLowerCase()&&(v=k=w=1);"1x1_round_withouttop"==b.toLowerCase()&&(k=w=1,v=3);"1x4_antenna"==b.toLowerCase()&&(k=w=1,v=12);"1x4_arc"==b.toLowerCase()&&(w=4,k=1,v=3);"1x4_fence"==b.toLowerCase()&&(w=4,k=1,v=3);"2x2x2_barrel"==b.toLowerCase()&&(k=w=2,v=6);"brick_2_1_s_inverted"==b.toLowerCase()&&
(w=2,k=1,v=9);"brick_2_2_s_inverted"==b.toLowerCase()&&(k=w=2,v=3);"1x3_flagpole"==b.toLowerCase()&&(w=1,k=3,v=12);var d=w,e=k;if(1==K||3==K)w=e,k=d;c||(a.changeGhostBrick(),a.updateBrickPreview(b,0,0,0,t))};a.rotateBrick=function(b){for($(".brickIco").hide();0==a.checkBrickBelow();)a.moveUp(),a.moveUp();var c=K;K+=b;0>K&&(K=3);3<K&&(K=0);b=w;w=k;k=b;ba.position.value[1]=1E4;0==c&&3==K&&(d.rotation.value[1]=4*Math.PI/2);3==c&&0==K&&(d.rotation.value[1]=-1*Math.PI/2);d.rotation.y=d.rotation.value[1];
(new TWEEN.Tween(d.rotation)).to({y:K*Math.PI/2},150).easing(TWEEN.Easing.Sinusoidal.EaseOut).onUpdate(function(){d.rotation.value[1]=d.rotation.y}).onComplete(function(){!H&&!C&&(K=c);a.changeGhostBrick()}).start();a.rotation.dispatch(K)};a.takeSnapShot=function(b){var c=h,d=45*Math.PI/180+Math.floor(c/(2*Math.PI))*2*Math.PI,c=180*c/Math.PI;180<(c+360)%360&&(h-=2*Math.PI);m=d;g=320;ha=0;a.setCameraFocus(0);Pa=b;setTimeout(a.initSnapShot,500)};a.initSnapShot=function(){var c=1+Math.floor(3*Math.random());
Sound.playStaticSound(Sound["camera_"+c],0.5);S.visible=!1;d.visible=!1;a.updateCamera(600);b.resize(262,262);b.render();c=b.getDomElement().toDataURL();h=m=135*Math.PI/180;a.updateCamera(600);b.render();var e=b.getDomElement().toDataURL();h=m=225*Math.PI/180;a.updateCamera(600);b.render();var f=b.getDomElement().toDataURL();h=m=315*Math.PI/180;a.updateCamera(600);b.render();var g=b.getDomElement().toDataURL();Pa([c,e,f,g]);b.resize(window.innerWidth-0,window.innerHeight-60);na=0;S.visible=!0;d.visible=
!0;h=m=45*Math.PI/180};a.setPredefinedRotation=function(b){var c=h,d=b*Math.PI/180+Math.floor(c/(2*Math.PI))*2*Math.PI,c=180*c/Math.PI,c=(c+360)%360;180>c&&315<=b&&(h+=2*Math.PI);180<c&&45>=b&&(h-=2*Math.PI);m=d;g=320;ha=0;a.setCameraFocus(0)};a.setRotation=function(a){m=h=a=a*Math.PI/180};a.updateCurrentAngle=function(){a.currentAngle=(180*m/Math.PI+360)%360;a.currentAngle!=a.oldAngle&&$(".rotate .controller img").css({"-webkit-transform":"rotate("+a.currentAngle+"deg)","-moz-transform":"rotate("+
a.currentAngle+"deg)"});a.oldAngle=a.currentAngle};a.setCameraFocus=function(a){$(".brickIco").hide();G=100*a};a.zoom=function(a){ha+=2*a;0>ha&&(ha=0);18<ha&&(ha=18)};a.setMode=function(a){ma=a;0==ma?($(".btn-remove").removeClass("active"),d&&(d.visible=!0)):($(".btn-remove").addClass("active"),d&&(d.visible=!1))};a.undo=function(){if(!(0>=ga.length)){var b=ga[0];"remove"==b.type&&(P=b.id,a.removeBrick(!0));if("add"==b.type){var c=K,d=w,e=k,f=v,g=t,h=C,l=H,m=F,p=ma,b=b.props;K=b.rotation;var q=b.brickw,
r=b.brickd;if(1==K||3==K)q=b.brickd,r=b.brickw;a.setBrickSize(q,r,b.brickh,b.isSloped,!0);a.setBrickColor(b.color,!0);J=b.gridPositionX;W=b.gridPositionZ;L=b.gridPositionY;H=b.isSpecial;F=b.specialType;a.setBrick(!0,!0);K=c;a.setBrickSize(d,e,f,h,!0);a.setBrickColor(g,!0);H=l;F=m;ma=p;a.setMode(ma)}ga.shift()}};a.addUndo=function(a){ga.unshift(a);10<ga.length&&ga.pop()};a.setCursor=function(a){a!=oa&&(document.getElementById("container").style.cursor=ra[a],oa=a)};a.render=function(){Ja=(new Date).getTime();
Ga=Ja-ca;ca=Ja;if(isNaN(Ga)||1E3<Ga||0==Ga)Ga=1E3/60;requestAnimationFrame(a.render);TWEEN.update();a.updateCamera();b.render()};a.updateCamera=function(b){if(N||N&&ProKeys.keySpace)m-=(f-I)/5E3,g+=(U-l)/5,200>g&&(g=200),600<g&&(g=600),a.shootRay();B?(d.rotation.value[2]=0,d.rotation.value[0]=0):(d.position.value[0]+=(wa.value[0]-d.position.value[0])/3,d.position.value[1]+=(wa.value[1]-d.position.value[1])/3,d.position.value[2]+=(wa.value[2]-d.position.value[2])/3,d.rotation.value[2]=I/window.innerWidth/
2,d.rotation.value[0]=l/window.innerHeight/2);ha+=la;0>ha&&(ha=0);25<ha&&(ha=25);na+=(ha-na)/6;GLOW.Matrix4.makeProjection(30-na,y.aspect,y.near,y.far,y.projection);h+=(m-h)/4;z+=(g-(z-G))/10;s.value[1]+=(G-s.value[1])/10;s.value[0]+=(0-s.value[0])/10;s.value[2]+=(0-s.value[2])/10;var c=800-g;b&&(c=b);y.matrix.setPosition(s.value[0]+Math.cos(h)*c,z,s.value[2]+Math.sin(h)*c);a.updateCurrentAngle();y.target.copy(s);y.matrix.lookAt(y.target,y.up)};a.onDocumentMouseMove=function(b){var d="";null!=b.target.firstChild&&
(d=b.target.firstChild.toString());if("[object HTMLCanvasElement]"==d){$(".brickIco").hide();b.preventDefault();b=c.relMouseCoords(b);var d=I,e=l;I=b.x-c.width/2;l=b.y-c.height/2;R=2*(b.x/c.width)-1;Z=2*(b.y/c.height)-1;200<(new Date).getTime()-x&&(I!=d||l!=e)&&a.shootRay()}};a.onDocumentMouseDown=function(b){var e="";null!=b.target.firstChild&&(e=b.target.firstChild.toString());"[object HTMLCanvasElement]"==e&&(b.preventDefault(),B&&!ProKeys.keySpace?2==b.button?(a.shootRay(),a.removeBrick(),d.visible=
!1):1==ma?(a.shootRay(),a.removeBrick()):a.setBrick():(b=c.relMouseCoords(b),f=b.x-c.width/2,U=b.y-c.height/2,a.setCursor("handdown"),N=!0))};a.onDocumentMouseUp=function(a){a.preventDefault();N=!1};a.onDocumentMouseWheel=function(a){var b=0;a.wheelDelta?b=a.wheelDelta/1E3:a.detail&&(b=-a.detail/20);ha+=10*b;0>ha&&(ha=0);18<ha&&(ha=18);a.preventDefault()};a.onWindowResize=function(a){b.resize(window.innerWidth-0,window.innerHeight-60)};a.getType=function(){var a="h";1==v&&(a="l");C&&(a="s_r"+K);H&&
(a="r"+K);return a};a.getBrickValue=function(a,b){var c=1;a&&(c=3);b&&(c=15);return c};a.autoPlaceBrick=function(){v1=w;v2=k;v3=v;v4=C;v5=t;v6=K;v7=ia;d.visible=!1;for(var b=Ha,c=Ha;c<facArr.length;c++)(function(c){setTimeout(function(){var b=facArr[c].split(",");a.setBrickColor(b[0],!0);var d="true"==b[2],e="true"==b[3];K=parseInt(b[1]);var f=parseInt(b[4]),g=parseInt(b[5]);if(1==K||3==K)f=[g,g=f][0];a.setBrickSize(f,g,parseInt(b[6]),d,!0);J=parseInt(b[7]);L=parseInt(b[8]);W=parseInt(b[9]);e?a.setSpecialBrick(b[10],
!0):ia=1>parseInt(b[11])?!0:!1;a.setBrick(!0,!0)},100*(c-b))})(c)};a.autoPlaceFinnish=function(){ia=v7;a.setBrickSize(v1,v2,v3,v4,!0);K=K=v6;a.setBrickColor(v5,!0)};a.getNextRow=function(){console.log("getNextRow");La++;Ha=facArr.length;var b=ArCollected.getRound(La);if("finished"==b[0].stat)a.autoPlaceFinnish(),a.addListeners();else{var c=b[0].arr.splice(0,1);parseInt(b[0].arr.splice(0,1));for(var d=0;d<b[0].arr.length;d++)facArr.push(b[0].arr[d]);"0"==c?(a.autoPlaceFinnish(),a.addListeners()):"1"==
c&&a.autoPlaceBrick()}};a.save=function(){if(1>ea)return!1;var a=GLEGO.DataFactory.encode(p,null,V),a={buildData:a.buildData,structure:a.structure};console.log("Saving build, access it on");console.log("/api/builds/"+A+"/data");$.post("/api/builds/"+A,a,function(a){},"json");return!0};a.loadUrl=function(){return"/api/builds/"+A+"/data"};a.getId=function(){return A};a.mapImageUrl=function(a,b){return"//maps.google.com/maps/api/staticmap?sensor=false&style=feature:all|element:labels|visibility:off&maptype=roadmap&scale=1&size=480x480&zoom=16&center="+
build_lat+","+build_lng};a.publish=function(a,b,c,d){$.post("/api/builds/"+A+"/publish",{email:a,defaultImage:c,category:b},function(a){"user_banned"==a.status?(a=$("<div>"),a.append("<h2>"+_("notifications_attention")+"</h2>"),a.append("<p>"+_("notifications_inappropriate_behavior_1")+"</p>"),a.append("<p>"+_("notifications_inappropriate_behavior_2")+"</p>"),a.append("<p>"+_("notifications_inappropriate_behavior_3")+"</p>"),new Popup({content:a,submitLabel:"Ok",hideCancel:!0})):d(A)},"json")};a.toggleTransparency=
function(a){(ia=a)?d.changeOpacity(0.5):d.changeOpacity(1)};a.hideBrickforDesign=function(){X.visible?(X.visible=!1,S.visible=!1,Q.visible=!1,aa.visible=!1):(X.visible=!0,S.visible=!0,Q.visible=!0,aa.visible=!0)};a.saveBuildingData=function(){window.webkitRequestFileSystem(window.TEMPORARY,1048576,function(a){a.root.getFile("legobuild_"+(new Date).getTime()+".bin",{create:!0},function(a){a.createWriter(function(b){var c=[];console.log(p);c.push("var facArr = [");var d="undefined";null!=p[1]&&(p[1].props.specialType&&
(d=p[1].props.specialType),1<p.length&&c.push('"'+p[1].props.color+","+p[1].props.rotation+","+p[1].props.isSloped+","+p[1].props.isSpecial+","+p[1].props.brickw+","+p[1].props.brickd+","+p[1].props.brickh+","+p[1].props.gridPositionX+","+p[1].props.gridPositionY+","+p[1].props.gridPositionZ+","+d+","+p[1].opacity.value[0]+'"'));for(d=2;d<p.length;d++)if(null!=p[d]){console.log(p[d].props.rotation);var e="undefined";p[d].props.specialType&&(e=p[d].props.specialType);c.push(',"'+p[d].props.color+","+
p[d].props.rotation+","+p[d].props.isSloped+","+p[d].props.isSpecial+","+p[d].props.brickw+","+p[d].props.brickd+","+p[d].props.brickh+","+p[d].props.gridPositionX+","+p[d].props.gridPositionY+","+p[d].props.gridPositionZ+","+e+","+p[d].opacity.value[0]+'"')}c.push("];");c=new Blob(c,{type:"text/plain"});b.addEventListener("writeend",function(){location.href=a.toURL()},!1);b.write(c)},function(){})},function(){})},function(){})};a.load=function(b){var c=K,d=w,e=k,f=v,g=t,h=C,l=H,m=F,p=new Image;p.onload=
function(){for(var b=GLEGO.DataFactory.decodeToBuild(p),k=0;k<b.length;++k){var n=b[k];if(!(void 0==n||null==n)){var q=n.type.name;K=0;-1!=q.indexOf("_r1")&&(K=1);-1!=q.indexOf("_r2")&&(K=2);-1!=q.indexOf("_r3")&&(K=3);var r=n.type.size.x,s=n.type.size.y,u=n.type.size.z;if(1==K||3==K)r=n.type.size.z,u=n.type.size.x;var t=!1;-1!=q.indexOf("_s_")&&(t=!0);a.setBrickSize(r,u,s,t,!0);-1!=q.indexOf("window")&&a.setSpecialBrick("window",!0);-1!=q.indexOf("door")&&a.setSpecialBrick("door",!0);-1!=q.indexOf("1x1_round_open")&&
a.setSpecialBrick("1x1_round_open",!0);-1!=q.indexOf("1x1_round_straight")&&a.setSpecialBrick("1x1_round_straight",!0);-1!=q.indexOf("1x1_round_withouttop")&&a.setSpecialBrick("1x1_round_withouttop",!0);-1!=q.indexOf("1x4_antenna")&&a.setSpecialBrick("1x4_antenna",!0);-1!=q.indexOf("1x4_arc")&&a.setSpecialBrick("1x4_arc",!0);-1!=q.indexOf("1x4_fence")&&a.setSpecialBrick("1x4_fence",!0);-1!=q.indexOf("2x2x2_barrel")&&a.setSpecialBrick("2x2x2_barrel",!0);-1!=q.indexOf("brick_2_1_s_inverted")&&a.setSpecialBrick("brick_2_1_s_inverted",
!0);-1!=q.indexOf("brick_2_2_s_inverted")&&a.setSpecialBrick("brick_2_2_s_inverted",!0);-1!=q.indexOf("1x3_flagpole")&&a.setSpecialBrick("1x3_flagpole",!0);a.setBrickColor(n.color.name,!0);var n=n.position,q=Math.floor(n.value[0]/LDF.LU.x),s=Math.floor(n.value[2]/LDF.LU.z),t=Math.floor(r/2),v=Math.floor(u/2);if(1==K||3==K)t=Math.floor(u/2),v=Math.floor(r/2);J=q+16-t;W=s+16-v;L=Math.round(n.value[1]/LDF.LUF.y);a.setBrick(!0,!0)}}Ka=!0;K=c;a.setBrickSize(d,e,f,h,!0);a.setBrickColor(g,!0);H=l;F=m;a.loadReady.dispatch()};
p.src=b;try{X.tween.stop(),S.tween.stop(),Q.tween.stop(),aa.tween.stop(),a.addListeners()}catch(q){}X.position.set(0,-1.3,0);S.position.set(0,-12,0);Q.position.set(11*LDF.LU.x,-6.3,16*LDF.LU.z);aa.position.set(13*LDF.LU.x,-6.3,16*LDF.LU.z)};return a}();
HTMLCanvasElement.prototype.relMouseCoords=function(a){var b=0,c=0,e=0,y=0,e=this;do b+=e.offsetLeft,c+=e.offsetTop;while(e=e.offsetParent);e=a.pageX-b;y=a.pageY-c;e=Math.round(e*(this.width/this.offsetWidth));y=Math.round(y*(this.height/this.offsetHeight));return{x:e,y:y}};var Sound=function(){var a={};if(void 0!=Audio){var b="ogg";(new Audio).canPlayType("audio/ogg")||(b="mp3");a.alert=new Howl({urls:["/assets/builder/sounds/alert."+b]});a.click=new Howl({urls:["/assets/builder/sounds/lightCLICKa."+b]});a.remove=new Howl({urls:["/assets/builder/sounds/remove_brick."+b]});a.swish=new Howl({urls:["/assets/builder/sounds/swish."+b]});a.camera_1=new Howl({urls:["/assets/builder/sounds/camera_1."+b]});a.camera_2=new Howl({urls:["/assets/builder/sounds/camera_2."+b]});a.camera_3=
new Howl({urls:["/assets/builder/sounds/camera_3."+b]});a.flat_join_1=new Howl({urls:["/assets/builder/sounds/flat_join_1."+b]});a.flat_join_2=new Howl({urls:["/assets/builder/sounds/flat_join_2."+b]});a.flat_join_3=new Howl({urls:["/assets/builder/sounds/flat_join_3."+b]});a.flat_plate_1=new Howl({urls:["/assets/builder/sounds/flat_plate_1."+b]});a.flat_plate_2=new Howl({urls:["/assets/builder/sounds/flat_plate_2."+b]});a.flat_plate_3=new Howl({urls:["/assets/builder/sounds/flat_plate_3."+b]});a.large_join_1=
new Howl({urls:["/assets/builder/sounds/large_join_1."+b]});a.large_join_2=new Howl({urls:["/assets/builder/sounds/large_join_2."+b]});a.large_join_3=new Howl({urls:["/assets/builder/sounds/large_join_3."+b]});a.large_plate_1=new Howl({urls:["/assets/builder/sounds/large_plate_1."+b]});a.large_plate_2=new Howl({urls:["/assets/builder/sounds/large_plate_2."+b]});a.large_plate_3=new Howl({urls:["/assets/builder/sounds/large_plate_3."+b]});a.medium_join_1=new Howl({urls:["/assets/builder/sounds/medium_join_1."+
b]});a.medium_join_2=new Howl({urls:["/assets/builder/sounds/medium_join_2."+b]});a.medium_join_3=new Howl({urls:["/assets/builder/sounds/medium_join_3."+b]});a.medium_plate_1=new Howl({urls:["/assets/builder/sounds/medium_plate_1."+b]});a.medium_plate_2=new Howl({urls:["/assets/builder/sounds/medium_plate_2."+b]});a.medium_plate_3=new Howl({urls:["/assets/builder/sounds/medium_plate_3."+b]});a.singlerow_join_1=new Howl({urls:["/assets/builder/sounds/singlerow_join_1."+b]});a.singlerow_join_2=new Howl({urls:["/assets/builder/sounds/singlerow_join_2."+
b]});a.singlerow_join_3=new Howl({urls:["/assets/builder/sounds/singlerow_join_3."+b]});a.singlerow_plate_1=new Howl({urls:["/assets/builder/sounds/singlerow_plate_1."+b]});a.singlerow_plate_2=new Howl({urls:["/assets/builder/sounds/singlerow_plate_2."+b]});a.singlerow_plate_3=new Howl({urls:["/assets/builder/sounds/singlerow_plate_3."+b]});a.clocktick_1=new Howl({urls:["/assets/academy/sounds/ClockTick_1."+b],loop:!0});a.clocktick_1_fast=new Howl({urls:["/assets/academy/sounds/ClockTick_1_fast."+
b],loop:!0});a.success_1=new Howl({urls:["/assets/academy/sounds/Success_1_r2."+b]})}a.playBrickSound=function(b,e,y,s){var m=0.5+0.5*Math.random();console.log("Play brick");var h="medium";if(1>=b||1>=e)h="singlerow";if(8<=b||8<=e)h="large";1>=y&&(h="flat");b=1+Math.floor(3*Math.random());e="join";s&&(e="plate");s=a[h+"_"+e+"_"+b];s.volume=m;s.play()};a.playStaticSound=function(a,b){a.volume=b?b:1;a.play()};a.stopStaticSound=function(a){a.stop()};return a}();
